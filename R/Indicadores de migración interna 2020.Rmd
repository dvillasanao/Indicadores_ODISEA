---
title: "Indicadores de migraci贸n interna"
subtitle: "Comparativo microdatos del censo y la muestra"
author: "CONAPO"
output:
  html_document:
    code_folding: hide
    highlight: tango
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
---
  
\usepackage{color}

```{=html}
<style>
  code.r{
    font-size: 12px;
 }
pre{
  font-size: 12px;
  background-color: #F8F3F8  ;
  font-family:"Verdana"; 
  font-weight: plain;
}
</style>
  
<style>
  body {
    text-align: justify;
    font-style: normal;
    font-family: "Verdana";
    font-size: 12px
  }
h1.title {
  font-size: 30px;
  font-family: "Verdana";
  color: #930C6D;
}
h1 {
  font-size: 30px;
  font-family: "Verdana";
  color: #9A1E77;
}
h2 {
  font-size: 24px;
  font-family: "Verdana";
  color: #172984;
}
h3 {
   font-size: 20px;
   font-family: "Verdana";
  color: #172984;
}
</style>
```

```{=html}
<style>
  .nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #710B6B;
  }
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    font-family: "Verdana";
    background-color: #BF5C9E;
}
</style>
```



```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                      eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   


```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```


```{r, echo = FALSE}
# Librer铆as que se usaron en el documCVE_ENTo
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 60)
```



**Cuestionario Ampliado del Censo de Poblaci贸n y Vivienda 2020**
  
El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
     file = paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))
```

Se seleccionan las variables que se desean conservar para la realizaci贸n de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

**Posibles variables que se pueden contemplar en la migraci贸n reciente**
  
-   `EDAD` \   
-   `SEXO` \  
-   `AFRODES`\   
-   `HLENGUA`\   
-   `QDIALECT_INALI`    
-   `PERTE_INDIGENA`\  
-   `NIVACAD`   
-   `ALFABET`   
-   `CAUSA_MIG`\   
-   `SITUA_CONYUGAL`\   
-   `CONACT`\  
-   `HIJOS_NAC_VIVOS`  

La variable `mydata` contiene **15 015 683 observaciones** y **12 variables**.

```{r, eval = FALSE}
load(paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))

mydata <- data %>%
  select(CVE_ENT, ENT, MUN, CVE_MUN, LOC50K, COBERTURA, CLAVIVP, NUMPER, ENT_PAIS_NAC,
         ENT_PAIS_RES_5A, MUN_RES_5A, CVE_MUN_RES15, EDAD, SEXO, AFRODES, 
         HLENGUA, QDIALECT_INALI, PERTE_INDIGENA, NIVACAD, ALFABET, ESCOLARI, ESCOACUM,
         CONACT, SITTRA, CAUSA_MIG, SITUA_CONYUGAL, CONACT, HIJOS_NAC_VIVOS, 
         FACTOR, ESTRATO, UPM)

save(mydata, file = paste0(here::here(), "/Bases/01_Migracion interna_2020.RData"))
```


锔A partir de aqu铆 se pueden correr los c贸didos .   
Se carga el archivo `Migracion interna_2020.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/01_Migracion interna_2020.RData"))

# Para fines pr谩cticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(CVE_ENT, ENT, MUN, CVE_MUN, LOC50K, COBERTURA, ENT_PAIS_NAC, ENT_PAIS_RES_5A, MUN_RES_5A, CVE_MUN_RES15, EDAD, COBERTURA, FACTOR, ESTRATO, UPM) %>%
           mutate(M = 1)  %>%
            mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
             ungroup()
```

**Claves de entidades y municipios**
  
  Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.\  
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines pr谩cticos.\      
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.      

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza",
                  "Colima", "Chiapas", "Chihuahua", "Ciudad de M茅xico", "Durango", 
                  "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",  "M茅xico", 
                  "Michoac谩n de Ocampo", "Morelos", "Nayarit", "Nuevo Le贸n", "Oaxaca", 
                  "Puebla", "Quer茅taro", "Quintana Roo", "San Luis Potos铆", "Sinaloa", 
                  "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala","Veracruz de Ignacio de la Llave", 
                  "Yucat谩n", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2020.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()

# Claves de los estados
ENT <- readRDS(file = paste0(here::here(), "/Bases/entidad_2020.RDS"))
```


**Poblaci贸n de 5 a帽os y m谩s**   
  
  Se identifica a la poblaci贸n de 5 a帽os y m谩s.   

`filter(EDAD >= 5 & EDAD != 999)'.`   

```{r}
Pob.5ymas <- muestra_2020 %>%
  as.data.frame() %>%
  mutate(EDAD = as.numeric(.$EDAD)) %>%
  subset(EDAD >= 5 & EDAD <= 130) %>%
  filter(ENT_PAIS_RES_5A %in% estados)  # Filtro del lugar de residencia dentro del pa铆s. 
```

```{r, echo = FALSE}
# Poblaci贸n de 5 a帽os y m谩s
tabla <- Pob.5ymas %>%
  summarise(Pob_5ymas = sum(.$FACTOR))
rm(Pob.5ymas)

as.integer(tabla) %>%  
  as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none"))) %>%
  gt() %>% 
  tab_header(title = "Poblaci贸n de 5 a帽os y m谩s") %>%
  tab_options(heading.title.font.size = 12, 
              heading.align = "center",
              heading.subtitle.font.size = 10,
              table.align = "center",
              column_labels.font.weight = "bold",
              table.font.names = 'montserrat',
              table.font.size = 8) %>%  
  as_raw_html()
```


# Nivel estatal {.tabset .tabset-pills}

## Poblaci贸n Total {.tabset .tabset-pills}

Estructura de la poblaci贸n por estado. Utilizando REDATAM.  

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Residencia_Habitual a nivel estatal_2020.xlsx" OVERWRITE
```
````

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(Pob.Total = 1,
                 M = 1) 

svy_design <- MC  %>%
               svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, 
                          #weights = ~FACTOR, 
                           nest = TRUE,
                            probs = ~probs)
```


**Poblaci贸n total** 

```{r}
## Poblaci贸n de total
Total_est <- svyby(~Pob.Total,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

## Poblaci贸n total en el estado 
est <- svyby(~Pob.Total,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.Total (Estados)")
writeData(wb, 1, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion Total (Estados).xlsx"), 
             overwrite = TRUE)
```

## Poblaci贸n 5 a帽os y m谩s {.tabset .tabset-pills}

Estructura de la poblaci贸n de 5 a帽os y m谩s. Utilizando REDATAM.  

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
FILTER EDAD > 4 AND EDAD <= 130
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Poblacion 5 a帽os y mas a nivel estatal_2020.xlsx" OVERWRITE
```
````

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD), 
                 M = 1) %>%
           mutate(Pob.5ymas = case_when(.$EDAD >= 5 & .$EDAD <= 130 ~ 1,
                                   TRUE ~  0)) 

svy_design <- MC  %>%
               svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, 
                         #weights = ~FACTOR, 
                          nest = TRUE,
                           probs = ~probs)
```


**Poblaci贸n de 5 a帽os y m谩s** 

```{r, class.source = "fold-hide"}
## Poblaci贸n de 5 a帽os y m谩s
Total_est <- svyby(~Pob.5ymas,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))


## Poblaci贸n de 5 a帽os y m谩s en el estado 
est <- svyby(~Pob.5ymas,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Se guardan los resultados** 

```{r}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.5ymas (Total)")
addWorksheet(wb, "Pob.5ymas (Estados)")
writeData(wb, 1, Total_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Pob.5ymas (Estados).xlsx"), 
             overwrite = TRUE)
```

## Migraci贸n nacimiento {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiaci贸n es tener controlados a los que nacieron en otro pa铆s o los no especificados. 

Estructura de la poblaci贸n total. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMNAC  (Divisi贸n Administrativa Mayor de Nacimiento)  */
DEFINE PERSONA.DAMNAC
	AS SWITCH
     INCASE PERSONA.ENT_PAIS_NAC > 32
     ASSIGN 0
     INCASE PERSONA.ENT_PAIS_NAC <= 32 
     ASSIGN PERSONA.ENT_PAIS_NAC
  NOTAPPLICABLE 0
  MISSING 1
  DEFAULT 0
	TYPE INTEGER
	RANGE (1:32)
  VARLABEL "Entidad de nacimiento"
	LIKE PERSONA.ENT_PAIS_NAC
SAVE "variables\DAMNAC.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAM-indicadores migraci贸n toda la vida
TABLE MB_NAC_DAM
FREQ DAMRES BY DAMNAC
FILTER DAMRES > 0 AND DAMNAC > 0
ZERO
TITLE "MATRIZ MIGRACIN TODA LA VIDA"
OUTPUTFILE JSON "MIGINT\MINT-MB-NAC-DAM.JSON" OVERWRITE
```
````

**Clasificaci贸n de las variables para el muestreo complejo**

```{r}
options(survey.lonely.psu = "adjust")

# Se almacena a la poblaci贸n total del lugar de residencia habitual a nivel estatal
POB_TOT <- mydata%>%
            group_by(CVE_ENT) %>%
             mutate(Pob.Total = sum(M * FACTOR)) %>%
              ungroup() %>%
               distinct(., CVE_ENT, Pob.Total) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_NAC, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD),
                 M = 1) %>%
           mutate(ENT_PAIS_NAC = case_when(.$ENT_PAIS_NAC %in% estados ~.$ENT_PAIS_NAC,
                                           .$ENT_PAIS_NAC %in% "997" ~ "997",
                                           .$ENT_PAIS_NAC %in% "998" ~ "998",
                                           .$ENT_PAIS_NAC %in% "999" ~ "999",
                                           .$ENT_PAIS_NAC %nin% estados ~ "888", #Residencia en otro pa铆s
                                           )) %>% 
            mutate(I_Nacimiento = case_when(.$CVE_ENT == .$ENT_PAIS_NAC ~ "1",
                                           .$CVE_ENT != .$ENT_PAIS_NAC & (.$ENT_PAIS_NAC %nin% c("888", "997", "998", "999")) ~ "2",
                                           .$ENT_PAIS_NAC == "888" ~ "888",
                                           .$ENT_PAIS_NAC == "997" ~ "997",
                                           .$ENT_PAIS_NAC == "998" ~ "998",
                                           .$ENT_PAIS_NAC == "999" ~ "999")) %>%
             # Se clasifica a la poblaci贸n residente de la migrante
             mutate(Residentes = case_when(I_Nacimiento %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when(I_Nacimiento %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la poblaci贸n total de acuerdo al lugar de residencia habitual y de nacimiento, para el calculo
             # de las tasas de emigaci贸n
              left_join(., POB_TOT %>% 
                            rename("Pob.Total_Estados" = "Pob.Total"), by = c("ENT_PAIS_NAC" = "CVE_ENT")) %>%
               group_by(ENT_PAIS_NAC) %>%
                mutate(Pob.Total.Nacimiento = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.Total_Estados / Pob.Total.Nacimiento)
   
```

### Muestreo Complejo (Opci贸n 1)


```{r, eval = FALSE}
require(survey)
svy_design <- MC  %>%
               svydesign(data = ., 
                          ids = ~UPM, 
                           strata = ~ESTRATO, 
                            probs = ~probs,
                             nest = TRUE)
```

**Poblaci贸n total**

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Indicadora de nacimiento)
Total_Residentes <- svyby(~Residentes,
                               by = ~M,
                                svy_design,
                                 svytotal,
                                  vartype = c("se","cv"),
                                   drop.empty.groups = TRUE) %>%
                          cbind(confint(object = ., level = 0.90))
Total_Residentes %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

Total_Inmigrantes <- svyby(~Migrantes,
                                by = ~M,
                                 svy_design,
                                  svytotal,
                                   vartype = c("se","cv"),
                                    drop.empty.groups = TRUE) %>%
                           cbind(confint(object = ., level = 0.90))

Total_Inmigrantes %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Inmigraci贸n**   

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Lugar de Nacimiento) en el estado
TI_Total <- svyby(~Migrantes,
                   denominator = ~M,
                    by = ~M,
                    svy_design,
                     svyratio,
                      vartype = c("se","cv"),
                       drop.empty.groups = TRUE) %>%
             cbind(confint(object = ., level = 0.90))
TI_Total %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Residentes por estado** 

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Lugar de Nacimiento) en el estado
residentes <- svyby(~Residentes,
                     by = ~CVE_ENT,
                      svy_design,
                       svytotal,
                        vartype = c("se","cv"),
                         drop.empty.groups = TRUE) %>%
               cbind(confint(object = ., level = 0.90))

residentes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Inmigrantes por estado** 

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Lugar de Nacimiento) en el estado
inmigrantes <- svyby(~Migrantes,
                       by = ~CVE_ENT,
                        svy_design,
                         svytotal,
                          vartype = c("se","cv"),
                           drop.empty.groups = TRUE) %>%
                 cbind(confint(object = ., level = 0.90))

inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Emigrantes por estado** 

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Lugar de Nacimiento) en el estado
emigrantes <- svyby(~Migrantes,
                     by = ~ENT_PAIS_NAC,
                      svy_design,
                       svytotal,
                        vartype = c("se","cv"),
                         drop.empty.groups = TRUE) %>%
               cbind(confint(object = ., level = 0.90))

emigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Inmigraci贸n por estado**   

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Lugar de Nacimiento) en el estado
TI_est <- svyby(~Migrantes,
                 denominator = ~M,
                  by = ~CVE_ENT,
                   svy_design,
                    svyratio,
                     vartype = c("se","cv"),
                      drop.empty.groups = TRUE) %>%
                cbind(confint(object = ., level = 0.90))
TI_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Emigraci贸n por estado**   

```{r, class.source = "fold-hide"}
## Poblaci贸n Total (Lugar de Nacimiento) en el estado
TE_est <- svyby(~Migrantes,
                 denominator = ~PPob,
                  by = ~ENT_PAIS_NAC,
                   svy_design,
                    svyratio,
                     vartype = c("se","cv"),
                      drop.empty.groups = TRUE) %>%
                cbind(confint(object = ., level = 0.90))
TE_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```


**Se guardan las base de datos**  

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Residentes (Total)")
addWorksheet(wb, "Migrantes (Total)")
addWorksheet(wb, "Residentes (Estados)")
addWorksheet(wb, "Inmigrantes (Estados)")
addWorksheet(wb, "Emigrantes (Estados)")
addWorksheet(wb, "T.Inmigrantes (Total)")
addWorksheet(wb, "T.Inmigrantes (Estados)")
addWorksheet(wb, "T.Emigrantes (Estados)")
writeData(wb, 1, Total_Residentes_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Total_Inmigrantes_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 3, residentes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 4, inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 5, emigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 6, TI_Total, colNames = TRUE, rowNames = TRUE)
writeData(wb, 7, TI_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 8, TE_est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados).xlsx"), 
             overwrite = TRUE)
rm(Total_Residentes, Total_Inmigrantes, residentes, inmigrantes, emigrantes, TI_Total, TI_est, TE_est)
```


### Muestreo Complejo (Opci贸n 2)

La paqueter铆a `srvyr` se centra en calcular estad铆sticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paqueter铆a `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluaci贸n no est谩ndar de rlang y tipos de retorno m谩s consistentes que el paquete de encuestas.   

```{r}
require(srvyr)
svy_design <- MC %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

**Inmigrantes** 

```{r, class.source = "fold-hide"}
Total_Inmigrantes <- svy_design %>%
                      dplyr::summarise(Poblacion_Total = survey_total(M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       Residentes = survey_total(Residentes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       Inmigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       TInmigracion = survey_ratio(numerator = Migrantes, denominator = M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE)) 

Total_Inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

inmigrantes <- svy_design %>%
                group_by(CVE_ENT) %>%
                 dplyr::summarise(Poblacion_Total = survey_total(M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(Residentes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = Migrantes, denominator = M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```



**Emigrantes** 

```{r, class.source = "fold-hide"}
Total_Emigrantes <- svy_design %>%
                     dplyr::summarise(Emigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                      TEmigracion = survey_ratio(numerator = Migrantes, denominator = PPob, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

emigrantes <- svy_design %>%
               group_by(ENT_PAIS_NAC) %>%
                dplyr::summarise(Emigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                 TEmigracion = survey_ratio(numerator = Migrantes, denominator = PPob, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

emigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Se guardan las base de datos**  

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Inmigrantes (Total)")
addWorksheet(wb, "Inmigrantes (Estados)")
addWorksheet(wb, "Emigrantes (Total)")
addWorksheet(wb, "Emigrantes (Estados)")
writeData(wb, 1, Total_Inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 3, Total_Emigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 4, emigrantes, colNames = TRUE, rowNames = TRUE)

saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados).xlsx"), 
             overwrite = TRUE)
```

### Muestreo Complejo (Opci贸n 3)

La paqueter铆a `srvyr` se centra en calcular estad铆sticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paqueter铆a `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluaci贸n no est谩ndar de rlang y tipos de retorno m谩s consistentes que el paquete de encuestas.   

```{r}
require(srvyr)
svy_design <- MC %>% 
               select(ESTRATO, UPM, probs, CVE_ENT, ENT_PAIS_NAC, M, Residentes, Migrantes, PPob) %>%
                reshape2::melt(., id.vars = c("ESTRATO", "UPM", "probs", "M", "Residentes", "Migrantes", "PPob")) %>%
                 srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```


**Indicadores de migraci贸n para toda la vida (Total)**

```{r, class.source = "fold-hide"}
Indicadores_Totales <- svy_design %>%
                        dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                                     denominator = ifelse(variable %in% "CVE_ENT", M, 0), 
                                                                     vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE), 
                                         TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0),
                                                                    denominator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, PPob, 0), 
                                                                    vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         MN = Inmigrantes - Emigrantes,
                                         MB = Inmigrantes + Emigrantes,
                                         TNM = TInmigracion - TEmigracion,
                                         TBM = TInmigracion + TEmigracion,
                                         Eficacia = MN - MB
                                         ) 
```


**Indicadores de migraci贸n para toda la vida (Estados)**

```{r, class.source = "fold-hide"}
Indicadores <- svy_design %>%
                group_by(value) %>%
                 dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                              denominator = ifelse(variable %in% "CVE_ENT", M, 0), 
                                                              vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0),
                                                             denominator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, PPob, 0), 
                                                             vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  MN = Inmigrantes - Emigrantes,
                                  MB = Inmigrantes + Emigrantes,
                                  TNM = TInmigracion - TEmigracion,
                                  TBM = TInmigracion + TEmigracion,
                                  Eficacia = MN - MB
                                  #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #ndice de Eficacia Migratoria
                                   ) 
```


**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Nacimiento (Total)")
addWorksheet(wb, "Lugar de Nacimiento (Estados)")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados)_Indicadores.xlsx"), 
             overwrite = TRUE)
```


## Migraci贸n reciente {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiaci贸n es tener controlados a los que nacieron en otro pa铆s o los no especificados. 

Estructura utilizando REDATAM.  

````
```{r}`r ''`
/*DAMRES5 (Divisi贸n Administrativa Mayor de residencia anterior) */
DEFINE PERSONA.DAMRES5
	AS RECODE PERSONA.ENT_PAIS_RES_5A
      (33: HIGHEST = 0)
  FILTER PERSONA.EDAD >= 5 AND PERSONA.EDAD <= 130
  NOTAPPLICABLE 0
  DEFAULT 0
	TYPE INTEGER
	RANGE (1:32)
  VARLABEL "Entidad de residencia hace 5 a帽os"
	LIKE PERSONA.ENT_PAIS_RES_5A
SAVE "variables\DAMRES5.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAME-Matriz migraci贸n Reciente	
TABLE MB_REC_DAME
		FREQ DAMERES BY DAMERES5
		FILTER EDAD > 4 AND DAMERES > 0 AND DAMERES5 > 0
		ZERO
		TITLE "MATRIZ MIGRACIN RECIENTE"
		OUTPUTFILE JSON "MIGINT\MINT-MB-REC-DAME.JSON" OVERWRITE
```
````


**Clasificaci贸n de las variables para el muestreo complejo**

```{r}
options(survey.lonely.psu = "adjust")

# Se almacena a la poblaci贸n de 5 a帽os y m谩s del lugar de residencia habitual a nivel estatal
Pob.5ymas <- mydata%>%
              filter(.$EDAD >= 5 & .$EDAD <= 130) %>%
               group_by(CVE_ENT) %>%
                mutate(Pob.5ymas = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  distinct(., CVE_ENT, Pob.5ymas) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_RES_5A, EDAD, M) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD)) %>%
           mutate(ENT_PAIS_RES_5A = case_when(nchar(.$ENT_PAIS_RES_5A) == 0 ~ NA,
                                              .$ENT_PAIS_RES_5A %in% estados ~.$ENT_PAIS_RES_5A,
                                              .$ENT_PAIS_RES_5A %in% "997" ~ "997",
                                              .$ENT_PAIS_RES_5A %in% "998" ~ "998",
                                              .$ENT_PAIS_RES_5A %in% "999" ~ "999",
                                              .$ENT_PAIS_RES_5A %nin% c(estados, "997", "998", "999") ~ "888" #Residencia en otro pa铆s
                                               )) %>% 
            mutate(I_Residencia = case_when(.$CVE_ENT == .$ENT_PAIS_RES_5A ~ "1",
                                            .$CVE_ENT != .$ENT_PAIS_RES_5A & (.$ENT_PAIS_RES_5A %nin% c("888", "997", "998", "999")) ~ "2",
                                            .$ENT_PAIS_RES_5A == "888" ~ "888",
                                            .$ENT_PAIS_RES_5A == "997" ~ "997",
                                            .$ENT_PAIS_RES_5A == "998" ~ "998",
                                            .$ENT_PAIS_RES_5A == "999" ~ "999")) %>%
             # Se clasifica a la poblaci贸n residente de la migrante
             mutate(Pob.5ymas = case_when((.$EDAD >= 5 & .$EDAD <= 130) ~ 1,
                                           TRUE ~ 0),
                    Residentes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la poblaci贸n total de acuerdo al lugar de residencia habitual y de nacimiento, para el calculo
             # de las tasas de emigaci贸n
              left_join(., Pob.5ymas %>% 
                            rename("Pob.5ymas_Estados" = "Pob.5ymas"), by = c("ENT_PAIS_RES_5A" = "CVE_ENT")) %>%
               group_by(ENT_PAIS_RES_5A) %>%
                mutate(Pob.Total.R5a = sum(Pob.5ymas * FACTOR)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.5ymas_Estados / Pob.Total.R5a)
```


### Muestreo Complejo (Opci贸n 3)

La paqueter铆a `srvyr` se centra en calcular estad铆sticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paqueter铆a `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluaci贸n no est谩ndar de rlang y tipos de retorno m谩s consistentes que el paquete de encuestas.   

```{r}
require(srvyr)
svy_design <- MC %>% 
               select(ESTRATO, UPM, probs, CVE_ENT, ENT_PAIS_RES_5A, M, Pob.5ymas, Residentes, Migrantes, PPob) %>%
                reshape2::melt(., id.vars = c("ESTRATO", "UPM", "probs", "M", "Pob.5ymas", "Residentes", "Migrantes", "PPob")) %>%
                 srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

**Indicadores de migraci贸n reciente hace 5 a帽os (Total)** 

```{r, class.source = "fold-hide"}
Indicadores_Totales <- svy_design %>%
                         dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Pob_5ymas = survey_total(ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                                      denominator = ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), 
                                                                      vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0),
                                                                     denominator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, PPob, 0), 
                                                                     vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          MN = Inmigrantes - Emigrantes,
                                          MB = Inmigrantes + Emigrantes,
                                          TNM = TInmigracion - TEmigracion,
                                          TBM = TInmigracion + TEmigracion,
                                          Eficacia = MN - MB
                                          #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #ndice de Eficacia Migratoria
                                           ) 
```

**Indicadores de migraci贸n reciente hace 5 a帽os (Estados)** 

```{r, class.source = "fold-hide"}
Indicadores <- svy_design %>%
                group_by(value) %>%
                 dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Pob_5ymas = survey_total(ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                              denominator = ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), 
                                                              vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0),
                                                             denominator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, PPob, 0), 
                                                             vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  MN = Inmigrantes - Emigrantes,
                                  MB = Inmigrantes + Emigrantes,
                                  TNM = TInmigracion - TEmigracion,
                                  TBM = TInmigracion + TEmigracion,
                                  Eficacia = MN - MB
                                  #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #ndice de Eficacia Migratoria
                                   ) 
```


**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Residencia (Totales")
addWorksheet(wb, "Lugar de Residencia (Estados")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de residencia (Estados)_Indicadores.xlsx"), 
             overwrite = TRUE)
```

# Nivel municipal {.tabset .tabset-pills}

## Poblaci贸n Total {.tabset .tabset-pills}

Estructura de la poblaci贸n por estado. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMERES (Divisi贸n Administrativa Menores de Residencia)*/
DEFINE PERSONA.DAMERES
	AS MUN.REDCODEN
	TYPE INTEGER
	RANGE (1001:32058)
  FILTER MUN.REDCODEN <> 4012 AND MUN.REDCODEN <> 7125 AND MUN.REDCODEN <> 29048
  VARLABEL "Municipio de residencia"
	LIKE MUN.REDCODEN
SAVE "variables\DAMERES.rbf"
OVERWRITE
GROUP MIGRACION
```
````

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_MUN) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(Pob.Total = 1) 

svy_design <- MC  %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```


**Poblaci贸n total** 

```{r, class.source = "fold-hide"}
## Poblaci贸n de total
Indicadores_Totales <- svy_design %>%
                        dplyr::summarise(Pob.Total = survey_total(Pob.Total, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

## Poblaci贸n total en los municipios
Indicadores <- svy_design %>%
                group_by(CVE_MUN) %>%
                 dplyr::summarise(Pob.Total = survey_total(Pob.Total, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

```

**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.Total (Total)")
addWorksheet(wb, "Pob.Total (Municipios)")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion Total (Municipios).xlsx"), 
             overwrite = TRUE)
```

## Poblaci贸n 5 a帽os y m谩s {.tabset .tabset-pills}

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_MUN, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD), 
                 M = 1) %>%
           mutate(Pob.5ymas = case_when(.$EDAD >= 5 & .$EDAD <= 130 ~ 1,
                                   TRUE ~  0)) 

svy_design <- MC  %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```


**Poblaci贸n 5 a帽os y m谩s** 

```{r, class.source = "fold-hide"}
## Poblaci贸n de total
Indicadores_Totales <- svy_design %>%
                        dplyr::summarise(Pob_5ymas = survey_total(Pob.5ymas, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

## Poblaci贸n total en los municipios
Indicadores <- svy_design %>%
                group_by(CVE_MUN) %>%
                 dplyr::summarise(Pob_5ymas = survey_total(Pob.5ymas, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))
```

**Se guardan los resultados**

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob_5ymas (Total)")
addWorksheet(wb, "Pob_5ymas (Municipios)")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion de 5 a帽os y m谩s (Municipios).xlsx"), 
             overwrite = TRUE)
```


## Migraci贸n reciente {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiaci贸n es tener controlados a los que nacieron en otro pa铆s o los no especificados. 

Estructura de la poblaci贸n migrante a nivel municipal. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMERES (Divisi贸n Administrativa Menores de Residencia)*/
DEFINE PERSONA.DAMERES
	AS MUN.REDCODEN
	TYPE INTEGER
	RANGE (1001:32058)
  FILTER MUN.REDCODEN <> 4012 AND MUN.REDCODEN <> 7125 AND MUN.REDCODEN <> 29048
  VARLABEL "Municipio de residencia"
	LIKE MUN.REDCODEN
SAVE "variables\DAMERES.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAME-Matriz migraci贸n Reciente	
TABLE MB_REC_DAME
		FREQ DAMERES BY DAMERES5
		FILTER EDAD > 4 AND DAMERES > 0 AND DAMERES5 > 0
		ZERO
		TITLE "MATRIZ MIGRACIN RECIENTE"
		OUTPUTFILE JSON "MIGINT\MINT-MB-REC-DAME.JSON" OVERWRITE
```
````

**Clasificaci贸n de las variables para el muestreo complejo**

```{r}
# Clave de los municipios 
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

municipios <- MUN %>% 
               filter(CVE_MUN %nin% municipios_nomuestra) %>%
                pull(CVE_MUN)

# Se almacena a la poblaci贸n de 5 a帽os y m谩s del lugar de residencia habitual a nivel municipal
Pob.5ymas <- mydata%>%
              filter((.$EDAD >= 5 & .$EDAD <= 130) & CVE_MUN %in% municipios) %>%
               group_by(CVE_MUN) %>%
                mutate(Pob.5ymas = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  distinct(., CVE_MUN, Pob.5ymas) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_MUN, MUN_RES_5A, ENT_PAIS_RES_5A, CVE_MUN_RES15, EDAD, M) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD)) %>%
           mutate(CVE_MUN = case_when(.$CVE_MUN %in% municipios ~ .$CVE_MUN,
                                      .$CVE_MUN %in% municipios_nomuestra ~ NA),
                  CVE_MUN_RES = case_when(nchar(.$CVE_MUN_RES15) == 0 ~ NA,
                                          .$CVE_MUN_RES15 %in% municipios ~.$CVE_MUN_RES15,
                                          #### Se excluyen los municipios que no fueron muestreados
                                          .$CVE_MUN_RES15 %in% municipios_nomuestra ~ "777",
                                          .$MUN_RES_5A %in% "999" ~ "996",
                                          .$CVE_MUN_RES15 %in% "997999" ~ '997999',
                                          .$ENT_PAIS_RES_5A %in% "997" ~ "997",
                                          .$ENT_PAIS_RES_5A %in% "998" ~ "998",
                                          .$ENT_PAIS_RES_5A %in% "999" ~ "999",
                                          nchar(.$CVE_MUN_RES15) == 3 ~ "888"  #Residencia en otro pa铆s
                                           ))  %>% 
            mutate(I_Residencia = case_when(.$CVE_MUN == .$CVE_MUN_RES ~ "1",
                                            .$CVE_MUN != .$CVE_MUN_RES & (.$CVE_MUN_RES %nin% c("777", "888", "996", "997", "998", "999", "997999")) ~ "2",
                                            .$CVE_MUN_RES == "777" ~ "777",
                                            .$CVE_MUN_RES == "888" ~ "888",
                                            .$CVE_MUN_RES == "996" ~ "996",
                                            .$CVE_MUN_RES == "997" ~ "997",
                                            .$CVE_MUN_RES == "998" ~ "998",
                                            .$CVE_MUN_RES == "999" ~ "999",
                                            .$CVE_MUN_RES == "997999" ~ "997999")) %>%
             # Se clasifica a la poblaci贸n residente de la migrante
             mutate(Pob.5ymas = case_when((.$EDAD >= 5 & .$EDAD <= 130) ~ 1,
                                           TRUE ~ 0),
                    Residentes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la poblaci贸n total de acuerdo al lugar de residencia habitual y de residencia hace 5 a帽os, para el calculo
             # de las tasas de emigaci贸n
              left_join(., Pob.5ymas %>% 
                            rename("Pob.5ymas_Municipios" = "Pob.5ymas"), by = c("CVE_MUN_RES" = "CVE_MUN")) %>%
               group_by(CVE_MUN_RES) %>%
                mutate(Pob.Total.R5a = sum(Pob.5ymas * FACTOR)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.5ymas_Municipios / Pob.Total.R5a)
```

### Muestreo Complejo (Opci贸n 3)

La paqueter铆a `srvyr` se centra en calcular estad铆sticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paqueter铆a `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluaci贸n no est谩ndar de rlang y tipos de retorno m谩s consistentes que el paquete de encuestas.   

```{r}
options(survey.lonely.psu = "adjust")

svy_design <- MC %>% 
               select(ESTRATO, UPM, probs, CVE_MUN, CVE_MUN_RES, M, Pob.5ymas, Residentes, Migrantes, PPob) %>%
                reshape2::melt(., id.vars = c("ESTRATO", "UPM", "probs", "M", "Pob.5ymas", "Residentes", "Migrantes", "PPob")) %>%
                 srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

```{r}
library(parallel)
require(dplyr)
# Configuraci贸n de cl煤ster
cl <- makeCluster(10)  # Ajusta el n煤mero de cl煤steres seg煤n tu m谩quina

# Exportar 'svy_design' a los cl煤steres
clusterExport(cl, c("svy_design"))

# Lista de variables sobre las cuales realizar c谩lculos en paralelo
variables_a_procesar <- c("Pob.Total", "Pob_5ymas", "Residentes", "Inmigrantes", "TInmigracion", "Emigrantes", "TEmigracion", "MN", "MB", "TNM", "TBM", "Eficacia")
```

**Indicadores de migraci贸n reciente hace 5 a帽os (Total)** 

```{r, class.source = "fold-hide"}
Indicadores_Totales <- svy_design %>%
                         dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_MUN" & nchar(value) > 0, M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Pob_5ymas = survey_total(ifelse(variable %in% "CVE_MUN" & nchar(value) > 0, Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Residentes = survey_total(ifelse(variable %in% "CVE_MUN" & nchar(value) > 0, Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Inmigrantes = survey_total(ifelse(variable %in% "CVE_MUN" & nchar(value) > 0, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN" & nchar(value) > 0, Migrantes, 0),
                                                                      denominator = ifelse(variable %in% "CVE_MUN" & nchar(value) > 0, Pob.5ymas, 0), 
                                                                      vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Emigrantes = survey_total(ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios & nchar(value) > 0, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TEmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios & nchar(value) > 0, Migrantes, 0),
                                                                     denominator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios & nchar(value) > 0, PPob, 0), 
                                                                     vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          MN = Inmigrantes - Emigrantes,
                                          MB = Inmigrantes + Emigrantes,
                                          TNM = TInmigracion - TEmigracion,
                                          TBM = TInmigracion + TEmigracion,
                                          Eficacia = MN - MB
                                          #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #ndice de Eficacia Migratoria
                                          ) 

Indicadores_Totales %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Indicadores de migraci贸n reciente hace 5 a帽os (Municipios)** 

```{r, class.source = "fold-hide"}
Indicadores <- svy_design %>%
                group_by(value) %>%
                 dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_MUN", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Pob_5ymas = survey_total(ifelse(variable %in% "CVE_MUN", Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(ifelse(variable %in% "CVE_MUN", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(ifelse(variable %in% "CVE_MUN", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN", Migrantes, 0),
                                                              denominator = ifelse(variable %in% "CVE_MUN", Pob.5ymas, 0), 
                                                              vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Emigrantes = survey_total(ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TEmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, Migrantes, 0),
                                                             denominator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, PPob, 0), 
                                                             vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                   MN = Inmigrantes - Emigrantes,
                                   MB = Inmigrantes + Emigrantes,
                                   TNM = TInmigracion - TEmigracion,
                                   TBM = TInmigracion + TEmigracion,
                                   Eficacia = MN - MB
                                   #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #ndice de Eficacia Migratoria
                                    ) 
```


**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Residencia (Totales")
addWorksheet(wb, "Lugar de Residencia (Estados")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de residencia (Municipios)_Indicadores.xlsx"), 
             overwrite = TRUE)
```

Se utiliza la paqueter铆a `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a la poblaci贸n de 5 a帽os y m谩s.


# Gr谩ficos  {.tabset .tabset-pills}

## Poblaci贸n total


```{r}
Pob.Total <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 1, skipEmptyCols = TRUE,
                       sheet = "Poblaci贸n Total (Entidad)") 
```


```{r}
tabla <- Pob.Total %>%
  arrange(Pob_Total_Muestra) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y = Pob_Total_Muestra, color = "LINE1")) +
  geom_ribbon(aes(ymin = Pob_Total_Muestra_low, ymax = Pob_Total_Muestra_upp), alpha = 0.2) + 
  geom_line(aes(y = Pob_Total_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  labs(title = "Poblaci贸n Total",
       y = "Poblaci贸n de Total",
       x = "Estados", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/Pob_Total a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```



```{r}
P.Nacimiento <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                          sheet = "Lugar de Nacimiento") 

P.Nacimiento <- P.Nacimiento %>%
  as.data.frame() %>%
  filter(NOM_ENT %nin% "Total")
names(P.Nacimiento)
```


## Residentes

```{r}
tabla <- P.Nacimiento %>%
  arrange(Residentes) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y = Residentes, color = "LINE1")) +
  geom_ribbon(aes(ymin = Residentes_low, ymax = Residentes_upp), alpha = 0.2) + 
  geom_line(aes(y = Residentes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_estados) + 
  labs(title = "Poblaci贸n Nacimiento",
       subtitle = "Residentes en el estado",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Residentes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


## Inmigrantes

```{r}
tabla <- P.Nacimiento %>%
  arrange(Inmigrantes) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y =Inmigrantes, color = "LINE1")) +
  geom_ribbon(aes(ymin = Inmigrantes_low, ymax = Inmigrantes_upp), alpha = 0.2) + 
  geom_line(aes(y = Inmigrantes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_estados) + 
  labs(title = "Poblaci贸n Nacimiento",
       subtitle = "Nacidos en otro estado (Inmigrantes)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Inmigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


## Emigrantes

```{r}
tabla <- P.Nacimiento %>%
  arrange(Emigrantes) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y = Emigrantes, color = "LINE1")) +
  geom_ribbon(aes(ymin = Emigrantes_low, ymax = Emigrantes_upp), alpha = 0.2) + 
  geom_line(aes(y = Emigrantes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_estados) + 
  labs(title = "Poblaci贸n Nacimiento",
       subtitle = "Nacidos en otro estado (Emigrantes)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Emigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


## Tasa de Inmigrantes

```{r}
T.MNac <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                    sheet = "T. MNac") 

T.MNac <- T.MNac %>%
  as.data.frame() %>%
  filter(NOM_ENT %nin% "Total")
names(T.MNac)
str(T.MNac)
```


```{r}
tabla <- T.MNac %>%
  arrange(Tasa_Inmigracion_Censo) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_text(aes(y = Tasa_Inmigracion, label = round(Tasa_Inmigracion, 1)), size = 2, vjust = -1.5) +
  geom_text(aes(y = Tasa_Inmigracion_Censo, label = round(Tasa_Inmigracion_Censo, 1)), size = 2, vjust = 1.5, color = "#808080") +
  geom_line(aes(y = Tasa_Inmigracion, color = "LINE1")) +
  geom_ribbon(aes(ymin = Tasa_Inmigracion_low, ymax = Tasa_Inmigracion_upp), alpha = 0.2) + 
  geom_line(aes(y = Tasa_Inmigracion_Censo, color = "LINE2")) +
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  #scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_ent) + 
  labs(title = "Tasa de Inmigraci贸n",
       subtitle = "Nacidos en otro estado (Inmigrantes)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Tasa de inmigracion) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```



# Poblaci贸n Municipal

```{r}
MRes5 <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                   sheet = "Lugar de residencia (Municipio)") 

MRes5 <- MRes5  %>%
  as.data.frame() %>%
  filter(NOM_MUN %nin% "Total")
names(MRes5)
```

**Poblaci贸n total** 

```{r}
## Poblaci贸n de total
Total_est <- svyby(~Pob.Total,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

## Poblaci贸n total en el estado 
est <- svyby(~Pob.Total,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.Total (Estados)")
writeData(wb, 1, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion Total (Estados).xlsx"), 
             overwrite = TRUE)
```
## Residentes

```{r}
tabla <- MRes5 %>%
  arrange(Inmigrantes_Muestra) %>%
  filter(MUN_Muestra %in% "Municipio muestreado") %>%
  droplevels() %>%
  slice(1:200) 

mun <- tabla %>% pull(CVE_MUN)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
  geom_line(aes(y = Inmigrantes_Muestra, color = "LINE1")) +
  geom_ribbon(aes(ymin = Inmigrantes_Muestra_low, ymax = Inmigrantes_Muestra_upp), alpha = 0.2) + 
  geom_line(aes(y = Inmigrantes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  #scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  # scale_x_discrete(limits = mun) + 
  labs(title = "Migraci贸n reciente 2015 - 2020",
       subtitle = "Inmigrantes (Residencia en otro estado)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Residentes) a nivel municipal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

