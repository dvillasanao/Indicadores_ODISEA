---
title: "Indicadores de migraci칩n interna"
subtitle: "Comparativo microdatos del censo y la muestra"
author: "CONAPO"
output:
  html_document:
  highlight: tango
theme: flatly
toc: yes
toc_depth: 2
toc_float:
  collapsed: yes
---
  
\usepackage{color}

```{=html}
<style>
  code.r{
    font-size: 10px;
 }
pre{
  font-size: 10px;
  background-color: #F8F3F8  ;
  font-family:"Verdana"; 
  font-weight: plain;
}
</style>
  
<style>
  body {
    text-align: justify;
    font-style: normal;
    font-family: "Verdana";
    font-size: 12px
  }
h1.title {
  font-size: 30px;
  font-family: "Verdana";
  color: #930C6D;
}
h1 {
  font-size: 30px;
  font-family: "Verdana";
  color: #9A1E77;
}
h2 {
  font-size: 24px;
  font-family: "Verdana";
  color: #172984;
}
h3 {
   font-size: 20px;
   font-family: "Verdana";
  color: #172984;
}
</style>
```

```{=html}
<style>
  .nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #710B6B;
  }
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    font-family: "Verdana";
    background-color: #BF5C9E;
}
</style>
```



```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                      eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   


```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```


```{r, echo = FALSE}
# Librer칤as que se usaron en el documCVE_ENTo
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggpubr)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 60)
```



**Cuestionario Ampliado del Censo de Poblaci칩n y Vivienda 2020**
  
  El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
     file = paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))
```

Se seleccionan las variables que se desean conservar para la realizaci칩n de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

**Posibles variables que se pueden contemplar en la migraci칩n reciente**
  
  -   `EDAD`   
-   `SEXO`  
-   `AFRODES`\   
-   `HLENGUA`\   
-   `QDIALECT_INALI`    
-   `PERTE_INDIGENA`\  
-   `NIVACAD`   
-   `ALFABET`   
-   `CAUSA_MIG`\   
-   `SITUA_CONYUGAL`\   
-   `CONACT`\  
-   `HIJOS_NAC_VIVOS`  

La variable `mydata` contiene **15 015 683 observaciones** y **12 variables**.

```{r, eval = FALSE}
load(paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))

mydata <- data %>%
  select(CVE_ENT, ENT, MUN, CVE_MUN, LOC50K, COBERTURA, CLAVIVP, NUMPER, ENT_PAIS_NAC,
         ENT_PAIS_RES_5A, MUN_RES_5A, CVE_MUN_RES15, EDAD, SEXO, AFRODES, 
         HLENGUA, QDIALECT_INALI, PERTE_INDIGENA, NIVACAD, ALFABET, ESCOLARI, ESCOACUM,
         CONACT, SITTRA, CAUSA_MIG, SITUA_CONYUGAL, CONACT, HIJOS_NAC_VIVOS, 
         FACTOR, ESTRATO, UPM)

save(mydata, file = paste0(here::here(), "/Bases/01_Migracion interna_2020.RData"))
```


九덢잺A partir de aqu칤 se pueden correr los c칩didos 游녢.   
Se carga el archivo `Migracion interna_2020.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/01_Migracion interna_2020.RData"))

# Para fines pr치cticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(CVE_ENT, ENT, MUN, CVE_MUN, LOC50K, COBERTURA, ENT_PAIS_NAC, ENT_PAIS_RES_5A, MUN_RES_5A, CVE_MUN_RES15, EDAD, COBERTURA, FACTOR, ESTRATO, UPM) %>%
           mutate(M = 1)  %>%
            mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
             ungroup()
```

**Claves de entidades y municipios**
  
  Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.\  
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines pr치cticos.\      
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.      

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza",
                  "Colima", "Chiapas", "Chihuahua", "Ciudad de M칠xico", "Durango", 
                  "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",  "M칠xico", 
                  "Michoac치n de Ocampo", "Morelos", "Nayarit", "Nuevo Le칩n", "Oaxaca", 
                  "Puebla", "Quer칠taro", "Quintana Roo", "San Luis Potos칤", "Sinaloa", 
                  "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala","Veracruz de Ignacio de la Llave", 
                  "Yucat치n", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2020.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()

# Claves de los estados
ENT <- readRDS(file = paste0(here::here(), "/Bases/entidad_2020.RDS"))
```


**Poblaci칩n de 5 a침os y m치s**   
  
  Se identifica a la poblaci칩n de 5 a침os y m치s.   

`filter(EDAD >= 5 & EDAD != 999)'.`   

```{r}
Pob.5ymas <- muestra_2020 %>%
  as.data.frame() %>%
  mutate(EDAD = as.numeric(.$EDAD)) %>%
  subset(EDAD >= 5 & EDAD <= 130) %>%
  filter(ENT_PAIS_RES_5A %in% estados)  # Filtro del lugar de residencia dentro del pa칤s. 
```

```{r, echo = FALSE}
# Poblaci칩n de 5 a침os y m치s
tabla <- Pob.5ymas %>%
  summarise(Pob_5ymas = sum(.$FACTOR))
rm(Pob.5ymas)

as.integer(tabla) %>%  
  as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none"))) %>%
  gt() %>% 
  tab_header(title = "Poblaci칩n de 5 a침os y m치s") %>%
  tab_options(heading.title.font.size = 12, 
              heading.align = "center",
              heading.subtitle.font.size = 10,
              table.align = "center",
              column_labels.font.weight = "bold",
              table.font.names = 'montserrat',
              table.font.size = 8) %>%  
  as_raw_html()
```


# Nivel estatal {.tabset .tabset-pills}

## Poblaci칩n Total {.tabset .tabset-pills}

Estructura de la poblaci칩n por estado. Utilizando REDATAM.  

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Residencia_Habitual a nivel estatal_2020.xlsx" OVERWRITE
```
````

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(Pob.Total = 1,
                 M = 1) 

svy_design <- MC  %>%
               svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, 
                          #weights = ~FACTOR, 
                           nest = TRUE,
                            probs = ~probs)

## Poblaci칩n de total
Total_est <- svyby(~Pob.Total,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

## Poblaci칩n total en el estado 
est <- svyby(~Pob.Total,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.Total (Estados)")
writeData(wb, 1, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion Total (Estados).xlsx"), 
             overwrite = TRUE)
```

## Poblaci칩n 5 a침os y m치s {.tabset .tabset-pills}

Estructura de la poblaci칩n de 5 a침os y m치s. Utilizando REDATAM.  

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
FILTER EDAD > 4 AND EDAD <= 130
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Poblacion 5 a침os y mas a nivel estatal_2020.xlsx" OVERWRITE
```
````

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD), 
                 M = 1) %>%
           mutate(Pob.5ymas = case_when(.$EDAD >= 5 & .$EDAD <= 130 ~ 1,
                                   TRUE ~  0)) 

svy_design <- MC  %>%
               svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, 
                         #weights = ~FACTOR, 
                          nest = TRUE,
                           probs = ~probs)

## Poblaci칩n de 5 a침os y m치s
Total_est <- svyby(~Pob.5ymas,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))


## Poblaci칩n de 5 a침os y m치s en el estado 
est <- svyby(~Pob.5ymas,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.5ymas (Total)")
addWorksheet(wb, "Pob.5ymas (Estados)")
writeData(wb, 1, Total_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Pob.5ymas (Estados).xlsx"), 
             overwrite = TRUE)
```

## Migraci칩n nacimiento {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiaci칩n es tener controlados a los que nacieron en otro pa칤s o los no especificados. 

Estructura de la poblaci칩n total. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMNAC  (Divisi칩n Administrativa Mayor de Nacimiento)  */
DEFINE PERSONA.DAMNAC
	AS SWITCH
     INCASE PERSONA.ENT_PAIS_NAC > 32
     ASSIGN 0
     INCASE PERSONA.ENT_PAIS_NAC <= 32 
     ASSIGN PERSONA.ENT_PAIS_NAC
  NOTAPPLICABLE 0
  MISSING 1
  DEFAULT 0
	TYPE INTEGER
	RANGE (1:32)
  VARLABEL "Entidad de nacimiento"
	LIKE PERSONA.ENT_PAIS_NAC
SAVE "variables\DAMNAC.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAM-indicadores migraci칩n toda la vida
TABLE MB_NAC_DAM
FREQ DAMRES BY DAMNAC
FILTER DAMRES > 0 AND DAMNAC > 0
ZERO
TITLE "MATRIZ MIGRACI칍N TODA LA VIDA"
OUTPUTFILE JSON "MIGINT\MINT-MB-NAC-DAM.JSON" OVERWRITE
```
````

**Clasificaci칩n de las variables para el muestreo complejo**

```{r}
options(survey.lonely.psu = "adjust")

# Se almacena a la poblaci칩n total del lugar de residencia habitual a nivel estatal
POB_TOT <- mydata%>%
            group_by(CVE_ENT) %>%
             mutate(Pob.Total = sum(M * FACTOR)) %>%
              ungroup() %>%
               distinct(., CVE_ENT, Pob.Total) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_NAC, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD),
                 M = 1) %>%
           mutate(ENT_PAIS_NAC = case_when(.$ENT_PAIS_NAC %in% estados ~.$ENT_PAIS_NAC,
                                           .$ENT_PAIS_NAC %in% "997" ~ "997",
                                           .$ENT_PAIS_NAC %in% "998" ~ "998",
                                           .$ENT_PAIS_NAC %in% "999" ~ "999",
                                           .$ENT_PAIS_NAC %nin% estados ~ "888", #Residencia en otro pa칤s
                                           )) %>% 
            mutate(I_Nacimiento = case_when(.$CVE_ENT == .$ENT_PAIS_NAC ~ "1",
                                           .$CVE_ENT != .$ENT_PAIS_NAC & (.$ENT_PAIS_NAC %nin% c("888", "997", "998", "999")) ~ "2",
                                           .$ENT_PAIS_NAC == "888" ~ "888",
                                           .$ENT_PAIS_NAC == "997" ~ "997",
                                           .$ENT_PAIS_NAC == "998" ~ "998",
                                           .$ENT_PAIS_NAC == "999" ~ "999")) %>%
             # Se clasifica a la poblaci칩n residente de la migrante
             mutate(Residentes = case_when(I_Nacimiento %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when(I_Nacimiento %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la poblaci칩n total de acuerdo al lugar de residencia habitual y de nacimiento, para el calculo
             # de las tasas de emigaci칩n
              left_join(., POB_TOT %>% 
                            rename("Pob.Total_Estados" = "Pob.Total"), by = c("ENT_PAIS_NAC" = "CVE_ENT")) %>%
               group_by(ENT_PAIS_NAC) %>%
                mutate(Pob.Total.Nacimiento = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.Total_Estados / Pob.Total.Nacimiento)
   
             
```

### Muestreo Complejo (Opci칩n 1)


```{r, eval = FALSE}
svy_design <- MC  %>%
               svydesign(data = ., 
                          ids = ~UPM, 
                           strata = ~ESTRATO, 
                            probs = ~probs,
                             nest = TRUE)
```

**Poblaci칩n total**

```{r}
## Poblaci칩n Total (Indicadora de nacimiento)
Total_Residentes <- svyby(~Residentes,
                               by = ~M,
                                svy_design,
                                 svytotal,
                                  vartype = c("se","cv"),
                                   drop.empty.groups = TRUE) %>%
                          cbind(confint(object = ., level = 0.90))
Total_Residentes %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

Total_Inmigrantes <- svyby(~Migrantes,
                                by = ~M,
                                 svy_design,
                                  svytotal,
                                   vartype = c("se","cv"),
                                    drop.empty.groups = TRUE) %>%
                           cbind(confint(object = ., level = 0.90))

Total_Inmigrantes %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Inmigraci칩n**   

```{r}
## Poblaci칩n Total (Lugar de Nacimiento) en el estado
TI_Total <- svyby(~Migrantes,
                   denominator = ~M,
                    by = ~M,
                    svy_design,
                     svyratio,
                      vartype = c("se","cv"),
                       drop.empty.groups = TRUE) %>%
             cbind(confint(object = ., level = 0.90))
TI_Total %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Residentes por estado** 

```{r}
## Poblaci칩n Total (Lugar de Nacimiento) en el estado
residentes <- svyby(~Residentes,
                     by = ~CVE_ENT,
                      svy_design,
                       svytotal,
                        vartype = c("se","cv"),
                         drop.empty.groups = TRUE) %>%
               cbind(confint(object = ., level = 0.90))

residentes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Inmigrantes por estado** 

```{r}
## Poblaci칩n Total (Lugar de Nacimiento) en el estado
inmigrantes <- svyby(~Migrantes,
                       by = ~CVE_ENT,
                        svy_design,
                         svytotal,
                          vartype = c("se","cv"),
                           drop.empty.groups = TRUE) %>%
                 cbind(confint(object = ., level = 0.90))

inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Emigrantes por estado** 

```{r}
## Poblaci칩n Total (Lugar de Nacimiento) en el estado
emigrantes <- svyby(~Migrantes,
                     by = ~ENT_PAIS_NAC,
                      svy_design,
                       svytotal,
                        vartype = c("se","cv"),
                         drop.empty.groups = TRUE) %>%
               cbind(confint(object = ., level = 0.90))

emigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Inmigraci칩n por estado**   

```{r}
## Poblaci칩n Total (Lugar de Nacimiento) en el estado
TI_est <- svyby(~Migrantes,
                 denominator = ~M,
                  by = ~CVE_ENT,
                   svy_design,
                    svyratio,
                     vartype = c("se","cv"),
                      drop.empty.groups = TRUE) %>%
                cbind(confint(object = ., level = 0.90))
TI_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Emigraci칩n por estado**   

```{r}
## Poblaci칩n Total (Lugar de Nacimiento) en el estado
TE_est <- svyby(~Migrantes,
                 denominator = ~PPob,
                  by = ~ENT_PAIS_NAC,
                   svy_design,
                    svyratio,
                     vartype = c("se","cv"),
                      drop.empty.groups = TRUE) %>%
                cbind(confint(object = ., level = 0.90))
TE_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```


**Se guardan las base de datos**  

```{r}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Residentes (Total)")
addWorksheet(wb, "Migrantes (Total)")
addWorksheet(wb, "Residentes (Estados)")
addWorksheet(wb, "Inmigrantes (Estados)")
addWorksheet(wb, "Emigrantes (Estados)")
addWorksheet(wb, "T.Inmigrantes (Total)")
addWorksheet(wb, "T.Inmigrantes (Estados)")
addWorksheet(wb, "T.Emigrantes (Estados)")
writeData(wb, 1, Total_Residentes_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Total_Inmigrantes_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 3, residentes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 4, inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 5, emigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 6, TI_Total, colNames = TRUE, rowNames = TRUE)
writeData(wb, 7, TI_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 8, TE_est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados).xlsx"), 
             overwrite = TRUE)
```


### Muestreo Complejo (Opci칩n 2)

```{r}
require(srvyr)

svy_design <- MC %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

**Inmigrantes** 

```{r}
Total_Inmigrantes <- svy_design %>%
                      dplyr::summarise(Poblacion_Total = survey_total(M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       Residentes = survey_total(Residentes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       Inmigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       TInmigracion = survey_ratio(numerator = Migrantes, denominator = M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE)) 

Total_Inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

inmigrantes <- svy_design %>%
                group_by(CVE_ENT) %>%
                 dplyr::summarise(Poblacion_Total = survey_total(M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(Residentes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = Migrantes, denominator = M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Emigrantes** 

```{r}
Total_Emigrantes <- svy_design %>%
                     dplyr::summarise(Emigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                      TEmigracion = survey_ratio(numerator = Migrantes, denominator = PPob, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

emigrantes <- svy_design %>%
               group_by(ENT_PAIS_NAC) %>%
                dplyr::summarise(Emigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                 TEmigracion = survey_ratio(numerator = Migrantes, denominator = PPob, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

emigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

# Nivel municipal {.tabset .tabset-pills}

## Poblaci칩n Total {.tabset .tabset-pills}

## Poblaci칩n 5 a침os y m치s {.tabset .tabset-pills}

## Migraci칩n reciente {.tabset .tabset-pills}

### Muestreo Complejo (Opci칩n 1)


```{r, eval = FALSE}
require(srvyr)
options(survey.lonely.psu="adjust")

MC <- muestra_2020 %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_RES_5A, EDAD) %>%
         mutate(EDAD = as.numeric(.$EDAD)) %>%
      mutate(ENT_PAIS_RES_5A = case_when(.$ENT_PAIS_RES_5A %in% estados ~.$ENT_PAIS_RES_5A,
                                         .$ENT_PAIS_RES_5A %nin% estados ~ "888", #Residencia en otro pa칤s
                                         .$ENT_PAIS_RES_5A %in% "997" ~ "997",
                                         .$ENT_PAIS_RES_5A %in% "998" ~ "998",
                                         .$ENT_PAIS_RES_5A %in% "997" ~ "999")) %>% 
      mutate(I_RES_5A = case_when((.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% estados ~ .$ENT_PAIS_RES_5A,
                                  (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "888" ~ "888",
                                  (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "997" ~ "997",
                                  (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "998" ~ "998",
                                  (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "999" ~ "999")) %>%
      mutate(M = 1) 

svy_design <- MC  %>%
  svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, #weights = ~FACTOR, 
            nest = TRUE, probs = probs)
#clusterExport(cl, c("MC"))
#svy_design <- parLapply(cl, 1:length(cl), function(i) {
# svydesign(data = MC[i:nrow(MC), ], ids = ~UPM, strata = ~ESTRATO, weights = ~FACTOR, nest = TRUE)
#})
probs <- svy_design$prob
svy_design <- MC  %>%
  svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, #weights = ~FACTOR, 
            nest = TRUE, probs = probs)

#p <- as.svrepdesign(svy_design, type="bootstrap", replicates=100)

#options("survey.ultimate.cluster" = FALSE)
#p <- as.svrepdesign(svy_design)

require(survey)
tabla <- svytotal(~M + CVE_ENT, svy_design)

library(fastsurvey)
fastsurvey::svytotal(~M,
                     multistage_design)

p <- MC  %>%
  svrepdesign(data = mydata, ids = ~UPM, strata = ~ESTRATO, weights = ~FACTOR, nest = TRUE) 
POB_TOT_est <- svytotal(~M,
                        MC)
## Poblaci칩n total en el estado 
POB_TOT_est <- svyby(~M,
                     by = ~CVE_ENT,
                     svy_design,
                     svytotal,
                     vartype = c("se","cv", "ci"),
                     level = 0.90
                     #drop.empty.groups = TRUE 
                     #na.rm.by = TRUE, 
                     #multicore=getOption("survey.multicore")
) #desvest / %CV / Coef. de variaci칩n

confint(POB_TOT_est, level = 0.90, df =Inf)
```


#### Muestreo Complejo (Opci칩n 2)

```{r}
MC <- muestra_2020 %>%
  as.data.frame() %>%
  select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_RES_5A, EDAD) %>%
  mutate(EDAD = as.numeric(.$EDAD)) %>%
  mutate(ENT_PAIS_RES_5A = case_when(.$ENT_PAIS_RES_5A %in% estados ~.$ENT_PAIS_RES_5A,
                                     .$ENT_PAIS_RES_5A %nin% estados ~ "888", #Residencia en otro pa칤s
                                     .$ENT_PAIS_RES_5A %in% "997" ~ "997",
                                     .$ENT_PAIS_RES_5A %in% "998" ~ "998",
                                     .$ENT_PAIS_RES_5A %in% "997" ~ "999")) %>% 
  mutate(I_RES_5A = case_when((.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% estados ~ .$ENT_PAIS_RES_5A,
                              (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "888" ~ "888",
                              (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "997" ~ "997",
                              (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "998" ~ "998",
                              (.$EDAD >= 5 & .$EDAD <= 130) & ENT_PAIS_RES_5A %in% "999" ~ "999")) %>%
  mutate(CVE_ENTS = case_when(.$ENT_PAIS_RES_5A %in% estados ~.$ENT_PAIS_RES_5A)) %>%
  mutate(M = 1) %>%
  mutate(RESHAB = 1,
         RESREC = case_when(EDAD >= 5 & EDAD <= 130 ~ 1,
                            TRUE ~ NA),
         MIG = case_when(.$CVE_ENT !=.$ENT_PAIS_RES_5A  & (EDAD >= 5 & EDAD <= 130) ~ 1,
                         TRUE ~ NA),
         NOMIGRA = case_when(.$CVE_ENT ==.$ENT_PAIS_RES_5A & (EDAD >= 5 & EDAD <= 130) ~ 1,
                             TRUE ~ NA)) 
MC <- MC %>%
  as.data.frame() %>%
  select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_RES_5A, RESHAB, RESREC,  MIG, NOMIGRA) %>%
  melt(., id = c("UPM", "ESTRATO", "FACTOR", "RESHAB", "RESREC", "MIG", "NOMIGRA")) %>%
  srvyr::as_survey_design(ids = UPM, strata = ESTRATO, weights = FACTOR, nest = TRUE)


p <- MC %>%
  group_by(value) %>%
  dplyr::summarise(RESHAB = survey_total(ifelse(variable == "CVE_ENT", RESHAB, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                   RESREC = survey_total(ifelse(variable == "CVE_ENT", RESREC, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                   INMIG = survey_total(ifelse(variable == "CVE_ENT", MIG, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE), 
                   EMIG = survey_total(ifelse(variable == "CVE_ENT5" & value %in% estados, MIG, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(MIGNETA = INMIG - EMIG, 
         MIGBRUTA = INMIG + EMIG,
         TASAINMI = ((INMIG/ 5) /((RESHAB + RESREC) / 2))*1000,
         TASAEMI = ((EMIG/ 5) /((RESHAB + RESREC) / 2))*1000, 
         TASAMIG = TASAINMI - TASAEMI,
         EFICACIA = MIGNETA - MIGBRUTA) 
```



Se utiliza la paqueter칤a `survey` para poder trabajar con la muestra del cuestionario ampliado, en la cual se selecciona a la poblaci칩n de 5 a침os y m치s.

### Muestreo Complejo (Opci칩n 1)

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
FILTER EDAD > 4 AND EDAD <= 130
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Residencia_Habitual_2020.xlsx" OVERWRITE
```
````

# Poblaci칩n Total

```{r}
Pob.Total <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 1, skipEmptyCols = TRUE,
                       sheet = "Poblaci칩n Total (Entidad)") 
```


```{r}
tabla <- Pob.Total %>%
  arrange(Pob_Total_Muestra) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y = Pob_Total_Muestra, color = "LINE1")) +
  geom_ribbon(aes(ymin = Pob_Total_Muestra_low, ymax = Pob_Total_Muestra_upp), alpha = 0.2) + 
  geom_line(aes(y = Pob_Total_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  labs(title = "Poblaci칩n Total",
       y = "Poblaci칩n de Total",
       x = "Estados", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/Pob_Total a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


# Poblaci칩n Total

```{r}
P.Nacimiento <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                          sheet = "Lugar de Nacimiento") 

P.Nacimiento <- P.Nacimiento %>%
  as.data.frame() %>%
  filter(NOM_ENT %nin% "Total")
names(P.Nacimiento)
```


## Residentes

```{r}
tabla <- P.Nacimiento %>%
  arrange(Residentes) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y = Residentes, color = "LINE1")) +
  geom_ribbon(aes(ymin = Residentes_low, ymax = Residentes_upp), alpha = 0.2) + 
  geom_line(aes(y = Residentes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_estados) + 
  labs(title = "Poblaci칩n Nacimiento",
       subtitle = "Residentes en el estado",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Residentes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


## Inmigrantes

```{r}
tabla <- P.Nacimiento %>%
  arrange(Inmigrantes) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y =Inmigrantes, color = "LINE1")) +
  geom_ribbon(aes(ymin = Inmigrantes_low, ymax = Inmigrantes_upp), alpha = 0.2) + 
  geom_line(aes(y = Inmigrantes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_estados) + 
  labs(title = "Poblaci칩n Nacimiento",
       subtitle = "Nacidos en otro estado (Inmigrantes)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Inmigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


## Emigrantes

```{r}
tabla <- P.Nacimiento %>%
  arrange(Emigrantes) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_line(aes(y = Emigrantes, color = "LINE1")) +
  geom_ribbon(aes(ymin = Emigrantes_low, ymax = Emigrantes_upp), alpha = 0.2) + 
  geom_line(aes(y = Emigrantes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_estados) + 
  labs(title = "Poblaci칩n Nacimiento",
       subtitle = "Nacidos en otro estado (Emigrantes)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Emigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


## Tasa de Inmigrantes

```{r}
T.MNac <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                    sheet = "T. MNac") 

T.MNac <- T.MNac %>%
  as.data.frame() %>%
  filter(NOM_ENT %nin% "Total")
names(T.MNac)
str(T.MNac)
```


```{r}
tabla <- T.MNac %>%
  arrange(Tasa_Inmigracion_Censo) %>%
  droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
  geom_text(aes(y = Tasa_Inmigracion, label = round(Tasa_Inmigracion, 1)), size = 2, vjust = -1.5) +
  geom_text(aes(y = Tasa_Inmigracion_Censo, label = round(Tasa_Inmigracion_Censo, 1)), size = 2, vjust = 1.5, color = "#808080") +
  geom_line(aes(y = Tasa_Inmigracion, color = "LINE1")) +
  geom_ribbon(aes(ymin = Tasa_Inmigracion_low, ymax = Tasa_Inmigracion_upp), alpha = 0.2) + 
  geom_line(aes(y = Tasa_Inmigracion_Censo, color = "LINE2")) +
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  #scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  scale_x_discrete(limits = nom_ent) + 
  labs(title = "Tasa de Inmigraci칩n",
       subtitle = "Nacidos en otro estado (Inmigrantes)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Tasa de inmigracion) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```



# Poblaci칩n Municipal

```{r}
MRes5 <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                   sheet = "Lugar de residencia (Municipio)") 

MRes5 <- MRes5  %>%
  as.data.frame() %>%
  filter(NOM_MUN %nin% "Total")
names(MRes5)
```


## Residentes

```{r}
tabla <- MRes5 %>%
  arrange(Inmigrantes_Muestra) %>%
  filter(MUN_Muestra %in% "Municipio muestreado") %>%
  droplevels() %>%
  slice(1:200) 

mun <- tabla %>% pull(CVE_MUN)

p <- tabla %>%
  ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
  geom_line(aes(y = Inmigrantes_Muestra, color = "LINE1")) +
  geom_ribbon(aes(ymin = Inmigrantes_Muestra_low, ymax = Inmigrantes_Muestra_upp), alpha = 0.2) + 
  geom_line(aes(y = Inmigrantes_Censo, color = "LINE2")) + 
  theme_minimal() + 
  theme(plot.title = element_text(family = "Montserrat Medium", size = 20), 
        plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
        axis.text = element_text(family = "Montserrat Medium", size = 10), 
        axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
        axis.title = element_text(family = "Montserrat Medium", size = 12),
        legend.text = element_text(family = "Montserrat Medium"),
        legend.title = element_text(family = "Montserrat Medium")) + 
  scale_colour_manual(labels = c("Muestra", "Censo"),
                      values = c("LINE1" = "blue", "LINE2" = "red")) +
  #scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
  # scale_x_discrete(limits = mun) + 
  labs(title = "Migraci칩n reciente 2015 - 2020",
       subtitle = "Inmigrantes (Residencia en otro estado)",
       y = "",
       x = "", 
       color = "", 
       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Residentes) a nivel municipal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

