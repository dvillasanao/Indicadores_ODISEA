---
title: "Indicadores de migración interna"
subtitle: "Comparativo microdatos del censo y la muestra"
author: "CONAPO"
output:
  html_document:
    code_folding: hide
    highlight: tango
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
---
  
\usepackage{color}

```{=html}
<style>
  code.r{
    font-size: 12px;
 }
pre{
  font-size: 12px;
  background-color: #F8F3F8  ;
  font-family:"Verdana"; 
  font-weight: plain;
}
</style>
  
<style>
  body {
    text-align: justify;
    font-style: normal;
    font-family: "Verdana";
    font-size: 12px
  }
h1.title {
  font-size: 30px;
  font-family: "Verdana";
  color: #930C6D;
}
h1 {
  font-size: 30px;
  font-family: "Verdana";
  color: #9A1E77;
}
h2 {
  font-size: 24px;
  font-family: "Verdana";
  color: #172984;
}
h3 {
   font-size: 20px;
   font-family: "Verdana";
  color: #172984;
}
</style>
```

```{=html}
<style>
  .nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
    color: #710B6B;
  }
.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
    color: #ffffff;
    font-family: "Verdana";
    background-color: #BF5C9E;
}
</style>
```



```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE, cache.lazy = FALSE, 
                      eval = FALSE, class.source = "fold-show")
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(digits = 2, encoding = "UTF8")
```   


```{r, echo=FALSE}
rm(list = ls())
```

```{r, echo=FALSE}
setwd(here::here())
```


```{r, echo=FALSE}
#Font Stlye
require(showtext)
library(extrafont)
# activar showtext
# SE cargan las funtes del sitema Windows (Pero tarda en correr)
#ttf_import('C:/Users/dvill/AppData/Local/Microsoft/Windows/Fonts/')
#fonts()
#extrafont::loadfonts(device = "win")
#font_import()
windowsFonts()
```


```{r, echo = FALSE}
# Librerías que se usaron en el documCVE_ENTo
require(Cairo)
require(haven)
require(Hmisc) # %nin%
require(dplyr)
require(survey)
require(srvyr)
require(stringr)
require(sna)
require(expss)
require(knitr)
require(kableExtra)
require(sjlabelled)
require(gt)
require(ggplot2)
require(ggrepel)
require(ggpubr)
require(janitor)
require(tibble)
require(tidyr)
require(reshape2)
require(openxlsx)
require(doMC)
registerDoMC(cores = 60)
```



**Cuestionario Ampliado del Censo de Población y Vivienda 2020**
  
El cuestionario ampliado se guarda en un un archivo `.RData`.

```{r, eval = FALSE}
data <- read_sav("~/Personas_Censo 2020.SAV")
save(data, 
     file = paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))
```

Se seleccionan las variables que se desean conservar para la realización de este documento y se guarda en un archivo `.RData` para practicidad del manejo de datos.

**Posibles variables que se pueden contemplar en la migración reciente**
  
-   `EDAD` \   
-   `SEXO` \  
-   `AFRODES`\   
-   `HLENGUA`\   
-   `QDIALECT_INALI`    
-   `PERTE_INDIGENA`\  
-   `NIVACAD`   
-   `ALFABET`   
-   `CAUSA_MIG`\   
-   `SITUA_CONYUGAL`\   
-   `CONACT`\  
-   `HIJOS_NAC_VIVOS`  

La variable `mydata` contiene **15 015 683 observaciones** y **12 variables**.

```{r, eval = FALSE}
load(paste0(here::here(), "/Bases/Censo_Personas_2020.RData"))

mydata <- data %>%
            select(ID_VIV, ID_PERSONA,CVE_ENT, ENT, MUN, CVE_MUN, LOC50K, COBERTURA, CLAVIVP, NUMPER, ENT_PAIS_NAC,
                   ENT_PAIS_RES_5A, MUN_RES_5A, CVE_MUN_RES15, EDAD, SEXO, AFRODES, 
                   HLENGUA, QDIALECT_INALI, PERTE_INDIGENA, NIVACAD, ALFABET, ESCOLARI, ESCOACUM,
                   CONACT, SITTRA, CAUSA_MIG, SITUA_CONYUGAL, CONACT, HIJOS_NAC_VIVOS, 
                   FACTOR, ESTRATO, UPM)

save(mydata, file = paste0(here::here(), "/Bases/01_Migracion interna_2020.RData"))
```


✔️A partir de aquí se pueden correr los códidos 👇.   
Se carga el archivo `Migracion interna_2020.RData`.   

```{r}
load(file = paste0(here::here(), "/Bases/01_Migracion interna_2020.RData"))

# Para fines prácticos se genera un ponderador de uno 
mydata <- mydata %>%
           select(ID_VIV, ID_PERSONA, CVE_ENT, ENT, MUN, CVE_MUN, LOC50K, COBERTURA, ENT_PAIS_NAC, ENT_PAIS_RES_5A, MUN_RES_5A,
                  CVE_MUN_RES15, EDAD, COBERTURA, FACTOR, ESTRATO, UPM) %>%
           mutate(M = 1)  %>%
            mutate(NOM_ENT = as.factor(.$CVE_ENT)) %>%
             ungroup()
```

**Claves de entidades y municipios**
  
  Se genera un vector con el nombre de las entidades llamado `estados` para facilitar los filtros en el documento.\  
Se genera un vector con las abreviaturas de las entidades llamado `ent` para fines prácticos.\      
Se genera un vector con las claves de los municipios, pero es importante hacer notar que tres municipios no entraron el muestreo del Cuestionario Ampliado.      

```{r}
# Claves de los estados
estados <- sjlabelled::get_labels(mydata$CVE_ENT)
nom_estados <- c( "Aguascalientes", "Baja California" ,"Baja California Sur", "Campeche", "Coahuila de Zaragoza",
                  "Colima", "Chiapas", "Chihuahua", "Ciudad de México", "Durango", 
                  "Guanajuato", "Guerrero", "Hidalgo", "Jalisco",  "México", 
                  "Michoacán de Ocampo", "Morelos", "Nayarit", "Nuevo León", "Oaxaca", 
                  "Puebla", "Querétaro", "Quintana Roo", "San Luis Potosí", "Sinaloa", 
                  "Sonora", "Tabasco", "Tamaulipas", "Tlaxcala","Veracruz de Ignacio de la Llave", 
                  "Yucatán", "Zacatecas")
est <- c("AGS", "BC", "BCS", "CAMP", "COAH", "COL", "CHIS", "CHIH", "CDMX", "DGO", "GTO", "GRO", "HGO",
         "JAL", "MEX", "MICH", "MOR", "NAY", "NL", "OAX", "PUE", "QRO", "QROO", "SLP","SIN","SON", "TAB", 
         "TAMS", "TLX", "VER", "YUC", "ZAC")

# Claves de los municipios
MUN <- readRDS(paste0(here::here(), "/Bases/municipios_2020.RDS"))
nom_municipios <- sjlabelled::get_labels(MUN$NOM_MUN) %>% as.factor()
municipios <- sjlabelled::get_labels(MUN$CVE_MUN) %>% as.factor()

# Claves de los estados
ENT <- readRDS(file = paste0(here::here(), "/Bases/entidad_2020.RDS"))
```


**Población de 5 años y más**   
  
  Se identifica a la población de 5 años y más.   

`filter(EDAD >= 5 & EDAD != 999)'.`   

```{r}
Pob.5ymas <- muestra_2020 %>%
  as.data.frame() %>%
  mutate(EDAD = as.numeric(.$EDAD)) %>%
  subset(EDAD >= 5 & EDAD <= 130) %>%
  filter(ENT_PAIS_RES_5A %in% estados)  # Filtro del lugar de residencia dentro del país. 
```

```{r, echo = FALSE}
# Población de 5 años y más
tabla <- Pob.5ymas %>%
  summarise(Pob_5ymas = sum(.$FACTOR))
rm(Pob.5ymas)

as.integer(tabla) %>%  
  as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none"))) %>%
  gt() %>% 
  tab_header(title = "Población de 5 años y más") %>%
  tab_options(heading.title.font.size = 12, 
              heading.align = "center",
              heading.subtitle.font.size = 10,
              table.align = "center",
              column_labels.font.weight = "bold",
              table.font.names = 'montserrat',
              table.font.size = 8) %>%  
  as_raw_html()
```

**Diferencias en la estimación de la varianza**   

Es importante identificar que, dentro del análisis de muestras complejas, existen una serie de variaciones en los cálculos de la estimación de la varianza. Ya que en los programas de licencia; `STATA`, `SAS`, `SPSS` o bien de licencia libre como `R`. Existen diferencias en las estimaciones de la varianza o propiamente del **error estándar**. En este documento se hace una revisión de estas discrepancias con los diferentes programas estadísticos y en donde se encuentran estas diferencias significativas del cálculo.            
[`Understanding the code used to implement the {survey} package’s recursive variance estimation for multistage samples`](https://www.practicalsignificance.com/posts/understanding-the-survey-packages-recursive-algorithm/).   

# Nivel estatal {.tabset .tabset-pills}

## Población Total {.tabset .tabset-pills}

Estructura de la población por estado. Utilizando REDATAM.  

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Residencia_Habitual a nivel estatal_2020.xlsx" OVERWRITE
```
````

```{r}
options(survey.lonely.psu = "adjust")
#options("survey.ultimate.cluster" = FALSE)

MC <- mydata %>%
       as.data.frame() %>%
        select(ID_VIV, ID_PERSONA, FACTOR, ESTRATO, UPM, CVE_ENT) %>%
          mutate(probs = 1/.$FACTOR) %>%
           mutate(Pob.Total = 1,
                  M = 1) 
FPC <- MC %>%
        group_by(UPM, ESTRATO) %>% 
         summarise(n = n(), .groups = 'drop') %>%
          mutate(fpc = n/sum(n)) %>% 
           right_join(MC, by = join_by(UPM, ESTRATO))

svy_design <- MC  %>%
               svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, 
                          probs = ~probs
                           nest = TRUE)
```


**Población total** 

```{r}
## Población de total
Total_est <- svyby(~Pob.Total,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

## Población total en el estado 
est <- svyby(~Pob.Total,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.Total (Estados)")
writeData(wb, 1, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion Total (Estados).xlsx"), 
             overwrite = TRUE)
```

## Población 5 años y más {.tabset .tabset-pills}

Estructura de la población de 5 años y más. Utilizando REDATAM.  

````
```{r}`r ''`
TABLE DR_RESHAB
FREQ CVE_ENT
FILTER EDAD > 4 AND EDAD <= 130
TITLE "RESIDENCIA HABITUAL"
OUTPUTFILE XLS "Output\Poblacion 5 años y mas a nivel estatal_2020.xlsx" OVERWRITE
```
````

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD), 
                 M = 1) %>%
           mutate(Pob.5ymas = case_when(.$EDAD >= 5 & .$EDAD <= 130 ~ 1,
                                   TRUE ~  0)) 

svy_design <- MC  %>%
               svydesign(data = ., ids = ~UPM, strata = ~ESTRATO, 
                         #weights = ~FACTOR, 
                          nest = TRUE,
                           probs = ~probs)
```


**Población de 5 años y más** 

```{r, class.source = "fold-hide"}
## Población de 5 años y más
Total_est <- svyby(~Pob.5ymas,
                    by = ~M,
                     svy_design,
                      svytotal,
                       vartype = c("se","cv"),
                        drop.empty.groups = TRUE) %>%
              cbind(confint(object = ., level = 0.90))

Total_est %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))


## Población de 5 años y más en el estado 
est <- svyby(~Pob.5ymas,
              by = ~CVE_ENT,
               svy_design,
                svytotal,
                 vartype = c("se","cv"),
                  drop.empty.groups = TRUE) %>%
        cbind(confint(object = ., level = 0.90))

est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Se guardan los resultados** 

```{r}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.5ymas (Total)")
addWorksheet(wb, "Pob.5ymas (Estados)")
writeData(wb, 1, Total_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Pob.5ymas (Estados).xlsx"), 
             overwrite = TRUE)
```

## Migración nacimiento {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiación es tener controlados a los que nacieron en otro país o los no especificados. 

Estructura de la población total. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMNAC  (División Administrativa Mayor de Nacimiento)  */
DEFINE PERSONA.DAMNAC
	AS SWITCH
     INCASE PERSONA.ENT_PAIS_NAC > 32
     ASSIGN 0
     INCASE PERSONA.ENT_PAIS_NAC <= 32 
     ASSIGN PERSONA.ENT_PAIS_NAC
  NOTAPPLICABLE 0
  MISSING 1
  DEFAULT 0
	TYPE INTEGER
	RANGE (1:32)
  VARLABEL "Entidad de nacimiento"
	LIKE PERSONA.ENT_PAIS_NAC
SAVE "variables\DAMNAC.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAM-indicadores migración toda la vida
TABLE MB_NAC_DAM
FREQ DAMRES BY DAMNAC
FILTER DAMRES > 0 AND DAMNAC > 0
ZERO
TITLE "MATRIZ MIGRACIÓN TODA LA VIDA"
OUTPUTFILE JSON "MIGINT\MINT-MB-NAC-DAM.JSON" OVERWRITE
```
````

**Clasificación de las variables para el muestreo complejo**

```{r}
options(survey.lonely.psu = "adjust")

# Se almacena a la población total del lugar de residencia habitual a nivel estatal
POB_TOT <- mydata%>%
            group_by(CVE_ENT) %>%
             mutate(Pob.Total = sum(M * FACTOR)) %>%
              ungroup() %>%
               distinct(., CVE_ENT, Pob.Total) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_NAC, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD),
                 M = 1) %>%
           mutate(ENT_PAIS_NAC = case_when(.$ENT_PAIS_NAC %in% estados ~.$ENT_PAIS_NAC,
                                           .$ENT_PAIS_NAC %in% "997" ~ "997",
                                           .$ENT_PAIS_NAC %in% "998" ~ "998",
                                           .$ENT_PAIS_NAC %in% "999" ~ "999",
                                           .$ENT_PAIS_NAC %nin% estados ~ "888", #Residencia en otro país
                                           )) %>% 
            mutate(I_Nacimiento = case_when(.$CVE_ENT == .$ENT_PAIS_NAC ~ "1",
                                           .$CVE_ENT != .$ENT_PAIS_NAC & (.$ENT_PAIS_NAC %nin% c("888", "997", "998", "999")) ~ "2",
                                           .$ENT_PAIS_NAC == "888" ~ "888",
                                           .$ENT_PAIS_NAC == "997" ~ "997",
                                           .$ENT_PAIS_NAC == "998" ~ "998",
                                           .$ENT_PAIS_NAC == "999" ~ "999")) %>%
             # Se clasifica a la población residente de la migrante
             mutate(Residentes = case_when(I_Nacimiento %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when(I_Nacimiento %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la población total de acuerdo al lugar de residencia habitual y de nacimiento, para el calculo
             # de las tasas de emigación
              left_join(., POB_TOT %>% 
                            rename("Pob.Total_Estados" = "Pob.Total"), by = c("ENT_PAIS_NAC" = "CVE_ENT")) %>%
               group_by(ENT_PAIS_NAC) %>%
                mutate(Pob.Total.Nacimiento = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.Total_Estados / Pob.Total.Nacimiento)
   
```

### Muestreo Complejo (Opción 1)


```{r, eval = FALSE}
require(survey)
svy_design <- MC  %>%
               svydesign(data = ., 
                          ids = ~UPM, 
                           strata = ~ESTRATO, 
                            probs = ~probs,
                             nest = TRUE)
```

**Población total**

```{r, class.source = "fold-hide"}
## Población Total (Indicadora de nacimiento)
Total_Residentes <- svyby(~Residentes,
                               by = ~M,
                                svy_design,
                                 svytotal,
                                  vartype = c("se","cv"),
                                   drop.empty.groups = TRUE) %>%
                          cbind(confint(object = ., level = 0.90))
Total_Residentes %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

Total_Inmigrantes <- svyby(~Migrantes,
                                by = ~M,
                                 svy_design,
                                  svytotal,
                                   vartype = c("se","cv"),
                                    drop.empty.groups = TRUE) %>%
                           cbind(confint(object = ., level = 0.90))

Total_Inmigrantes %>% 
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Inmigración**   

```{r, class.source = "fold-hide"}
## Población Total (Lugar de Nacimiento) en el estado
TI_Total <- svyby(~Migrantes,
                   denominator = ~M,
                    by = ~M,
                    svy_design,
                     svyratio,
                      vartype = c("se","cv"),
                       drop.empty.groups = TRUE) %>%
             cbind(confint(object = ., level = 0.90))
TI_Total %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Residentes por estado** 

```{r, class.source = "fold-hide"}
## Población Total (Lugar de Nacimiento) en el estado
residentes <- svyby(~Residentes,
                     by = ~CVE_ENT,
                      svy_design,
                       svytotal,
                        vartype = c("se","cv"),
                         drop.empty.groups = TRUE) %>%
               cbind(confint(object = ., level = 0.90))

residentes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Inmigrantes por estado** 

```{r, class.source = "fold-hide"}
## Población Total (Lugar de Nacimiento) en el estado
inmigrantes <- svyby(~Migrantes,
                       by = ~CVE_ENT,
                        svy_design,
                         svytotal,
                          vartype = c("se","cv"),
                           drop.empty.groups = TRUE) %>%
                 cbind(confint(object = ., level = 0.90))

inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Emigrantes por estado** 

```{r, class.source = "fold-hide"}
## Población Total (Lugar de Nacimiento) en el estado
emigrantes <- svyby(~Migrantes,
                     by = ~ENT_PAIS_NAC,
                      svy_design,
                       svytotal,
                        vartype = c("se","cv"),
                         drop.empty.groups = TRUE) %>%
               cbind(confint(object = ., level = 0.90))

emigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Inmigración por estado**   

```{r, class.source = "fold-hide"}
## Población Total (Lugar de Nacimiento) en el estado
TI_est <- svyby(~Migrantes,
                 denominator = ~M,
                  by = ~CVE_ENT,
                   svy_design,
                    svyratio,
                     vartype = c("se","cv"),
                      drop.empty.groups = TRUE) %>%
                cbind(confint(object = ., level = 0.90))
TI_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Tasa de Emigración por estado**   

```{r, class.source = "fold-hide"}
## Población Total (Lugar de Nacimiento) en el estado
TE_est <- svyby(~Migrantes,
                 denominator = ~PPob,
                  by = ~ENT_PAIS_NAC,
                   svy_design,
                    svyratio,
                     vartype = c("se","cv"),
                      drop.empty.groups = TRUE) %>%
                cbind(confint(object = ., level = 0.90))
TE_est %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```


**Se guardan las base de datos**  

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Residentes (Total)")
addWorksheet(wb, "Migrantes (Total)")
addWorksheet(wb, "Residentes (Estados)")
addWorksheet(wb, "Inmigrantes (Estados)")
addWorksheet(wb, "Emigrantes (Estados)")
addWorksheet(wb, "T.Inmigrantes (Total)")
addWorksheet(wb, "T.Inmigrantes (Estados)")
addWorksheet(wb, "T.Emigrantes (Estados)")
writeData(wb, 1, Total_Residentes_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Total_Inmigrantes_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 3, residentes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 4, inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 5, emigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 6, TI_Total, colNames = TRUE, rowNames = TRUE)
writeData(wb, 7, TI_est, colNames = TRUE, rowNames = TRUE)
writeData(wb, 8, TE_est, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados).xlsx"), 
             overwrite = TRUE)
rm(Total_Residentes, Total_Inmigrantes, residentes, inmigrantes, emigrantes, TI_Total, TI_est, TE_est)
```


### Muestreo Complejo (Opción 2)

La paquetería `srvyr` se centra en calcular estadísticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paquetería `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluación no estándar de rlang y tipos de retorno más consistentes que el paquete de encuestas.   

```{r}
require(srvyr)
svy_design <- MC %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

**Inmigrantes** 

```{r, class.source = "fold-hide"}
Total_Inmigrantes <- svy_design %>%
                      dplyr::summarise(Poblacion_Total = survey_total(M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       Residentes = survey_total(Residentes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       Inmigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                       TInmigracion = survey_ratio(numerator = Migrantes, denominator = M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE)) 

Total_Inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))

inmigrantes <- svy_design %>%
                group_by(CVE_ENT) %>%
                 dplyr::summarise(Poblacion_Total = survey_total(M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(Residentes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = Migrantes, denominator = M, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

inmigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```



**Emigrantes** 

```{r, class.source = "fold-hide"}
Total_Emigrantes <- svy_design %>%
                     dplyr::summarise(Emigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                      TEmigracion = survey_ratio(numerator = Migrantes, denominator = PPob, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

emigrantes <- svy_design %>%
               group_by(ENT_PAIS_NAC) %>%
                dplyr::summarise(Emigrantes = survey_total(Migrantes, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                 TEmigracion = survey_ratio(numerator = Migrantes, denominator = PPob, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

emigrantes %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Se guardan las base de datos**  

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Inmigrantes (Total)")
addWorksheet(wb, "Inmigrantes (Estados)")
addWorksheet(wb, "Emigrantes (Total)")
addWorksheet(wb, "Emigrantes (Estados)")
writeData(wb, 1, Total_Inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, inmigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 3, Total_Emigrantes, colNames = TRUE, rowNames = TRUE)
writeData(wb, 4, emigrantes, colNames = TRUE, rowNames = TRUE)

saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados).xlsx"), 
             overwrite = TRUE)
```

### Muestreo Complejo (Opción 3)

La paquetería `srvyr` se centra en calcular estadísticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paquetería `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluación no estándar de rlang y tipos de retorno más consistentes que el paquete de encuestas.   

```{r}
require(srvyr)
svy_design <- MC %>% 
               select(ESTRATO, UPM, probs, CVE_ENT, ENT_PAIS_NAC, M, Residentes, Migrantes, PPob) %>%
                reshape2::melt(., id.vars = c("ESTRATO", "UPM", "probs", "M", "Residentes", "Migrantes", "PPob")) %>%
                 srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```


**Indicadores de migración para toda la vida (Total)**

```{r, class.source = "fold-hide"}
Indicadores_Totales <- svy_design %>%
                        dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                                     denominator = ifelse(variable %in% "CVE_ENT", M, 0), 
                                                                     vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE), 
                                         TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0),
                                                                    denominator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, PPob, 0), 
                                                                    vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                         MN = Inmigrantes - Emigrantes,
                                         MB = Inmigrantes + Emigrantes,
                                         TNM = TInmigracion - TEmigracion,
                                         TBM = TInmigracion + TEmigracion,
                                         Eficacia = MN - MB
                                         ) 
```


**Indicadores de migración para toda la vida (Estados)**

```{r, class.source = "fold-hide"}
Indicadores <- svy_design %>%
                group_by(value) %>%
                 dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                              denominator = ifelse(variable %in% "CVE_ENT", M, 0), 
                                                              vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, Migrantes, 0),
                                                             denominator = ifelse(variable %in% "ENT_PAIS_NAC" & value %in% estados, PPob, 0), 
                                                             vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  MN = Inmigrantes - Emigrantes,
                                  MB = Inmigrantes + Emigrantes,
                                  TNM = TInmigracion - TEmigracion,
                                  TBM = TInmigracion + TEmigracion,
                                  Eficacia = MN - MB
                                  #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #Índice de Eficacia Migratoria
                                   ) 
```


**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Nacimiento (Total)")
addWorksheet(wb, "Lugar de Nacimiento (Estados)")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de nacimiento (Estados)_Indicadores.xlsx"), 
             overwrite = TRUE)
```


## Migración reciente {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiación es tener controlados a los que nacieron en otro país o los no especificados. 

Estructura utilizando REDATAM.  

````
```{r}`r ''`
/*DAMRES5 (División Administrativa Mayor de residencia anterior) */
DEFINE PERSONA.DAMRES5
	AS RECODE PERSONA.ENT_PAIS_RES_5A
      (33: HIGHEST = 0)
  FILTER PERSONA.EDAD >= 5 AND PERSONA.EDAD <= 130
  NOTAPPLICABLE 0
  DEFAULT 0
	TYPE INTEGER
	RANGE (1:32)
  VARLABEL "Entidad de residencia hace 5 años"
	LIKE PERSONA.ENT_PAIS_RES_5A
SAVE "variables\DAMRES5.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAME-Matriz migración Reciente	
TABLE MB_REC_DAME
		FREQ DAMERES BY DAMERES5
		FILTER EDAD > 4 AND DAMERES > 0 AND DAMERES5 > 0
		ZERO
		TITLE "MATRIZ MIGRACIÓN RECIENTE"
		OUTPUTFILE JSON "MIGINT\MINT-MB-REC-DAME.JSON" OVERWRITE
```
````


**Clasificación de las variables para el muestreo complejo**

```{r}
options(survey.lonely.psu = "adjust")

# Se almacena a la población de 5 años y más del lugar de residencia habitual a nivel estatal
Pob.5ymas <- mydata%>%
              filter(.$EDAD >= 5 & .$EDAD <= 130) %>%
               group_by(CVE_ENT) %>%
                mutate(Pob.5ymas = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  distinct(., CVE_ENT, Pob.5ymas) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_ENT, ENT_PAIS_RES_5A, EDAD, M) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD)) %>%
           mutate(ENT_PAIS_RES_5A = case_when(nchar(.$ENT_PAIS_RES_5A) == 0 ~ NA,
                                              .$ENT_PAIS_RES_5A %in% estados ~.$ENT_PAIS_RES_5A,
                                              .$ENT_PAIS_RES_5A %in% "997" ~ "997",
                                              .$ENT_PAIS_RES_5A %in% "998" ~ "998",
                                              .$ENT_PAIS_RES_5A %in% "999" ~ "999",
                                              .$ENT_PAIS_RES_5A %nin% c(estados, "997", "998", "999") ~ "888" #Residencia en otro país
                                               )) %>% 
            mutate(I_Residencia = case_when(.$CVE_ENT == .$ENT_PAIS_RES_5A ~ "1",
                                            .$CVE_ENT != .$ENT_PAIS_RES_5A & (.$ENT_PAIS_RES_5A %nin% c("888", "997", "998", "999")) ~ "2",
                                            .$ENT_PAIS_RES_5A == "888" ~ "888",
                                            .$ENT_PAIS_RES_5A == "997" ~ "997",
                                            .$ENT_PAIS_RES_5A == "998" ~ "998",
                                            .$ENT_PAIS_RES_5A == "999" ~ "999")) %>%
             # Se clasifica a la población residente de la migrante
             mutate(Pob.5ymas = case_when((.$EDAD >= 5 & .$EDAD <= 130) ~ 1,
                                           TRUE ~ 0),
                    Residentes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la población total de acuerdo al lugar de residencia habitual y de nacimiento, para el calculo
             # de las tasas de emigación
              left_join(., Pob.5ymas %>% 
                            rename("Pob.5ymas_Estados" = "Pob.5ymas"), by = c("ENT_PAIS_RES_5A" = "CVE_ENT")) %>%
               group_by(ENT_PAIS_RES_5A) %>%
                mutate(Pob.Total.R5a = sum(Pob.5ymas * FACTOR)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.5ymas_Estados / Pob.Total.R5a)
```


### Muestreo Complejo (Opción 3)

La paquetería `srvyr` se centra en calcular estadísticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paquetería `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluación no estándar de rlang y tipos de retorno más consistentes que el paquete de encuestas.   

```{r}
require(srvyr)
svy_design <- MC %>% 
               select(ESTRATO, UPM, probs, CVE_ENT, ENT_PAIS_RES_5A, M, Pob.5ymas, Residentes, Migrantes, PPob) %>%
                reshape2::melt(., id.vars = c("ESTRATO", "UPM", "probs", "M", "Pob.5ymas", "Residentes", "Migrantes", "PPob")) %>%
                 srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

**Indicadores de migración reciente hace 5 años (Total)** 

```{r, class.source = "fold-hide"}
Indicadores_Totales <- svy_design %>%
                         dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Pob_5ymas = survey_total(ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                                      denominator = ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), 
                                                                      vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0),
                                                                     denominator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, PPob, 0), 
                                                                     vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          MN = Inmigrantes - Emigrantes,
                                          MB = Inmigrantes + Emigrantes,
                                          TNM = TInmigracion - TEmigracion,
                                          TBM = TInmigracion + TEmigracion,
                                          Eficacia = MN - MB
                                          #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #Índice de Eficacia Migratoria
                                           ) 
```

**Indicadores de migración reciente hace 5 años (Estados)** 

```{r, class.source = "fold-hide"}
Indicadores <- svy_design %>%
                group_by(value) %>%
                 dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_ENT", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Pob_5ymas = survey_total(ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(ifelse(variable %in% "CVE_ENT", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(ifelse(variable %in% "CVE_ENT", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_ENT", Migrantes, 0),
                                                              denominator = ifelse(variable %in% "CVE_ENT", Pob.5ymas, 0), 
                                                              vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Emigrantes = survey_total(ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TEmigracion = survey_ratio(numerator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, Migrantes, 0),
                                                             denominator = ifelse(variable %in% "ENT_PAIS_RES_5A" & value %in% estados, PPob, 0), 
                                                             vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  MN = Inmigrantes - Emigrantes,
                                  MB = Inmigrantes + Emigrantes,
                                  TNM = TInmigracion - TEmigracion,
                                  TBM = TInmigracion + TEmigracion,
                                  Eficacia = MN - MB
                                  #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #Índice de Eficacia Migratoria
                                   ) 
```


**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Residencia (Totales")
addWorksheet(wb, "Lugar de Residencia (Estados")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de residencia (Estados)_Indicadores.xlsx"), 
             overwrite = TRUE)
```

# Nivel municipal {.tabset .tabset-pills}

## Población Total {.tabset .tabset-pills}

Estructura de la población por estado. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMERES (División Administrativa Menores de Residencia)*/
DEFINE PERSONA.DAMERES
	AS MUN.REDCODEN
	TYPE INTEGER
	RANGE (1001:32058)
  FILTER MUN.REDCODEN <> 4012 AND MUN.REDCODEN <> 7125 AND MUN.REDCODEN <> 29048
  VARLABEL "Municipio de residencia"
	LIKE MUN.REDCODEN
SAVE "variables\DAMERES.rbf"
OVERWRITE
GROUP MIGRACION
```
````

```{r}
options(survey.lonely.psu = "adjust")
#options(survey.lonely.psu="certainty")
#options(survey.adjust.domain.lonely = FALSE)
options(survey.ultimate.cluster = TRUE)

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_MUN) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(Pob.Total = 1) 

fpc <-  MC %>%
         group_by(ESTRATO, UPM) %>% 
           summarise(n = n(), .groups = 'drop') %>%
           mutate(fpc =  n / sum(n)) %>% 
           right_join(MC, by = join_by(ESTRATO, UPM))

svy_design <- fpc  %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, 
                                       #fpc = fpc, 
                                       nest = TRUE)

#prueba <- MC %>% 
 #          mutate(probs_svy = svy_design[["prob"]])

#sum(prueba$probs == prueba$probs_svy)
```


**Población total** 

```{r, class.source = "fold-hide"}
## Población de total
Indicadores_Totales <- svy_design %>%
                        dplyr::summarise(Pob.Total = survey_total(Pob.Total, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

Indicadores_Totales %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", small.interval = 3L, preserve.width = "none")))

#653579.880495

## Población total en los municipios
Indicadores <- svy_design %>% 
                group_by(CVE_MUN) %>%
                 dplyr::summarise(Pob.Total = survey_total(Pob.Total, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

```

**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob.Total (Total)")
addWorksheet(wb, "Pob.Total (Municipios)")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion Total (Municipios).xlsx"), 
             overwrite = TRUE)
```

## Población 5 años y más {.tabset .tabset-pills}

```{r}
options(survey.lonely.psu = "adjust")

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_MUN, EDAD) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD), 
                 M = 1) %>%
           mutate(Pob.5ymas = case_when(.$EDAD >= 5 & .$EDAD <= 130 ~ 1,
                                   TRUE ~  0)) 

svy_design <- MC  %>%
               srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```


**Población 5 años y más** 

```{r, class.source = "fold-hide"}
## Población de total
Indicadores_Totales <- svy_design %>%
                        dplyr::summarise(Pob_5ymas = survey_total(Pob.5ymas, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))

## Población total en los municipios
Indicadores <- svy_design %>%
                group_by(CVE_MUN) %>%
                 dplyr::summarise(Pob_5ymas = survey_total(Pob.5ymas, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE))
```

**Se guardan los resultados**

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Pob_5ymas (Total)")
addWorksheet(wb, "Pob_5ymas (Municipios)")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Poblacion de 5 años y más (Municipios).xlsx"), 
             overwrite = TRUE)
```


## Migración reciente {.tabset .tabset-pills}

Para poder clasificiar a la matriz de nacimiento, es importante clasificar a los:    

- Residentes  (Diagonal de la matriz).     
- Inmigrantes (Entran al lugar de residencia habitual 2020).   
- Emigrantes (Salen del lugar de residencia habitual 2020).  

En esta clasificiación es tener controlados a los que nacieron en otro país o los no especificados. 

Estructura de la población migrante a nivel municipal. Utilizando REDATAM.  

````
```{r}`r ''`
/*DAMERES (División Administrativa Menores de Residencia)*/
DEFINE PERSONA.DAMERES
	AS MUN.REDCODEN
	TYPE INTEGER
	RANGE (1001:32058)
  FILTER MUN.REDCODEN <> 4012 AND MUN.REDCODEN <> 7125 AND MUN.REDCODEN <> 29048
  VARLABEL "Municipio de residencia"
	LIKE MUN.REDCODEN
SAVE "variables\DAMERES.rbf"
OVERWRITE
GROUP MIGRACION
```
````

````
```{r}`r ''`
//Nivel DAME-Matriz migración Reciente	
TABLE MB_REC_DAME
		FREQ DAMERES BY DAMERES5
		FILTER EDAD > 4 AND DAMERES > 0 AND DAMERES5 > 0
		ZERO
		TITLE "MATRIZ MIGRACIÓN RECIENTE"
		OUTPUTFILE JSON "MIGINT\MINT-MB-REC-DAME.JSON" OVERWRITE
```
````

**Clasificación de las variables para el muestreo complejo**

```{r}
# Clave de los municipios 
### Municipios que no pertenecen en la muestra
municipios_nomuestra <- c("004012", "007125", "029048")

municipios <- MUN %>% 
               filter(CVE_MUN %nin% municipios_nomuestra) %>%
                pull(CVE_MUN)

# Se almacena a la población de 5 años y más del lugar de residencia habitual a nivel municipal
Pob.5ymas <- mydata%>%
              filter((.$EDAD >= 5 & .$EDAD <= 130) & CVE_MUN %in% municipios) %>%
               group_by(CVE_MUN) %>%
                mutate(Pob.5ymas = sum(M * FACTOR)) %>%
                 ungroup() %>%
                  distinct(., CVE_MUN, Pob.5ymas) 

MC <- mydata %>%
       as.data.frame() %>%
        select(FACTOR, ESTRATO, UPM, CVE_MUN, MUN_RES_5A, ENT_PAIS_RES_5A, CVE_MUN_RES15, EDAD, M) %>%
         mutate(probs = 1/.$FACTOR) %>%
          mutate(EDAD = as.numeric(.$EDAD)) %>%
           mutate(CVE_MUN = case_when(.$CVE_MUN %in% municipios ~ .$CVE_MUN,
                                      .$CVE_MUN %in% municipios_nomuestra ~ NA),
                  CVE_MUN_RES = case_when(nchar(.$CVE_MUN_RES15) == 0 ~ NA,
                                          .$CVE_MUN_RES15 %in% municipios ~.$CVE_MUN_RES15,
                                          #### Se excluyen los municipios que no fueron muestreados
                                          .$CVE_MUN_RES15 %in% municipios_nomuestra ~ "777",
                                          .$MUN_RES_5A %in% "999" ~ "996",
                                          .$CVE_MUN_RES15 %in% "997999" ~ '997999',
                                          .$ENT_PAIS_RES_5A %in% "997" ~ "997",
                                          .$ENT_PAIS_RES_5A %in% "998" ~ "998",
                                          .$ENT_PAIS_RES_5A %in% "999" ~ "999",
                                          nchar(.$CVE_MUN_RES15) == 3 ~ "888"  #Residencia en otro país
                                           ))  %>% 
            mutate(I_Residencia = case_when(.$CVE_MUN == .$CVE_MUN_RES ~ "1",
                                            .$CVE_MUN != .$CVE_MUN_RES & (.$CVE_MUN_RES %nin% c("777", "888", "996", "997", "998", "999", "997999")) ~ "2",
                                            .$CVE_MUN_RES == "777" ~ "777",
                                            .$CVE_MUN_RES == "888" ~ "888",
                                            .$CVE_MUN_RES == "996" ~ "996",
                                            .$CVE_MUN_RES == "997" ~ "997",
                                            .$CVE_MUN_RES == "998" ~ "998",
                                            .$CVE_MUN_RES == "999" ~ "999",
                                            .$CVE_MUN_RES == "997999" ~ "997999")) %>%
             # Se clasifica a la población residente de la migrante
             mutate(M = case_when(.$CVE_MUN %in% municipios ~ 1,
                                  TRUE ~ 0),
                    Pob.5ymas = case_when((.$EDAD >= 5 & .$EDAD <= 130) ~ 1,
                                           TRUE ~ 0),
                    Residentes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "1" ~ 1,
                                           TRUE ~ 0),
                    Migrantes = case_when((.$EDAD >= 5 & .$EDAD <= 130) & I_Residencia %in% "2" ~ 1,
                                           TRUE ~ 0))  %>% 
             # Se agrupa a la población total de acuerdo al lugar de residencia habitual y de residencia hace 5 años, para el calculo
             # de las tasas de emigación
              left_join(., Pob.5ymas %>% 
                            rename("Pob.5ymas_Municipios" = "Pob.5ymas"), by = c("CVE_MUN_RES" = "CVE_MUN")) %>%
               group_by(CVE_MUN_RES) %>%
                mutate(Pob.Total.R5a = sum(Pob.5ymas * FACTOR, na.rm = TRUE)) %>%
                 ungroup() %>%
                  mutate(PPob = Pob.5ymas_Municipios / Pob.Total.R5a)
```

### Muestreo Complejo (Opción 3)

La paquetería `srvyr` se centra en calcular estadísticas resumidas a partir de datos de encuestas, como la media, el total o el cuantil. Permite el uso de muchas funciones de la paquetería `dplyr`, como `summarize`, `group_by` y `mutate`, la conveniencia de funciones canalizables, el estilo de evaluación no estándar de rlang y tipos de retorno más consistentes que el paquete de encuestas.   

```{r}
options(survey.lonely.psu = "adjust")
options(survey.adjust.domain.lonely = TRUE)

svy_design <- MC %>% 
               select(ESTRATO, UPM, probs, CVE_MUN, CVE_MUN_RES, M, Pob.5ymas, Residentes, Migrantes, PPob) %>%
                reshape2::melt(., id.vars = c("ESTRATO", "UPM", "probs", "M", "Pob.5ymas", "Residentes", "Migrantes", "PPob")) %>%
                 srvyr::as_survey_design(ids = UPM, strata = ESTRATO, probs = probs, nest = TRUE)
```

```{r, echo = FALSE, eval = FALSE}
library(parallel)
require(dplyr)
# Configuración de clúster
cl <- makeCluster(10)  # Ajusta el número de clústeres según tu máquina

# Exportar 'svy_design' a los clústeres
clusterExport(cl, c("svy_design"))

# Lista de variables sobre las cuales realizar cálculos en paralelo
variables_a_procesar <- c("Pob.Total", "Pob_5ymas", "Residentes", "Inmigrantes", "TInmigracion", "Emigrantes", "TEmigracion", "MN", "MB", "TNM", "TBM", "Eficacia")
```

**Indicadores de migración reciente hace 5 años (Total)** 

```{r, class.source = "fold-hide"}
Indicadores_Totales <- svy_design %>%
                         dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_MUN" & value %in% municipios, M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Pob_5ymas = survey_total(ifelse(variable %in% "CVE_MUN" & value %in% municipios, Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Residentes = survey_total(ifelse(variable %in% "CVE_MUN" & value %in% municipios, Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Inmigrantes = survey_total(ifelse(variable %in% "CVE_MUN" & value %in% municipios, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN" & value %in% municipios, Migrantes, 0),
                                                                      denominator = ifelse(variable %in% "CVE_MUN" & value %in% municipios, Pob.5ymas, 0), 
                                                                      vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          Emigrantes = survey_total(ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          TEmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, Migrantes, 0),
                                                                     denominator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, PPob, 0), 
                                                                     vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                          MN = Inmigrantes - Emigrantes,
                                          MB = Inmigrantes + Emigrantes,
                                          TNM = TInmigracion - TEmigracion,
                                          TBM = TInmigracion + TEmigracion,
                                          Eficacia = MN - MB
                                          #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #Índice de Eficacia Migratoria
                                          ) 

Indicadores_Totales %>%
 as.data.frame() %>%
  mutate(across(where(is.numeric), ~ prettyNum(., big.mark = " ", preserve.width = "none")))
```

**Indicadores de migración reciente hace 5 años (Municipios)** 

```{r, class.source = "fold-hide"}
Indicadores <- svy_design %>%
                group_by(value) %>%
                 dplyr::summarise(Pob.Total = survey_total(ifelse(variable %in% "CVE_MUN", M, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Pob_5ymas = survey_total(ifelse(variable %in% "CVE_MUN", Pob.5ymas, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Residentes = survey_total(ifelse(variable %in% "CVE_MUN", Residentes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Inmigrantes = survey_total(ifelse(variable %in% "CVE_MUN", Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TInmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN", Migrantes, 0),
                                                              denominator = ifelse(variable %in% "CVE_MUN", Pob.5ymas, 0), 
                                                              vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  Emigrantes = survey_total(ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, Migrantes, 0), vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                  TEmigracion = survey_ratio(numerator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, Migrantes, 0),
                                                             denominator = ifelse(variable %in% "CVE_MUN_RES" & value %in% municipios, PPob, 0), 
                                                             vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE),
                                   MN = Inmigrantes - Emigrantes,
                                   MB = Inmigrantes + Emigrantes,
                                   TNM = TInmigracion - TEmigracion,
                                   TBM = TInmigracion + TEmigracion,
                                   Eficacia = MN - MB
                                   #IEM = svyratio(numerator = MN, denominator = MB, vartype = c("se", "cv", "ci"), level = 0.90, na.rm = TRUE) #Índice de Eficacia Migratoria
                                    ) 
```


**Se guardan los resultados** 

```{r, class.source = "fold-hide"}
# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Residencia (Totales")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de residencia (Municipios)_Indicadores_Totales.xlsx"), 
             overwrite = TRUE)

# Se guardan los resultados
wb <- createWorkbook()
addWorksheet(wb, "Lugar de Residencia (Totales")
addWorksheet(wb, "Lugar de Residencia (Estados")
writeData(wb, 1, Indicadores_Totales, colNames = TRUE, rowNames = TRUE)
writeData(wb, 2, Indicadores, colNames = TRUE, rowNames = TRUE)
saveWorkbook(wb, 
             file = paste0(here::here(), "/Output/Lugar de residencia (Municipios)_Indicadores.xlsx"), 
             overwrite = TRUE)
```


# Gráficos  {.tabset .tabset-pills}

Para el claculo de los gráficos, se decide tomar como referencia a los estimadores que salen en SPSS. 

## Nivel estatal {.tabset .tabset-pills}

### Población total

```{r}
Pob.Total <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 1, skipEmptyCols = TRUE,
                        sheet = "Población Total (Entidad)") %>%
              filter(NOM_ENT != "Total")
```


```{r}
tabla <- Pob.Total %>%
          arrange(Pob_Total_Muestra) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Pob_Total_Muestra, color = "LINE1")) +
        geom_ribbon(aes(ymin = Pob_Total_Muestra_low, ymax = Pob_Total_Muestra_upp), alpha = 0.2) + 
         geom_line(aes(y = Pob_Total_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
              scale_colour_manual(labels = c("Muestra", "Censo"),
                                 values = c("LINE1" = "blue", "LINE2" = "red")) +
               scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
                scale_x_discrete(limits = nom_estados) + 
                 labs(title = "Población Total",
                      subtitle = "Comparativo muestra / microdatos",
                      y = "Población Total",
                      x = "", 
                      color = "", 
                      fill = "")

p
path = paste0(here::here(), "/Graficos/Pob_Total a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


### Lugar de nacimiento {.tabset .tabset-pills}

```{r}
P.Nacimiento <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 7, skipEmptyCols = TRUE,
                          sheet = "Lugar de Nacimiento")  %>%
                 filter(NOM_ENT %nin% "Total")
```


#### Residentes

```{r}
tabla <- P.Nacimiento %>%
          arrange(Residentes) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Residentes, color = "LINE1")) +
        geom_ribbon(aes(ymin = Residentes_low, ymax = Residentes_upp), alpha = 0.2) + 
         geom_line(aes(y = Residentes_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
              scale_colour_manual(labels = c("Muestra", "Censo"),
                                 values = c("LINE1" = "blue", "LINE2" = "red")) +
               scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
                scale_x_discrete(limits = nom_ent) + 
                 labs(title = "Migración para toda la vida",
                      subtitle = "Residentes en el estado",
                      y = "",
                      x = "", 
                      color = "", 
                      fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Residentes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

#### Inmigrantes

```{r}
tabla <- P.Nacimiento %>%
          arrange(Inmigrantes) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Inmigrantes, color = "LINE1")) +
        geom_ribbon(aes(ymin = Inmigrantes_low, ymax = Inmigrantes_upp), alpha = 0.2) + 
         geom_line(aes(y = Inmigrantes_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
              scale_colour_manual(labels = c("Muestra", "Censo"),
                                 values = c("LINE1" = "blue", "LINE2" = "red")) +
               scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
                scale_x_discrete(limits = nom_ent) + 
                 labs(title = "Migración para toda la vida",
                      subtitle = "Nacidos en otro estado (Inmigrantes)",
                      y = "",
                      x = "", 
                      color = "", 
                      fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Inmigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")           
```



#### Emigrantes

```{r}
tabla <- P.Nacimiento %>%
          arrange(Emigrantes) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Emigrantes, color = "LINE1")) +
        geom_ribbon(aes(ymin = Emigrantes_low, ymax = Emigrantes_upp), alpha = 0.2) + 
         geom_line(aes(y = Emigrantes_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
              scale_colour_manual(labels = c("Muestra", "Censo"),
                                 values = c("LINE1" = "blue", "LINE2" = "red")) +
               scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
                scale_x_discrete(limits = nom_ent) + 
                 labs(title = "Migración para toda la vida",
                      subtitle = "Nacidos en otro estado (Emigrantes)",
                      y = "",
                      x = "", 
                      color = "", 
                      fill = "")
p
path = paste0(here::here(), "/Graficos/MNAC (Emigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

#### Tasa de Inmigrantes

```{r}
T.MNac <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                    sheet = "T. MNac") %>%
                     filter(NOM_ENT %nin% "Total")
```


```{r}
tabla <- T.MNac %>%
          arrange(Tasa_Inmigracion_Censo) %>%
           mutate(diff = abs(Tasa_Inmigracion_Censo - Tasa_Inmigracion)) %>%
            droplevels()  

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_text(aes(y = -90, label = round(Tasa_Inmigracion, 1)), 
                  size = 2, 
                   angle = 45, 
                    family = "Montserrat Medium",
                     color = "#9C4F86") +
        geom_text(aes(y = -190, label = round(Tasa_Inmigracion_Censo, 1)), 
                   size = 2, 
                    angle = 45,
                     family = "Montserrat Medium",
                      color = "#4A44A2") +
         geom_text(aes(y = -420, label = round(diff, 1)), 
                   size = 2, 
                    angle = 45,
                     alpha = 1, 
                      family = "Montserrat Medium",
                       fontface = "bold",
                        colour = "#000000") + 
          geom_line(aes(y = Tasa_Inmigracion, color = "LINE1")) +
           geom_ribbon(aes(ymin = Tasa_Inmigracion_low, ymax = Tasa_Inmigracion_upp), alpha = 0.2) + 
            geom_line(aes(y = Tasa_Inmigracion_Censo, color = "LINE2")) + 
             theme_minimal() + 
              theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                    plot.title = element_text(family = "Montserrat Medium", size = 20), 
                    plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                    axis.text = element_text(family = "Montserrat Medium", size = 10), 
                    axis.title = element_text(family = "Montserrat Medium", size = 12),
                    axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                    legend.text = element_text(family = "Montserrat Medium"),
                    legend.title = element_text(family = "Montserrat Medium")) + 
               scale_colour_manual(labels = c("Muestra", "Censo"),
                                   values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
                scale_y_continuous(breaks = seq(0, 1500, 500),
                                   labels = scales::unit_format(unit = "", digits = 3)) + 
                 scale_x_discrete(limits = nom_ent) + 
                  labs(title = "Migración para toda la vida",
                       subtitle = "Tasa de inmigración por cada mil",
                       y = "",
                       x = "", 
                       color = "", 
                       fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Tasa de inmigracion) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


#### Tasa de Emigración

```{r}
tabla <- T.MNac %>%
          arrange(Tasa_Emigracion_Censo) %>%
           mutate(diff = abs(Tasa_Emigracion_Censo - Tasa_Emigracion)) %>%
            droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_text(aes(y = -90, label = round(Tasa_Emigracion, 1)), 
                  size = 2, 
                   angle = 45, 
                    family = "Montserrat Medium",
                     color = "#9C4F86") +
        geom_text(aes(y = -230, label = round(Tasa_Emigracion_Censo, 1)), 
                   size = 2, 
                    angle = 45,
                     family = "Montserrat Medium",
                      color = "#4A44A2") +
         geom_text(aes(y = -450, label = round(diff, 1)), 
                   size = 2, 
                    angle = 45,
                     alpha = 1, 
                      family = "Montserrat Medium",
                       fontface = "bold",
                        colour = "#000000") +
         geom_line(aes(y = Tasa_Emigracion, color = "LINE1")) +
          geom_ribbon(aes(ymin = Tasa_Emigracion_low, ymax = Tasa_Emigracion_upp), alpha = 0.2) + 
           geom_line(aes(y = Tasa_Emigracion_Censo, color = "LINE2")) + 
            theme_minimal() + 
             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                   plot.title = element_text(family = "Montserrat Medium", size = 20), 
                   plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                   axis.text = element_text(family = "Montserrat Medium", size = 10), 
                   axis.title = element_text(family = "Montserrat Medium", size = 12),
                   axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                   legend.text = element_text(family = "Montserrat Medium"),
                   legend.title = element_text(family = "Montserrat Medium")) + 
                scale_colour_manual(labels = c("Muestra", "Censo"),
                                    values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
                 scale_y_continuous(labels = scales::unit_format(unit = "", digits = 3)) + 
                  scale_x_discrete(limits = nom_ent) + 
                   labs(title = "Migración para toda la vida",
                        subtitle = "Tasa de emigración por cada mil",
                        y = "",
                        x = "", 
                        color = "", 
                        fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (Tasa de emigracion) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

#### Tasa de Migración Neta

```{r}
tabla <- T.MNac %>%
          arrange(TNM_Censo) %>%
           mutate(diff = abs(TNM_Censo - TNM)) %>%
            droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_text(aes(y = -2000, label = round(TNM, 1)), 
                  size = 2, 
                   angle = 45, 
                    family = "Montserrat Medium",
                     color = "#9C4F86") +
        geom_text(aes(y = -2200, label = round(TNM_Censo, 1)), 
                   size = 2, 
                    angle = 45,
                     family = "Montserrat Medium",
                      color = "#4A44A2") +
         geom_text(aes(y = -2500, label = round(diff, 1)), 
                   size = 2, 
                    angle = 45,
                     alpha = 1, 
                      family = "Montserrat Medium",
                       fontface = "bold",
                        colour = "#000000") +
         geom_line(aes(y = TNM, color = "LINE1")) +
          geom_ribbon(aes(ymin = TNM_low, ymax = TNM_upp), alpha = 0.2) + 
           geom_line(aes(y = TNM_Censo, color = "LINE2")) + 
            theme_minimal() + 
             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                   plot.title = element_text(family = "Montserrat Medium", size = 20), 
                   plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                   axis.text = element_text(family = "Montserrat Medium", size = 10), 
                   axis.title = element_text(family = "Montserrat Medium", size = 12),
                   axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                   legend.text = element_text(family = "Montserrat Medium"),
                   legend.title = element_text(family = "Montserrat Medium")) + 
               scale_colour_manual(labels = c("Muestra", "Censo"),
                                   values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
                scale_y_continuous(breaks = seq(-1500, 1500, 500),
                                   labels = scales::unit_format(unit = "", digits = 3)) + 
                  scale_x_discrete(limits = nom_ent) + 
                   labs(title = "Migración para toda la vida",
                        subtitle = "Tasa de Neta de Migración por cada mil",
                        y = "",
                        x = "", 
                        color = "", 
                        fill = "")

p
path = paste0(here::here(), "/Graficos/MNAC (TNM) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

### Migración reciente {.tabset .tabset-pills}

```{r}
P.Reciente <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 7, skipEmptyCols = TRUE,
                         sheet = "Lugar de residencia (Entidad)")  %>%
                 filter(NOM_ENT %nin% "Total")
```


#### Residentes

```{r}
tabla <- P.Reciente %>%
          arrange(Residentes) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Residentes, color = "LINE1")) +
        geom_ribbon(aes(ymin = Residentes_low, ymax = Residentes_upp), alpha = 0.2) + 
         geom_line(aes(y = Residentes_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
              scale_colour_manual(labels = c("Muestra", "Censo"),
                                  values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
               scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
                scale_x_discrete(limits = nom_ent) + 
                 labs(title = "Migración reciente",
                      subtitle = "Residentes en el estado",
                      y = "",
                      x = "", 
                      color = "", 
                      fill = "")

p
path = paste0(here::here(), "/Graficos/MR5a (Residentes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


#### Inmigrantes

```{r}
tabla <- P.Reciente %>%
          arrange(Inmigrantes) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Inmigrantes, color = "LINE1")) +
        geom_ribbon(aes(ymin = Inmigrantes_low, ymax = Inmigrantes_upp), alpha = 0.2) + 
         geom_line(aes(y = Inmigrantes_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
            scale_colour_manual(labels = c("Muestra", "Censo"),
                                values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
             scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
              scale_x_discrete(limits = nom_ent) + 
               labs(title = "Migración reciente",
                    subtitle = "Inmigrantes",
                    y = "",
                    x = "", 
                    color = "", 
                    fill = "")

p
path = paste0(here::here(), "/Graficos/MR5a (Inmigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")           
```



#### Emigrantes

```{r}
tabla <- P.Reciente %>%
          arrange(Emigrantes) %>%
           droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_line(aes(y = Emigrantes, color = "LINE1")) +
        geom_ribbon(aes(ymin = Emigrantes_low, ymax = Emigrantes_upp), alpha = 0.2) + 
         geom_line(aes(y = Emigrantes_Censo, color = "LINE2")) + 
          theme_minimal() + 
           theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                 plot.title = element_text(family = "Montserrat Medium", size = 20), 
                 plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                 axis.text = element_text(family = "Montserrat Medium", size = 10), 
                 axis.title = element_text(family = "Montserrat Medium", size = 12),
                 axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                 legend.text = element_text(family = "Montserrat Medium"),
                 legend.title = element_text(family = "Montserrat Medium")) + 
            scale_colour_manual(labels = c("Muestra", "Censo"),
                                values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
             scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6)) + 
              scale_x_discrete(limits = nom_ent) + 
               labs(title = "Migración reciente",
                    subtitle = "Emigrantes",
                    y = "",
                    x = "", 
                    color = "", 
                    fill = "")
p
path = paste0(here::here(), "/Graficos/MR5a (Emigrantes) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


```{r}
tabla <- P.Reciente %>%
          arrange(TInmigracion_Censo) %>%
           mutate(diff = abs(TInmigracion_Censo - TInmigracion)) %>%
            droplevels()  

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_text(aes(y = -1, label = round(TInmigracion, 1)), 
                  size = 2, 
                   angle = 45, 
                    family = "Montserrat Medium",
                     color = "#9C4F86") +
        geom_text(aes(y = -6, label = round(TInmigracion_Censo, 1)), 
                   size = 2, 
                    angle = 45,
                     family = "Montserrat Medium",
                      color = "#4A44A2") +
         geom_text(aes(y = -15, label = round(diff, 1)), 
                   size = 2, 
                    angle = 45,
                     alpha = 1, 
                      family = "Montserrat Medium",
                       fontface = "bold",
                        colour = "#000000") + 
          geom_line(aes(y = TInmigracion, color = "LINE1")) +
           geom_ribbon(aes(ymin = TInmigracion_low, ymax = TInmigracion_upp), alpha = 0.2) + 
            geom_line(aes(y = TInmigracion_Censo, color = "LINE2")) + 
             theme_minimal() + 
              theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                    plot.title = element_text(family = "Montserrat Medium", size = 20), 
                    plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                    axis.text = element_text(family = "Montserrat Medium", size = 10), 
                    axis.title = element_text(family = "Montserrat Medium", size = 12),
                    axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                    legend.text = element_text(family = "Montserrat Medium"),
                    legend.title = element_text(family = "Montserrat Medium")) + 
               scale_colour_manual(labels = c("Muestra", "Censo"),
                                   values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
                scale_y_continuous(breaks = seq(0, 1500, 500),
                                   labels = scales::unit_format(unit = "", digits = 3)) + 
                 scale_x_discrete(limits = nom_ent) + 
                  labs(title = "Migración reciente",
                       subtitle = "Tasa de inmigración por cada mil",
                       y = "",
                       x = "", 
                       color = "", 
                       fill = "")

p
path = paste0(here::here(), "/Graficos/MR5a (Tasa de inmigracion) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


#### Tasa de Emigración

```{r}
tabla <- P.Reciente %>%
          select(CVE_ENT, NOM_ENT, TEmigracion_Censo, TEmigracion, TEmigracion_low, TEmigracion_upp) %>%
           arrange(TEmigracion_Censo) %>%
            mutate(diff = abs(TEmigracion_Censo - TEmigracion)) %>%
             droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_text(aes(y = -3, label = round(TEmigracion, 1)), 
                  size = 2, 
                   angle = 45, 
                    family = "Montserrat Medium",
                     color = "#9C4F86") +
        geom_text(aes(y = -6, label = round(TEmigracion_Censo, 1)), 
                   size = 2, 
                    angle = 45,
                     family = "Montserrat Medium",
                      color = "#4A44A2") +
         geom_text(aes(y = -12, label = format(diff, digits = 1, nsmall = 1L)), 
                   size = 2, 
                    angle = 45,
                     alpha = 1, 
                      family = "Montserrat Medium",
                       fontface = "bold",
                        colour = "#000000") +
         geom_line(aes(y = TEmigracion, color = "LINE1")) +
          geom_ribbon(aes(ymin = TEmigracion_low, ymax = TEmigracion_upp), alpha = 0.2) + 
           geom_line(aes(y = TEmigracion_Censo, color = "LINE2")) + 
            theme_minimal() + 
             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                   plot.title = element_text(family = "Montserrat Medium", size = 20), 
                   plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                   axis.text = element_text(family = "Montserrat Medium", size = 10), 
                   axis.title = element_text(family = "Montserrat Medium", size = 12),
                   axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                   legend.text = element_text(family = "Montserrat Medium"),
                   legend.title = element_text(family = "Montserrat Medium")) + 
                scale_colour_manual(labels = c("Muestra", "Censo"),
                                    values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
                 scale_y_continuous(labels = scales::unit_format(unit = "", digits = 3)) + 
                  scale_x_discrete(limits = nom_ent) + 
                   labs(title = "Migración reciente",
                        subtitle = "Tasa de emigración por cada mil",
                        y = "",
                        x = "", 
                        color = "", 
                        fill = "")

p
path = paste0(here::here(), "/Graficos/MR5a (Tasa de emigracion) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

#### Tasa de Migración Neta

```{r}
tabla <- P.Reciente %>%
          select(CVE_ENT, NOM_ENT, TNM_Censo, TNM, TNM_low, TNM_upp) %>%
           arrange(TNM_Censo) %>%
            mutate(diff = abs(TNM_Censo - TNM)) %>%
             droplevels() 

ent <- tabla %>% pull(CVE_ENT)
nom_ent <- tabla %>% pull(NOM_ENT)

p <- tabla %>%
      ggplot(aes(x = order(factor(CVE_ENT, levels = ent)))) + 
       geom_text(aes(y = -50, label = round(TNM, 1)), 
                  size = 2, 
                   angle = 45, 
                    family = "Montserrat Medium",
                     color = "#9C4F86") +
        geom_text(aes(y = -55, label = round(TNM_Censo, 1)), 
                   size = 2, 
                    angle = 45,
                     family = "Montserrat Medium",
                      color = "#4A44A2") +
         geom_text(aes(y = -65, label = round(diff, 1)), 
                   size = 2, 
                    angle = 45,
                     alpha = 1, 
                      family = "Montserrat Medium",
                       fontface = "bold",
                        colour = "#000000") +
         geom_line(aes(y = TNM, color = "LINE1")) +
          geom_ribbon(aes(ymin = TNM_low, ymax = TNM_upp), alpha = 0.2) + 
           geom_line(aes(y = TNM_Censo, color = "LINE2")) + 
            theme_minimal() + 
             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                   plot.title = element_text(family = "Montserrat Medium", size = 20), 
                   plot.subtitle = element_text(family = "Montserrat Medium", size = 15), 
                   axis.text = element_text(family = "Montserrat Medium", size = 10), 
                   axis.title = element_text(family = "Montserrat Medium", size = 12),
                   axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                   legend.text = element_text(family = "Montserrat Medium"),
                   legend.title = element_text(family = "Montserrat Medium")) + 
               scale_colour_manual(labels = c("Muestra", "Censo"),
                                   values = c("LINE1" = "#9F0C74", "LINE2" = "#0F0978")) +
                scale_y_continuous(
                                   #breaks = seq(-200, 1500, 500),
                                   labels = scales::unit_format(unit = "", digits = 3)) + 
                  scale_x_discrete(limits = nom_ent) + 
                   labs(title = "Migración reciente",
                        subtitle = "Tasa de Neta de Migración por cada mil",
                        y = "",
                        x = "", 
                        color = "", 
                        fill = "")

p
path = paste0(here::here(), "/Graficos/MR5a (TNM) a nivel estatal.pdf") 
ggexport(p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

## Nivel municipal {.tabset .tabset-pills}

### Población total

Se excluyen a los municipios no muestreados

```{r}
Pob.Total <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 6, skipEmptyCols = TRUE,
                        sheet = "Población Total (Municipio)") %>%
              filter(CVE_MUN != "Total") %>%
               na.omit()
```



```{r}
tabla <- Pob.Total %>%
          arrange(Pob.Total) %>%
           droplevels() %>%
            mutate(CV = .$Pob.Total_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = Pob.Total, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = Pob.Total_low, ymax = Pob.Total_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = Pob.Total_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                            theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Población Total",
                                                                  subtitle = paste(Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/Pob_Total a nivel municipal.pdf") 
ggexport(list = p, width = 9, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


### Migración reciente {.tabset .tabset-pills}

#### Residentes

```{r}
Pob.Total <- read.xlsx(paste0(here::here(), "/Output/Indicadores de migracion interna 2020.xlsx"), startRow = 8, skipEmptyCols = TRUE,
                        sheet = "Lugar de residencia (Municipio)") %>%
              filter(CVE_MUN != "Total")
```



```{r}
tabla <- Pob.Total %>%
          arrange(Residentes) %>%
           droplevels() %>%
            mutate(CV = .$Residentes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = Residentes, 
                                                                      color = CV_Grado, 
                                                                      size = "size1")) +
                                                         geom_ribbon(aes(ymin = Residentes_low, 
                                                                         ymax = Residentes_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = Residentes_Censo, 
                                                                        size = "size2"), 
                                                                     color = "#A1A1A1", 
                                                                      linetype = 1) + 
                                                           theme_minimal() + 
                                                            theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Residentes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Residentes) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, NOM_MUN, MUN_Muestra, TAM_MUN, Residentes_Censo, Residentes, Residentes_se, Residentes_cv, Residentes_low, Residentes_upp) %>%
           arrange(Residentes) %>%
            droplevels() %>%
             mutate(CV = .$Residentes_cv * 100) %>% 
              mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                          .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                          .$CV >= 30 ~ "Baja")) %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja"))) 

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)


#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 
## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
Grados[2]
Zcal <- c(0.05, 0.3, 0.15)  #70% 70% 70%   #Baja #Alta  #Moderada

for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 0, 100,
               ifelse(n == 62, 20000,
                ifelse(n == 701, 70000,
                 ifelse(n == 917, 30000,
                        100
               ))))
     
     ## Direction 
     direction = ifelse(n < 0, "y",
                  ifelse(n == 917, "both",
                         "y"))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n < 0, -10, -50 )
     
     nudge_y_censo = ifelse(n < 0, 10, 50 )
       
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 0, NA, NA)
     
     ylim_max_muestra = ifelse(n < 0, NA, NA)
     
     ylim_min_censo = ifelse(n < 0, NA, NA)
     
     ylim_max_censo = ifelse(n < 0, NA, NA)
    
    tabla1 <- tabla %>%
               filter(MUN_Muestra %in% Muestra[i]) %>% 
                filter(CV_Grado %in% Grados[j]) %>%
                 mutate(Diff = abs(Residentes_Censo - Residentes),
                        limite = case_when(.$Residentes_Censo <= (.$Residentes - Zcal[j] * .$Residentes_se) ~ 1,
                                           .$Residentes_Censo >= (.$Residentes + Zcal[j] * .$Residentes_se) ~ 1, 
                                           TRUE ~ NA)) %>%
                  arrange(desc(Diff)) %>% 
                   mutate(n = 1:n()) %>%
                    arrange(Residentes) %>% 
                     mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$Residentes,
                                                         nrow(.) > 40 & .$limite %in% 1 & .$n < 30 ~ .$Residentes),
                            Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$Residentes_Censo,
                                                       nrow(.) > 40 & .$limite %in% 1 & .$n < 30 ~ .$Residentes_Censo), 
                            limite_muestra = case_when(.$Residentes_low >= .$Residentes_Censo ~ .$Residentes_Censo - .$Residentes_Censo/50,
                                                       .$Residentes_low < .$Residentes_Censo ~ .$Residentes_low - .$Residentes_low/50),
                            limite_censo = case_when(.$Residentes_upp < .$Residentes_Censo ~ .$Residentes_Censo + .$Residentes_Censo/50,
                                                     .$Residentes_upp >= .$Residentes_Censo ~ .$Residentes_upp + .$Residentes_upp/50)) 
  
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla1 %>%
                                                     ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                      geom_line(aes(y = Residentes, color = CV_Grado, size = "size1")) +
                                                       geom_ribbon(aes(ymin = Residentes_low, ymax = Residentes_upp, 
                                                                       color = CV_Grado, 
                                                                       fill = CV_Grado), alpha = 0.2) + 
                                                        geom_line(aes(y = Residentes_Censo, size = "size2"), 
                                                                   color = "#A1A1A1", 
                                                                    linetype = 1) + 
                                                         geom_text_repel(aes(y = limite_muestra, 
                                                                             label = round(Etiqueta_Muestra, 1)), 
                                                                         #position = position_jitter(seed = 123),
                                                                         hjust = 1.5,
                                                                         force = 0.2,
                                                                         size = 2, 
                                                                         angle = 90,
                                                                         direction = direction,
                                                                         #nudge_y = nudge_y_muestra,
                                                                         ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                         min.segment.length = 0.01,
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j], 
                                                                         family = "Montserrat Medium",
                                                                         color = lineas[j]) +
                                                         geom_text_repel(aes(y = limite_censo, 
                                                                             label = round(Etiqueta_Censo, 1)), 
                                                                         #position = position_jitter(seed = 123),
                                                                         size = 2, 
                                                                         hjust = -1.5,
                                                                         force = 1,
                                                                         angle = 90,
                                                                         direction = direction,
                                                                         min.segment.length = 0.1,
                                                                         #nudge_y = nudge_y_muestra,
                                                                         ylim = c(ylim_min_censo, ylim_max_censo),
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j],
                                                                         family = "Montserrat Medium",
                                                                         color = "#A1A1A1") +
                                                          theme + 
                                                           guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                            scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                             scale_color_manual(values = colores[j]) +  
                                                              scale_fill_manual(values = lineas[j]) +  
                                                               scale_y_continuous(limits = c(min(tabla1$Residentes_low, tabla1$Residentes_Censo) - x_lim, max(tabla1$Residentes_upp, tabla1$Residentes_Censo) + x_lim),
                                                                                  labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                 labs(title = "Migración reciente",
                                                                      subtitle = paste("Residentes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                      y = "",
                                                                      x = paste(n, "municipios"), 
                                                                      size = "",
                                                                      color = "", 
                                                                      fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Residentes) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, Residentes, Residentes_Censo, Residentes_cv, Residentes_low, Residentes_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(Residentes) %>%
            mutate(CV = .$Residentes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))

table(tabla$TAM_MUN)
table(tabla$MUN_Muestra, tabla$CV_Grado, tabla$TAM_MUN)
table(tabla$MUN_Muestra)
mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)


#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 


## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2) {
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = Residentes, 
                                                                                        color = TAM_MUN),
                                                                                          size = 2) + 
                                                                          geom_ribbon(aes(ymin = Residentes_low, 
                                                                                          ymax = Residentes_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = Residentes_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") + 
                                                                            theme +
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    # scale_x_discrete(limits = nom_estados) + 
                                                                                     labs(title = "Migración reciente",
                                                                                          subtitle = paste("Residentes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                          y = "",
                                                                                          x = paste(n, "municipios"), 
                                                                                          size = "",
                                                                                          color = "", 
                                                                                          fill = "")  
     } else { 
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                           ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                            geom_line(aes(y = Residentes, 
                                                                                          color = TAM_MUN, 
                                                                                          size = "size1")) + 
                                                                             geom_ribbon(aes(ymin = Residentes_low, 
                                                                                             ymax = Residentes_upp, 
                                                                                             color = TAM_MUN,
                                                                                             fill = TAM_MUN), 
                                                                                         alpha = 0.2) + 
                                                                               geom_line(aes(y = Residentes_Censo, 
                                                                                             size = "size2"), 
                                                                                          color = "#A1A1A1", 
                                                                                           linetype = 1) + 
                                                                                theme + 
                                                                                 guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    # scale_x_discrete(limits = nom_estados) + 
                                                                                     labs(title = "Migración reciente",
                                                                                          subtitle = paste("Residentes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                          y = "",
                                                                                          x = paste(n, "municipios"), 
                                                                                          size = "",
                                                                                          color = "", 
                                                                                          fill = "") 
      }
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Residentes) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**

```{r}
tail(p[["Municipio muestreado"]][["Moderada"]][["50 000-99 999 habitantes"]][["data"]])
```

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, Residentes, Residentes_Censo, Residentes_se, Residentes_cv, Residentes_low, Residentes_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(Residentes) %>%
            mutate(CV = .$Residentes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#8F8F8F", size = 0.02),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
Zcal <- c(0.005, 0.5, 0.15)  #70% 70% 70%   #Baja #Alta  #Moderada
#Grados[2] #Moderada
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                filter(MUN_Muestra %in% Muestra[i]) %>% 
                 filter(CV_Grado %in% Grados[j]) %>% 
                  filter(TAM_MUN %in% TAM[k]) %>%
                   mutate(Diff = abs(Residentes_Censo - Residentes),
                          limite = case_when(.$Residentes_Censo >= (.$Residentes - Zcal[j] * .$Residentes_se) ~ 1,
                                             .$Residentes_Censo <= (.$Residentes + Zcal[j] * .$Residentes_se) ~ 1, 
                                             TRUE ~ NA)) %>%
                    arrange(desc(Diff))
     
     casos <- tabla1 %>%
               slice(1:20) %>%
                pull(CVE_MUN)
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 30, 250, 
               ifelse(n >= 30 & n < 100, 550, 
                ifelse(n >= 100 & n < 200, 700, 
                 ifelse(n >= 200 & n < 500, 800, 
                  ifelse(n >= 500, 1000, 
                         100 #Other cases
                         )))))
     
      ## Direction 
     direction = ifelse(n < 0, "y",
                  ifelse(n == 191, "both",
                   ifelse(n == 917, "both",
                          "y")))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n >= 40 & n < 100, -6, 
                        ifelse(n >= 100 & n < 200, -70,
                         ifelse (n >= 200 & n < 300, -80, 
                          ifelse(n >= 300, -90, 
                                  -5 #Other cases
                                  ))))
     
     nudge_y_censo = ifelse(n < 40, 0, 
                      ifelse(n >= 40 & n < 100, 8, 
                       ifelse(n >= 100, 15, 
                              5 #Other cases
                              )))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n > 0, NA, 
                         ifelse(n == 112, -1 * min(tabla1$Residentes_low, tabla1$Residentes_Censo) - 200,
                          ifelse(n == 169, -1 * min(tabla1$Residentes_low, tabla1$Residentes_Censo) - 7100,
                                 NA)))
     
     ylim_max_muestra = ifelse(n > 0,  NA, NA)
     
     ylim_min_censo = ifelse(n > 0,  min(tabla1$Residentes_upp, tabla1$Residentes_Censo),
                             NA)
     
     ylim_max_censo = ifelse(n > 0, max(tabla1$Residentes_upp, tabla1$Residentes_Censo),
                             NA)
    
     if(n %in% c(0, 1)){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = Residentes, 
                                                                                        color = TAM_MUN),
                                                                                     size = 2) + 
                                                                          geom_ribbon(aes(ymin = Residentes_low, 
                                                                                          ymax = Residentes_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = Residentes_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") +
                                                                            geom_text_repel(aes(y = Residentes, 
                                                                                                label = round(Residentes, 1)), 
                                                                                            hjust = -1.5,
                                                                                            force = 1,
                                                                                            size = 3, 
                                                                                            angle = 45,
                                                                                            direction = "y",
                                                                                            min.segment.length = 0.01,
                                                                                            segment.size = 0.02,
                                                                                            segment.colour = lineas[k], 
                                                                                            family = "Montserrat Medium",
                                                                                            color = lineas[k]) +
                                                                             geom_text_repel(aes(y = Residentes_Censo, 
                                                                                                label = round(Residentes_Censo, 1)), 
                                                                                             hjust = 1.5,
                                                                                             force = 1,
                                                                                             size = 3, 
                                                                                             angle = 45,
                                                                                             direction = direction,
                                                                                             min.segment.length = 0.01,
                                                                                             segment.size = 0.02,
                                                                                             segment.colour = "#BABABA",
                                                                                             family = "Montserrat Medium", 
                                                                                             color = "#000000") +
                                                                              theme +
                                                                               guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                 scale_color_manual(values = colores[k]) +  
                                                                                  scale_fill_manual(values = lineas[k]) +  
                                                                                   scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    labs(title = "Migración reciente",
                                                                                         subtitle = paste("Residentes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                         y = "",
                                                                                         x = paste(n, "municipios"), 
                                                                                         size = "",
                                                                                         color = "", 
                                                                                         fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       arrange(Residentes) %>%
                                                                        mutate(Etiqueta_Muestra = case_when(nrow(.) <= 30 ~ .$Residentes,
                                                                                                            nrow(.) > 30 &  .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$Residentes),
                                                                               Etiqueta_Censo = case_when(nrow(.) <= 30 ~ .$Residentes_Censo,
                                                                                                          nrow(.) > 30 & .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$Residentes_Censo), 
                                                                               limite_muestra = case_when(.$Residentes_low >= .$Residentes_Censo ~ .$Residentes_Censo - .$Residentes_Censo/50,
                                                                                                          .$Residentes_low < .$Residentes_Censo ~ .$Residentes_low - .$Residentes_low/50),
                                                                               limite_censo = case_when(.$Residentes_upp < .$Residentes_Censo ~ .$Residentes_Censo + .$Residentes_Censo/50,
                                                                                                        .$Residentes_upp >= .$Residentes_Censo ~ .$Residentes_upp + .$Residentes_upp/50)) %>% 
                                                                         ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                          geom_line(aes(y = Residentes, 
                                                                                        color = TAM_MUN, 
                                                                                        size = "size1")) + 
                                                                           geom_ribbon(aes(ymin = Residentes_low, 
                                                                                           ymax = Residentes_upp, 
                                                                                           color = TAM_MUN,
                                                                                           fill = TAM_MUN), 
                                                                                        alpha = 0.2) + 
                                                                             geom_line(aes(y = Residentes_Censo, 
                                                                                           size = "size2"), 
                                                                                           color = "#A1A1A1", 
                                                                                       linetype = 1) + 
                                                                              geom_text_repel(aes(y = limite_muestra, 
                                                                                                  label = ifelse(is.na(Etiqueta_Muestra), "", format(Etiqueta_Muestra, sep = " ", big.mark = " "))), 
                                                                                              hjust = 1.5,
                                                                                              force = 1,
                                                                                              size = 2, 
                                                                                              angle = 90,
                                                                                              direction = direction,
                                                                                              min.segment.length = 0.01,
                                                                                              #position = position_jitter(seed = 123),
                                                                                              nudge_y = nudge_y_muestra,
                                                                                              ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = lineas[k], 
                                                                                              family = "Montserrat Medium",
                                                                                              color = lineas[k],
                                                                                              na.rm = TRUE) +
                                                                              geom_text_repel(aes(y = limite_censo, 
                                                                                                  label = ifelse(is.na(Etiqueta_Censo), "", format(Etiqueta_Censo, sep = " ", big.mark = " "))), 
                                                                                              size = 2, 
                                                                                              hjust = -1.5,
                                                                                              force = 1,
                                                                                              angle = 90,
                                                                                              direction = direction,
                                                                                              min.segment.length = 0.01,
                                                                                              #position = position_jitter(seed = 123),
                                                                                              nudge_y = nudge_y_censo,
                                                                                              ylim = c(ylim_min_censo, ylim_max_censo),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = "#BABABA",
                                                                                              family = "Montserrat Medium", 
                                                                                              color = "#000000",
                                                                                              na.rm = TRUE) +
                                                                               theme +
                                                                                guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                 scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                  scale_color_manual(values = colores[k]) +  
                                                                                   scale_fill_manual(values = lineas[k]) +  
                                                                                    scale_y_continuous(limits = c(min(tabla1$Residentes_low, tabla1$Residentes_Censo) - x_lim, max(tabla1$Residentes_upp, tabla1$Residentes_Censo) + x_lim),
                                                                                                       labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                     scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Residentes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
#path = paste0(here::here(), "/Graficos/MR5a (Residentes) a nivel municipal_Tamaño de municipio.pdf") 
#ggexport(list = p, width = 12, height = 8, dpi = 400, filename = path, device = "cairo_pdf")      
``` 


#### Inmigrantes

```{r}
tabla <- Pob.Total %>%
          arrange(Inmigrantes) %>%
           droplevels() %>%
            mutate(CV = .$Inmigrantes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = Inmigrantes, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = Inmigrantes_low, ymax = Inmigrantes_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = Inmigrantes_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Inmigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Inmigrantes) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, NOM_MUN, MUN_Muestra, TAM_MUN, Inmigrantes_Censo, Inmigrantes, Inmigrantes_se, Inmigrantes_cv, Inmigrantes_low, Inmigrantes_upp) %>%
           arrange(Inmigrantes) %>%
            droplevels() %>%
             mutate(CV = .$Inmigrantes_cv * 100) %>% 
              mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                          .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                          .$CV >= 30 ~ "Baja")) %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja"))) 

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)


#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 
## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
Grados[2]
Zcal <- c(0.524, 1.9, 1.64)  #70% 70% 70%

for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 0, 100,
               ifelse(n == 215, 10000,
                ifelse(n == 283, 7000,
                 ifelse(n == 1182, 20000,
                        100
               ))))
     
     ## Direction 
     direction = ifelse(n < 0, "y",
                  ifelse(n == 215 | n == 283 | n == 1182,"both",
                          "y"))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n < 100, -10, 
                        ifelse(n >= 200 & n < 250, -20,
                         ifelse(n >= 250  & n < 500, -25,
                          ifelse(n >= 500, -10, 
                                  50 #Other cases
                                  ))))
     
     nudge_y_censo = ifelse(n < 200, 15, 
                      ifelse(n >= 200 & n < 250, 25,
                       ifelse(n >= 250  & n < 500, 35,
                        ifelse(n >= 500, 100, 
                               50 #Other cases
                               ))))
       
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 0, NA,
                         ifelse(n == 215, -1 * min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 800,
                          ifelse(n == 283, -1 * min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 160,
                           ifelse(n == 1182, -1 * min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 10,
                                  NA
                                  ))))
     
     ylim_max_muestra = ifelse(n < 0, NA,
                         ifelse(n == 215, -1 * max(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 10000,
                          ifelse(n == 283, -1 * min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 250,
                           ifelse(n == 1182, -1 * max(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 1000,
                                  NA))))
     
     ylim_min_censo = ifelse(n < 0, NA,
                       ifelse(n == 215, min(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + 80,
                        ifelse(n == 283, min(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + 20,
                               NA)))
     
     ylim_max_censo = ifelse(n < 0, NA,
                       ifelse(n == 1182, max(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + 1200,
                              NA))
    
    tabla1 <- tabla %>%
               filter(MUN_Muestra %in% Muestra[i]) %>% 
                filter(CV_Grado %in% Grados[j]) %>%
                 mutate(Diff = abs(Inmigrantes_Censo - Inmigrantes),
                        limite = case_when(.$Inmigrantes_Censo <= (.$Inmigrantes - Zcal[j] * .$Inmigrantes_se) ~ 1,
                                           .$Inmigrantes_Censo >= (.$Inmigrantes + Zcal[j] * .$Inmigrantes_se) ~ 1, 
                                           TRUE ~ NA)) %>%
                  arrange(desc(Diff)) %>% 
                   mutate(n = 1:n()) %>%
                    arrange(Inmigrantes) %>% 
                     mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$Inmigrantes,
                                                         nrow(.) > 40 & .$limite %in% 1 & .$n < 30 ~ .$Inmigrantes),
                            Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$Inmigrantes_Censo,
                                                       nrow(.) > 40 & .$limite %in% 1 & .$n < 30 ~ .$Inmigrantes_Censo), 
                            limite_muestra = case_when(.$Inmigrantes_low >= .$Inmigrantes_Censo ~ .$Inmigrantes_Censo - .$Inmigrantes_Censo/50,
                                                       .$Inmigrantes_low < .$Inmigrantes_Censo ~ .$Inmigrantes_low - .$Inmigrantes_low/50),
                            limite_censo = case_when(.$Inmigrantes_upp < .$Inmigrantes_Censo ~ .$Inmigrantes_Censo + .$Inmigrantes_Censo/50,
                                                     .$Inmigrantes_upp >= .$Inmigrantes_Censo ~ .$Inmigrantes_upp + .$Inmigrantes_upp/50)) 
  
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla1 %>%
                                                     ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                      geom_line(aes(y = Inmigrantes, color = CV_Grado, size = "size1")) +
                                                       geom_ribbon(aes(ymin = Inmigrantes_low, ymax = Inmigrantes_upp, 
                                                                       color = CV_Grado, 
                                                                       fill = CV_Grado), alpha = 0.2) + 
                                                        geom_line(aes(y = Inmigrantes_Censo, size = "size2"), 
                                                                   color = "#A1A1A1", 
                                                                    linetype = 1) + 
                                                         geom_text_repel(aes(y = limite_muestra, 
                                                                             label = round(Etiqueta_Muestra, 1)), 
                                                                         position = position_jitter(seed = 12),
                                                                         hjust = 1.5,
                                                                         force = 0.2,
                                                                         size = 2, 
                                                                         angle = 90,
                                                                         direction = direction,
                                                                         #nudge_y = nudge_y_muestra,
                                                                         ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                         min.segment.length = 0.01,
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j], 
                                                                         family = "Montserrat Medium",
                                                                         color = lineas[j]) +
                                                         geom_text_repel(aes(y = limite_censo, 
                                                                             label = round(Etiqueta_Censo, 1)), 
                                                                         position = position_jitter(seed = 12),
                                                                         size = 2, 
                                                                         hjust = -1.5,
                                                                         force = 1,
                                                                         angle = 90,
                                                                         direction = direction,
                                                                         min.segment.length = 0.1,
                                                                         #nudge_y = nudge_y_muestra,
                                                                         ylim = c(ylim_min_censo, ylim_max_censo),
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j],
                                                                         family = "Montserrat Medium",
                                                                         color = "#A1A1A1") +
                                                          theme + 
                                                           guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                            scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                             scale_color_manual(values = colores[j]) +  
                                                              scale_fill_manual(values = lineas[j]) +  
                                                               scale_y_continuous(limits = c(min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - x_lim, max(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + x_lim),
                                                                                  labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                 labs(title = "Migración reciente",
                                                                      subtitle = paste("Inmigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                      y = "",
                                                                      x = paste(n, "municipios"), 
                                                                      size = "",
                                                                      color = "", 
                                                                      fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Inmigrantes) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, Inmigrantes, Inmigrantes_Censo, Inmigrantes_cv, Inmigrantes_low, Inmigrantes_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(Inmigrantes) %>%
            mutate(CV = .$Inmigrantes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))

mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2) {
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = Inmigrantes, 
                                                                                        color = TAM_MUN),
                                                                                          size = 2) + 
                                                                          geom_ribbon(aes(ymin = Inmigrantes_low, 
                                                                                          ymax = Inmigrantes_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = Inmigrantes_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") + 
                                                                            theme +
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                               scale_color_manual(values = colores[k]) +  
                                                                                scale_fill_manual(values = lineas[k]) +  
                                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                # scale_x_discrete(limits = nom_estados) + 
                                                                                 labs(title = "Migración reciente",
                                                                                      subtitle = paste("Inmigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                      y = "",
                                                                                      x = paste(n, "municipios"), 
                                                                                      size = "",
                                                                                      color = "", 
                                                                                      fill = "")  
     } else {  
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                           ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                            geom_line(aes(y = Inmigrantes, 
                                                                                          color = TAM_MUN, 
                                                                                          size = "size1")) + 
                                                                             geom_ribbon(aes(ymin = Inmigrantes_low, 
                                                                                             ymax = Inmigrantes_upp, 
                                                                                             color = TAM_MUN,
                                                                                             fill = TAM_MUN), 
                                                                                         alpha = 0.2) + 
                                                                               geom_line(aes(y = Inmigrantes_Censo, 
                                                                                             size = "size2"), 
                                                                                          color = "#A1A1A1", 
                                                                                           linetype = 1) + 
                                                                                theme + 
                                                                                 guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                  # scale_x_discrete(limits = nom_estados) + 
                                                                                     labs(title = "Migración reciente",
                                                                                          subtitle = paste("Inmigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                          y = "",
                                                                                          x = paste(n, "municipios"), 
                                                                                          size = "",
                                                                                          color = "", 
                                                                                          fill = "") 
      }
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Inmigrantes) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, Inmigrantes, Inmigrantes_Censo, Inmigrantes_se, Inmigrantes_cv, Inmigrantes_low, Inmigrantes_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(Inmigrantes) %>%
            mutate(CV = .$Inmigrantes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#8F8F8F", size = 0.02),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
Zcal <- c(0.724, 1.3, 1.44)  #70% 70% 70% 
#Grados[2] #Moderada
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                filter(MUN_Muestra %in% Muestra[i]) %>% 
                 filter(CV_Grado %in% Grados[j]) %>% 
                  filter(TAM_MUN %in% TAM[k]) %>%
                   mutate(Diff = abs(Inmigrantes_Censo - Inmigrantes),
                          limite = case_when(.$Inmigrantes_Censo <= (.$Inmigrantes - Zcal[j] * .$Inmigrantes_se) ~ 1,
                                             .$Inmigrantes_Censo >= (.$Inmigrantes + Zcal[j] * .$Inmigrantes_se) ~ 1, 
                                             TRUE ~ NA)) %>%
                    arrange(limite, desc(Diff))
     
     casos <- tabla1 %>%
               slice(1:30) %>%
                pull(CVE_MUN)
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 30, 60, 
               ifelse(n >= 30 & n < 100, 130, 
                ifelse(n >= 100 & n < 200, 300, 
                 ifelse(n >= 200 & n < 500, 350, 
                  ifelse(n >= 500, 1000, 
                         100 #Other cases
                         )))))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n >= 40 & n < 100, -6, 
                        ifelse(n >= 100 & n < 200, -70,
                         ifelse (n >= 200 & n < 300, -80, 
                          ifelse(n >= 300, -90, 
                                  -5 #Other cases
                                  ))))
     
     nudge_y_censo = ifelse(n < 40, 0, 
                      ifelse(n >= 40 & n < 100, 8, 
                       ifelse(n >= 100, 15, 
                              5 #Other cases
                              )))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n > 0, NA, 
                         ifelse(n == 91, -1 * min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 100,
                          ifelse(n == 119 | n == 145, -1 * min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - 50,
                                 NA
                                 )))
     
     ylim_max_muestra = ifelse(n > 0,  NA, 
                               NA
                             )
     
     ylim_min_censo = ifelse(n > 0, NA,
                       ifelse(n == 91 | n == 145, min(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + 50,
                              NA
                             ))
     
     ylim_max_censo = ifelse(n > 0, NA,
                       ifelse(n == 91, max(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + 120,
                              NA
                              ))
      
     if(n %in% c(0, 1)){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = Inmigrantes, 
                                                                                        color = TAM_MUN),
                                                                                     size = 2) + 
                                                                          geom_ribbon(aes(ymin = Inmigrantes_low, 
                                                                                          ymax = Inmigrantes_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = Inmigrantes_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") +
                                                                            geom_text_repel(aes(y = Inmigrantes, 
                                                                                                label = round(Inmigrantes, 1)), 
                                                                                            hjust = 1.5,
                                                                                            force = 1,
                                                                                            size = 3, 
                                                                                            angle = 45,
                                                                                            direction = "y",
                                                                                            min.segment.length = 0.01,
                                                                                            segment.size = 0.02,
                                                                                            segment.colour = lineas[k], 
                                                                                            family = "Montserrat Medium",
                                                                                            color = lineas[k]) +
                                                                             geom_text_repel(aes(y = Inmigrantes_Censo, 
                                                                                                label = round(Inmigrantes_Censo, 1)), 
                                                                                             hjust = 1.5,
                                                                                             force = 1,
                                                                                             size = 3, 
                                                                                             angle = 45,
                                                                                             direction = "y",
                                                                                             min.segment.length = 0.01,
                                                                                             segment.size = 0.02,
                                                                                             segment.colour = "#BABABA",
                                                                                             family = "Montserrat Medium", 
                                                                                             color = "#000000") +
                                                                              theme +
                                                                               guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                 scale_color_manual(values = colores[k]) +  
                                                                                  scale_fill_manual(values = lineas[k]) +  
                                                                                   scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    labs(title = "Migración reciente",
                                                                                         subtitle = paste("Inmigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                         y = "",
                                                                                         x = paste(n, "municipios"), 
                                                                                         size = "",
                                                                                         color = "", 
                                                                                         fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       arrange(Inmigrantes) %>%
                                                                        mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$Inmigrantes,
                                                                                                            nrow(.) > 40 &  .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$Inmigrantes),
                                                                               Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$Inmigrantes_Censo,
                                                                                                          nrow(.) > 40 & .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$Inmigrantes_Censo), 
                                                                               limite_muestra = case_when(.$Inmigrantes_low >= .$Inmigrantes_Censo ~ .$Inmigrantes_Censo - .$Inmigrantes_Censo/50,
                                                                                                          .$Inmigrantes_low < .$Inmigrantes_Censo ~ .$Inmigrantes_low - .$Inmigrantes_low/50),
                                                                               limite_censo = case_when(.$Inmigrantes_upp < .$Inmigrantes_Censo ~ .$Inmigrantes_Censo + .$Inmigrantes_Censo/50,
                                                                                                        .$Inmigrantes_upp >= .$Inmigrantes_Censo ~ .$Inmigrantes_upp + .$Inmigrantes_upp/50)) %>% 
                                                                         ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                          geom_line(aes(y = Inmigrantes, 
                                                                                        color = TAM_MUN, 
                                                                                        size = "size1")) + 
                                                                           geom_ribbon(aes(ymin = Inmigrantes_low, 
                                                                                           ymax = Inmigrantes_upp, 
                                                                                           color = TAM_MUN,
                                                                                           fill = TAM_MUN), 
                                                                                        alpha = 0.2) + 
                                                                             geom_line(aes(y = Inmigrantes_Censo, 
                                                                                           size = "size2"), 
                                                                                           color = "#A1A1A1", 
                                                                                       linetype = 1) + 
                                                                              geom_text_repel(aes(y = limite_muestra, 
                                                                                                  label = ifelse(is.na(Etiqueta_Muestra), "", format(Etiqueta_Muestra, sep = " ", big.mark = " "))), 
                                                                                              hjust = 1.5,
                                                                                              force = 1,
                                                                                              size = 2, 
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              nudge_y = nudge_y_muestra,
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = lineas[k], 
                                                                                              family = "Montserrat Medium",
                                                                                              color = lineas[k],
                                                                                              na.rm = TRUE) +
                                                                              geom_text_repel(aes(y = limite_censo, 
                                                                                                  label = ifelse(is.na(Etiqueta_Censo), "", format(Etiqueta_Censo, sep = " ", big.mark = " "))), 
                                                                                              size = 2, 
                                                                                              hjust = -1.5,
                                                                                              force = 1,
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_censo, ylim_max_censo),
                                                                                              nudge_y = nudge_y_censo,
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = "#BABABA",
                                                                                              family = "Montserrat Medium", 
                                                                                              color = "#000000",
                                                                                              na.rm = TRUE) +
                                                                               theme +
                                                                                guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                 scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                  scale_color_manual(values = colores[k]) +  
                                                                                   scale_fill_manual(values = lineas[k]) +  
                                                                                    scale_y_continuous(limits = c(min(tabla1$Inmigrantes_low, tabla1$Inmigrantes_Censo) - x_lim, max(tabla1$Inmigrantes_upp, tabla1$Inmigrantes_Censo) + x_lim),
                                                                                                       labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                     scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Inmigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Inmigrantes) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 8, dpi = 400, filename = path, device = "cairo_pdf")      
``` 

#### Emigrantes

```{r}
tabla <- Pob.Total %>%
          arrange(Emigrantes) %>%
           droplevels() %>%
            mutate(CV = .$Emigrantes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = Emigrantes, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = Emigrantes_low, ymax = Emigrantes_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = Emigrantes_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Emigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Emigrantes) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, NOM_MUN, MUN_Muestra, TAM_MUN, Emigrantes_Censo, Emigrantes, Emigrantes_se, Emigrantes_cv, Emigrantes_low, Emigrantes_upp) %>%
           arrange(Emigrantes) %>%
            droplevels() %>%
             mutate(CV = .$Emigrantes_cv * 100) %>% 
              mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                          .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                          .$CV >= 30 ~ "Baja")) %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja"))) 

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 
## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
Grados[1]
Zcal <- c(2.2, 2.3, 2.5)  #70% 70% 70%

for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 0, 300,
               ifelse(n == 104, 400,
                ifelse(n == 279, 8000,
                 ifelse(n == 572, 800,
                  ifelse(n == 678, 500,
                   ifelse(n == 829, 4000,
                           30))))))
     
     ## Direction 
     direction = ifelse(n < 0, "y", "y")
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n < 0, -0,
                        ifelse(n == 104, 0,
                         ifelse(n == 279, -5,
                          ifelse(n == 572, 0,
                           ifelse(n == 678, -5,
                            ifelse(n == 829, -2,
                                    0))))))
     
     nudge_y_censo = ifelse(n < 0, 0,
                      ifelse(n == 104, 0,
                       ifelse(n == 279, 0,
                        ifelse(n == 572, 0,
                         ifelse(n == 678, 0,
                          ifelse(n == 829, 5,
                                 0))))))
       
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 0, NA, NA)
     
     ylim_max_muestra =  ifelse(n < 0, NA, NA)
     
     ylim_min_censo = ifelse(n < 0, NA, NA)
     
     ylim_max_censo = ifelse(n < 0, NA, NA)
    
    tabla1 <- tabla %>%
               filter(MUN_Muestra %in% Muestra[i]) %>% 
                filter(CV_Grado %in% Grados[j]) %>%
                 mutate(Diff = abs(Emigrantes_Censo - Emigrantes),
                        limite = case_when(.$Emigrantes_Censo <= (.$Emigrantes - Zcal[j] * .$Emigrantes_se) ~ 1,
                                           .$Emigrantes_Censo >= (.$Emigrantes + Zcal[j] * .$Emigrantes_se) ~ 1, 
                                           TRUE ~ NA)) %>%
                  arrange(desc(Diff)) #%>%
                   #arrange(limite)
    
    casos <- tabla1 %>%
               top_n(n = 20) %>%
                pull(CVE_MUN)
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla1 %>%
                                                     arrange(Emigrantes) %>% 
                                                      mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$Emigrantes,
                                                                                          nrow(.) > 40 & .$limite %in% 1 & casos %in% .$CVE_MUN ~ .$Emigrantes),
                                                             Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$Emigrantes_Censo,
                                                                                        nrow(.) > 40 & .$limite %in% 1 & casos %in% .$CVE_MUN ~ .$Emigrantes_Censo), 
                                                             limite_muestra = case_when(.$Emigrantes_low >= .$Emigrantes_Censo ~ .$Emigrantes_Censo - .$Emigrantes_Censo/50,
                                                                                        .$Emigrantes_low < .$Emigrantes_Censo ~ .$Emigrantes_low - .$Emigrantes_low/50),
                                                             limite_censo = case_when(.$Emigrantes_upp < .$Emigrantes_Censo ~ .$Emigrantes_Censo + .$Emigrantes_Censo/50,
                                                                                      .$Emigrantes_upp >= .$Emigrantes_Censo ~ .$Emigrantes_upp + .$Emigrantes_upp/50)) %>%
                                                      ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                       geom_line(aes(y = Emigrantes, color = CV_Grado, size = "size1")) +
                                                        geom_ribbon(aes(ymin = Emigrantes_low, ymax = Emigrantes_upp, 
                                                                        color = CV_Grado, 
                                                                        fill = CV_Grado), 
                                                                    alpha = 0.2) + 
                                                         geom_line(aes(y = Emigrantes_Censo, size = "size2"), 
                                                                    color = "#A1A1A1", 
                                                                     linetype = 1) + 
                                                          geom_text_repel(aes(y = limite_muestra, 
                                                                              label = ifelse(is.na(Etiqueta_Muestra), "", format(Etiqueta_Muestra, sep = " ", big.mark = " "))), 
                                                                          #position = position_jitter(seed = 12),
                                                                          hjust = 1.5,
                                                                          force = 0.2,
                                                                          size = 2, 
                                                                          angle = 90,
                                                                          direction = direction,
                                                                          nudge_y = nudge_y_muestra,
                                                                          #ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                          min.segment.length = 0.01,
                                                                          segment.size = 0.02,
                                                                          segment.colour = lineas[j], 
                                                                          family = "Montserrat Medium",
                                                                          color = lineas[j]) +
                                                          geom_text_repel(aes(y = limite_censo, 
                                                                              label = ifelse(is.na(Etiqueta_Censo), "", format(Etiqueta_Censo, sep = " ", big.mark = " "))), 
                                                                          #position = position_jitter(seed = 12),
                                                                          size = 2, 
                                                                          hjust = -1.5,
                                                                          force = 1,
                                                                          angle = 90,
                                                                          direction = direction,
                                                                          min.segment.length = 0.1,
                                                                          nudge_y = nudge_y_censo,
                                                                          #ylim = c(ylim_min_censo, ylim_max_censo),
                                                                          segment.size = 0.02,
                                                                          segment.colour = lineas[j],
                                                                          family = "Montserrat Medium",
                                                                          color = "#A1A1A1") +
                                                           theme + 
                                                            guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                             scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                              scale_color_manual(values = colores[j]) +  
                                                               scale_fill_manual(values = lineas[j]) +  
                                                                scale_y_continuous(limits = c(min(tabla1$Emigrantes_low, tabla1$Emigrantes_Censo) - x_lim, max(tabla1$Emigrantes_upp, tabla1$Emigrantes_Censo) + x_lim),
                                                                                   labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                 scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                  labs(title = "Migración reciente",
                                                                       subtitle = paste("Emigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]), 
                                                                       y = "",
                                                                       x = paste(n, "municipios"), 
                                                                       size = "",
                                                                       color = "", 
                                                                       fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Emigrantes) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, Emigrantes, Emigrantes_Censo, Emigrantes_cv, Emigrantes_low, Emigrantes_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(Emigrantes) %>%
            mutate(CV = .$Emigrantes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))

mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2) {
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = Emigrantes, 
                                                                                        color = TAM_MUN),
                                                                                          size = 2) + 
                                                                          geom_ribbon(aes(ymin = Emigrantes_low, 
                                                                                          ymax = Emigrantes_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = Emigrantes_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") + 
                                                                            theme + 
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                               scale_color_manual(values = colores[k]) +  
                                                                                scale_fill_manual(values = lineas[k]) +  
                                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                # scale_x_discrete(limits = nom_estados) + 
                                                                                  labs(title = "Migración reciente",
                                                                                       subtitle = paste("Emigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                       y = "",
                                                                                       x = paste(n, "municipios"), 
                                                                                       size = "",
                                                                                       color = "", 
                                                                                       fill = "") 
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                           ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                            geom_line(aes(y = Emigrantes, 
                                                                                          color = TAM_MUN, 
                                                                                          size = "size1")) + 
                                                                             geom_ribbon(aes(ymin = Emigrantes_low, 
                                                                                             ymax = Emigrantes_upp, 
                                                                                             color = TAM_MUN,
                                                                                             fill = TAM_MUN), 
                                                                                         alpha = 0.2) + 
                                                                               geom_line(aes(y = Emigrantes_Censo, 
                                                                                             size = "size2"), 
                                                                                          color = "#A1A1A1", 
                                                                                           linetype = 1) + 
                                                                                theme + 
                                                                                 guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                   # scale_x_discrete(limits = nom_estados) + 
                                                                                     labs(title = "Migración reciente",
                                                                                          subtitle = paste("Emigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                          y = "",
                                                                                          x = paste(n, "municipios"), 
                                                                                          size = "",
                                                                                          color = "", 
                                                                                          fill = "") 
     }
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Emigrantes) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, Emigrantes, Emigrantes_Censo, Emigrantes_se, Emigrantes_cv, Emigrantes_low, Emigrantes_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(Emigrantes) %>%
            mutate(CV = .$Emigrantes_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#8F8F8F", size = 0.02),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
Zcal <- c(0.724, 1.3, 1.44)  #70% 70% 70% 
#Grados[2] #Moderada
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                filter(MUN_Muestra %in% Muestra[i]) %>% 
                 filter(CV_Grado %in% Grados[j]) %>% 
                  filter(TAM_MUN %in% TAM[k]) %>%
                   mutate(Diff = abs(Emigrantes_Censo - Emigrantes),
                          limite = case_when(.$Emigrantes_Censo <= (.$Emigrantes - Zcal[j] * .$Emigrantes_se) ~ 1,
                                             .$Emigrantes_Censo >= (.$Emigrantes + Zcal[j] * .$Emigrantes_se) ~ 1, 
                                             TRUE ~ NA)) %>%
                    arrange(limite, desc(Diff))
     
     casos <- tabla1 %>%
               slice(1:30) %>%
                pull(CVE_MUN)
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 10, 0, 
               ifelse(n == 141 | n == 200, 400, 
                      100))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n >= 40 & n < 100, -6, 
                        ifelse(n >= 100 & n < 200, -70,
                         ifelse (n >= 200 & n < 300, -90, 
                          ifelse(n >= 300, -90, 
                                  -5 #Other cases
                                  ))))
     
     nudge_y_censo = ifelse(n < 40, 0, 
                      ifelse(n >= 40 & n < 100, 8, 
                       ifelse(n >= 100, 15, 
                              5 #Other cases
                              )))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n > 0, NA, 
                         ifelse(n == 91, -1 * min(tabla1$Emigrantes_low, tabla1$Emigrantes_Censo) - 100,
                          ifelse(n == 119 | n == 145, -1 * min(tabla1$Emigrantes_low, tabla1$Emigrantes_Censo) - 50,
                                 NA
                                 )))
     
     ylim_max_muestra = ifelse(n > 0,  NA, NA)
     
     ylim_min_censo = ifelse(n > 0, NA,
                       ifelse(n == 91 | n == 145, min(tabla1$Emigrantes_upp, tabla1$Emigrantes_Censo) + 50,
                              NA
                             ))
     
     ylim_max_censo = ifelse(n > 0, NA,
                       ifelse(n == 91, max(tabla1$Emigrantes_upp, tabla1$Emigrantes_Censo) + 120,
                              NA
                              ))
      
     if(n %in% c(0, 1)){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = Emigrantes, 
                                                                                        color = TAM_MUN),
                                                                                     size = 2) + 
                                                                          geom_ribbon(aes(ymin = Emigrantes_low, 
                                                                                          ymax = Emigrantes_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = Emigrantes_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") +
                                                                            geom_text_repel(aes(y = Emigrantes, 
                                                                                                label = round(Emigrantes, 1)), 
                                                                                            hjust = 1.5,
                                                                                            force = 1,
                                                                                            size = 3, 
                                                                                            angle = 45,
                                                                                            direction = "y",
                                                                                            min.segment.length = 0.01,
                                                                                            segment.size = 0.02,
                                                                                            segment.colour = lineas[k], 
                                                                                            family = "Montserrat Medium",
                                                                                            color = lineas[k]) +
                                                                             geom_text_repel(aes(y = Emigrantes_Censo, 
                                                                                                label = round(Emigrantes_Censo, 1)), 
                                                                                             hjust = 1.5,
                                                                                             force = 1,
                                                                                             size = 3, 
                                                                                             angle = 45,
                                                                                             direction = "y",
                                                                                             min.segment.length = 0.01,
                                                                                             segment.size = 0.02,
                                                                                             segment.colour = "#BABABA",
                                                                                             family = "Montserrat Medium", 
                                                                                             color = "#000000") +
                                                                              theme +
                                                                               guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                 scale_color_manual(values = colores[k]) +  
                                                                                  scale_fill_manual(values = lineas[k]) +  
                                                                                   scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    labs(title = "Migración reciente",
                                                                                         subtitle = paste("Emigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                         y = "",
                                                                                         x = paste(n, "municipios"), 
                                                                                         size = "",
                                                                                         color = "", 
                                                                                         fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       arrange(Emigrantes) %>%
                                                                        mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$Emigrantes,
                                                                                                            nrow(.) > 40 &  .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$Emigrantes),
                                                                               Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$Emigrantes_Censo,
                                                                                                          nrow(.) > 40 & .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$Emigrantes_Censo), 
                                                                               limite_muestra = case_when(.$Emigrantes_low >= .$Emigrantes_Censo ~ .$Emigrantes_Censo - .$Emigrantes_Censo/50,
                                                                                                          .$Emigrantes_low < .$Emigrantes_Censo ~ .$Emigrantes_low - .$Emigrantes_low/50),
                                                                               limite_censo = case_when(.$Emigrantes_upp < .$Emigrantes_Censo ~ .$Emigrantes_Censo + .$Emigrantes_Censo/50,
                                                                                                        .$Emigrantes_upp >= .$Emigrantes_Censo ~ .$Emigrantes_upp + .$Emigrantes_upp/50)) %>% 
                                                                         ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                          geom_line(aes(y = Emigrantes, 
                                                                                        color = TAM_MUN, 
                                                                                        size = "size1")) + 
                                                                           geom_ribbon(aes(ymin = Emigrantes_low, 
                                                                                           ymax = Emigrantes_upp, 
                                                                                           color = TAM_MUN,
                                                                                           fill = TAM_MUN), 
                                                                                        alpha = 0.2) + 
                                                                             geom_line(aes(y = Emigrantes_Censo, 
                                                                                           size = "size2"), 
                                                                                           color = "#A1A1A1", 
                                                                                       linetype = 1) + 
                                                                              geom_text_repel(aes(y = limite_muestra, 
                                                                                                  label = ifelse(is.na(Etiqueta_Muestra), "", format(Etiqueta_Muestra, sep = " ", big.mark = " "))), 
                                                                                              hjust = 1.5,
                                                                                              force = 1,
                                                                                              size = 2, 
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              #nudge_y = nudge_y_muestra,
                                                                                              min.segment.length = 0.01,
                                                                                              #ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = lineas[k], 
                                                                                              family = "Montserrat Medium",
                                                                                              color = lineas[k],
                                                                                              na.rm = TRUE) +
                                                                              geom_text_repel(aes(y = limite_censo, 
                                                                                                  label = ifelse(is.na(Etiqueta_Censo), "", format(Etiqueta_Censo, sep = " ", big.mark = " "))), 
                                                                                              size = 2, 
                                                                                              hjust = -1.5,
                                                                                              force = 1,
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              min.segment.length = 0.01,
                                                                                              #ylim = c(ylim_min_censo, ylim_max_censo),
                                                                                              #nudge_y = nudge_y_censo,
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = "#BABABA",
                                                                                              family = "Montserrat Medium", 
                                                                                              color = "#000000",
                                                                                              na.rm = TRUE) +
                                                                               theme +
                                                                                guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                 scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                  scale_color_manual(values = colores[k]) +  
                                                                                   scale_fill_manual(values = lineas[k]) +  
                                                                                    scale_y_continuous(limits = c(min(tabla1$Emigrantes_low, tabla1$Emigrantes_Censo) - x_lim, max(tabla1$Emigrantes_upp, tabla1$Emigrantes_Censo) + x_lim),
                                                                                                       labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                     scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Emigrantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (Emigrantes) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 8, dpi = 400, filename = path, device = "cairo_pdf")      
``` 

#### Tasa de inmigración

```{r}
tabla <- Pob.Total %>%
          arrange(TInmigracion) %>%
           droplevels() %>%
            mutate(CV = .$TInmigracion_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja"))) %>%
               mutate(diff = abs(TInmigracion_Censo - TInmigracion)) 

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)


for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = TInmigracion, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = TInmigracion_low, ymax = TInmigracion_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = TInmigracion_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Tasa de inmigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TInmigracion) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, NOM_MUN, MUN_Muestra, TAM_MUN, TInmigracion_Censo, TInmigracion, TInmigracion_se, TInmigracion_cv, TInmigracion_low, TInmigracion_upp) %>%
           arrange(TInmigracion) %>%
            droplevels() %>%
             mutate(CV = .$TInmigracion_cv * 100) %>% 
              mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                          .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                          .$CV >= 30 ~ "Baja")) %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja"))) 

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)


#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 
## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
Zcal <- c(0.524, 1.9, 1.64)  #70% 70% 70%

for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 100, 130, 
               ifelse(n >= 100 & n < 250, 120,
                  ifelse(n >= 250  & n < 500, 130,
                   ifelse(n >= 500, 350, 
                          50 #Other cases
                          ))))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n < 100, -10, 
                        ifelse(n >= 200 & n < 250, -20,
                         ifelse(n >= 250  & n < 500, -25,
                          ifelse(n >= 500, -40, 
                                  50 #Other cases
                                  ))))
     
     nudge_y_censo = ifelse(n < 200, 15, 
                      ifelse(n >= 200 & n < 250, 25,
                       ifelse(n >= 250  & n < 500, 35,
                        ifelse(n >= 500, 80, 
                               50 #Other cases
                               ))))
       
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 30, 
                                NA,
                                 -1 *max(tabla1$TInmigracion_low, tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) - 10)
     ylim_max_muestra = ifelse(n < 30, 
                                NA,
                                 -1 * min(tabla1$TInmigracion_low, tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) - 10)
     
     ylim_min_censo = ifelse(n < 30, 
                              NA,
                               min(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + 40)
     ylim_max_censo = ifelse(n < 30, 
                              NA,
                               max(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + 40)
    
    tabla1 <- tabla %>%
               filter(MUN_Muestra %in% Muestra[i]) %>% 
                filter(CV_Grado %in% Grados[j]) %>%
                 mutate(Diff = abs(TInmigracion_Censo - TInmigracion),
                        limite = case_when(.$TInmigracion_Censo <= (.$TInmigracion - Zcal[j] * .$TInmigracion_se) ~ 1,
                                           .$TInmigracion_Censo >= (.$TInmigracion + Zcal[j] * .$TInmigracion_se) ~ 1, 
                                           TRUE ~ NA)) %>%
                  arrange(desc(Diff)) %>% 
                   mutate(n = 1:n()) %>%
                    arrange(TInmigracion) %>% 
                     mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$TInmigracion,
                                                         nrow(.) > 40 & .$limite %in% 1 & .$n < 40 ~ .$TInmigracion),
                            Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$TInmigracion_Censo,
                                                       nrow(.) > 40 & .$limite %in% 1 & .$n < 40 ~ .$TInmigracion_Censo), 
                            limite_muestra = case_when(.$TInmigracion_low >= .$TInmigracion_Censo ~ .$TInmigracion_Censo - .$TInmigracion_Censo/50,
                                                       .$TInmigracion_low < .$TInmigracion_Censo ~ .$TInmigracion_low - .$TInmigracion_low/50),
                            limite_censo = case_when(.$TInmigracion_upp < .$TInmigracion_Censo ~ .$TInmigracion_Censo + .$TInmigracion_Censo/50,
                                                     .$TInmigracion_upp >= .$TInmigracion_Censo ~ .$TInmigracion_upp + .$TInmigracion_upp/50)) 
  
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla1 %>%
                                                     ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                      geom_line(aes(y = TInmigracion, color = CV_Grado, size = "size1")) +
                                                       geom_ribbon(aes(ymin = TInmigracion_low, ymax = TInmigracion_upp, 
                                                                       color = CV_Grado, 
                                                                       fill = CV_Grado), alpha = 0.2) + 
                                                        geom_line(aes(y = TInmigracion_Censo, size = "size2"), 
                                                                   color = "#A1A1A1", 
                                                                    linetype = 1) + 
                                                         geom_text_repel(aes(y = limite_muestra, 
                                                                             label = round(Etiqueta_Muestra, 1)), 
                                                                         hjust = 1.5,
                                                                         force = 0.2,
                                                                         size = 2, 
                                                                         angle = 90,
                                                                         direction = "y",
                                                                         nudge_y = nudge_y_muestra,
                                                                          ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                         min.segment.length = 0.01,
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j], 
                                                                         family = "Montserrat Medium",
                                                                         color = lineas[j]) +
                                                         geom_text_repel(aes(y = limite_censo, 
                                                                             label = round(Etiqueta_Censo, 1)), 
                                                                         size = 2, 
                                                                         hjust = -1.5,
                                                                         force = 1,
                                                                         angle = 90,
                                                                         direction = "y",
                                                                         min.segment.length = 0.1,
                                                                         nudge_y = nudge_y_muestra,
                                                                          ylim = c(ylim_min_censo, ylim_max_censo),
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j],
                                                                         family = "Montserrat Medium",
                                                                         color = "#A1A1A1") +
                                                          theme + 
                                                           guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                            scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                             scale_color_manual(values = colores[j]) +  
                                                              scale_fill_manual(values = lineas[j]) +  
                                                               scale_y_continuous(limits = c(min(tabla1$TInmigracion_low, tabla1$TInmigracion_Censo) - x_lim, max(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + x_lim),
                                                                                  labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                 labs(title = "Migración reciente",
                                                                      subtitle = paste("Tasa de inmigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                      y = "",
                                                                      x = paste(n, "municipios"), 
                                                                      size = "",
                                                                      color = "", 
                                                                      fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TInmigracion) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, TInmigracion, TInmigracion_Censo, TInmigracion_cv, TInmigracion_low, TInmigracion_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(TInmigracion) %>%
            mutate(CV = .$TInmigracion_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  %>%
                mutate(diff = abs(TInmigracion_Censo - TInmigracion)) 

mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = TInmigracion, 
                                                                                        color = TAM_MUN),
                                                                                          size = 2) + 
                                                                          geom_ribbon(aes(ymin = TInmigracion_low, 
                                                                                          ymax = TInmigracion_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = TInmigracion_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") + 
                                                                            theme +
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                               scale_color_manual(values = colores[k]) +  
                                                                                scale_fill_manual(values = lineas[k]) +  
                                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                # scale_x_discrete(limits = nom_estados) + 
                                                                                  labs(title = "Migración reciente",
                                                                                       subtitle = paste("Tasa de inmigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                       y = "",
                                                                                       x = paste(n, "municipios"), 
                                                                                       size = "",
                                                                                       color = "", 
                                                                                       fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                           ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                            geom_line(aes(y = TInmigracion, 
                                                                                          color = TAM_MUN, 
                                                                                          size = "size1")) + 
                                                                             geom_ribbon(aes(ymin = TInmigracion_low, 
                                                                                             ymax = TInmigracion_upp, 
                                                                                             color = TAM_MUN,
                                                                                             fill = TAM_MUN), 
                                                                                          alpha = 0.2) + 
                                                                               geom_line(aes(y = TInmigracion_Censo, 
                                                                                             size = "size2"), 
                                                                                             color = "#A1A1A1", 
                                                                                             linetype = 1) + 
                                                                                theme +
                                                                                 guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    # scale_x_discrete(limits = nom_estados) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Tasa de inmigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TInmigracion) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**


```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, TInmigracion, TInmigracion_Censo, TInmigracion_se, TInmigracion_cv, TInmigracion_low, TInmigracion_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(TInmigracion) %>%
            mutate(CV = .$TInmigracion_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#8F8F8F", size = 0.02),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
Zcal <- c(0.724, 1.9, 1.64)  #70% 70% 70% 
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                filter(MUN_Muestra %in% Muestra[i]) %>% 
                 filter(CV_Grado %in% Grados[j]) %>% 
                  filter(TAM_MUN %in% TAM[k]) %>%
                   mutate(Diff = abs(TInmigracion_Censo - TInmigracion),
                          limite = case_when(.$TInmigracion_Censo <= (.$TInmigracion - Zcal[j] * .$TInmigracion_se) ~ 1,
                                             .$TInmigracion_Censo >= (.$TInmigracion + Zcal[j] * .$TInmigracion_se) ~ 1, 
                                             TRUE ~ NA)) %>%
                    arrange(limite, desc(Diff))
     
     casos <- tabla1 %>%
               slice(1:30) %>%
                pull(CVE_MUN)
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 0, 35, 
               ifelse(n >= 20 & n < 40, 60, 
                ifelse(n >= 40 & n < 100, 80, 
                 ifelse(n >= 100 & n < 200, 130, 
                  ifelse(n >= 200 & n < 250, 150,
                   ifelse(n >= 250  & n < 300, 180,
                    ifelse(n >= 300, 200, 
                           100 #Other cases
                            )))))))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n >= 40 & n < 100, -9, 
                        ifelse(n >= 100 & n < 200, -5,
                         ifelse (n >= 200 & n < 300, -20, 
                          ifelse(n >= 300, -25, 
                                  0 #Other cases
                                  ))))
     
     nudge_y_censo = ifelse(n < 40, 0, 
                      ifelse(n >= 40 & n < 100, 5, 
                       ifelse(n >= 100, 9, 
                              5 #Other cases
                              )))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 30, NA, 
                         ifelse(n >= 100 & n < 250 , -1 * mean(tabla1$TInmigracion_low) - 50,
                          ifelse(n >= 250 , -1 * mean(tabla1$TInmigracion_low) - 90,
                                 -1 * max(tabla1$TInmigracion_low, tabla1$TInmigracion_Censo)
                               )))
     ylim_max_muestra = ifelse(n < 30, 
                                NA,
                                -1 * min(tabla1$TInmigracion_low, tabla1$TInmigracion_Censo))
     
     ylim_min_censo = ifelse(n < 30, 
                             NA,
                              min(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + 20)
     ylim_max_censo = ifelse(n < 30, NA,
                       ifelse(n >= 100 & n < 200 , max(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + 100,
                        ifelse(n >= 250, max(tabla1$TInmigracion_upp) + 100,
                               max(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + 60
                               )))
      
     if(n %in% c(0, 1)){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = TInmigracion, 
                                                                                        color = TAM_MUN),
                                                                                     size = 2) + 
                                                                          geom_ribbon(aes(ymin = TInmigracion_low, 
                                                                                          ymax = TInmigracion_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = TInmigracion_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") +
                                                                            geom_text_repel(aes(y = TInmigracion, 
                                                                                                label = round(TInmigracion, 1)), 
                                                                                            hjust = 1.5,
                                                                                            force = 1,
                                                                                            size = 3, 
                                                                                            angle = 45,
                                                                                            direction = "y",
                                                                                            min.segment.length = 0.01,
                                                                                            segment.size = 0.02,
                                                                                            segment.colour = lineas[k], 
                                                                                            family = "Montserrat Medium",
                                                                                            color = lineas[k]) +
                                                                             geom_text_repel(aes(y = TInmigracion_Censo, 
                                                                                                label = round(TInmigracion_Censo, 1)), 
                                                                                             hjust = 1.5,
                                                                                             force = 1,
                                                                                             size = 3, 
                                                                                             angle = 45,
                                                                                             direction = "y",
                                                                                             min.segment.length = 0.01,
                                                                                             segment.size = 0.02,
                                                                                             segment.colour = "#BABABA",
                                                                                             family = "Montserrat Medium", 
                                                                                             color = "#000000") +
                                                                              theme +
                                                                               guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                 scale_color_manual(values = colores[k]) +  
                                                                                  scale_fill_manual(values = lineas[k]) +  
                                                                                   scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    labs(title = "Migración reciente",
                                                                                         subtitle = paste("Tasa de inmigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                         y = "",
                                                                                         x = paste(n, "municipios"), 
                                                                                         size = "",
                                                                                         color = "", 
                                                                                         fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       arrange(TInmigracion) %>%
                                                                        mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$TInmigracion,
                                                                                                            nrow(.) > 40 &  .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$TInmigracion),
                                                                               Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$TInmigracion_Censo,
                                                                                                          nrow(.) > 40 & .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$TInmigracion_Censo), 
                                                                               limite_muestra = case_when(.$TInmigracion_low >= .$TInmigracion_Censo ~ .$TInmigracion_Censo - .$TInmigracion_Censo/50,
                                                                                                          .$TInmigracion_low < .$TInmigracion_Censo ~ .$TInmigracion_low - .$TInmigracion_low/50),
                                                                               limite_censo = case_when(.$TInmigracion_upp < .$TInmigracion_Censo ~ .$TInmigracion_Censo + .$TInmigracion_Censo/50,
                                                                                                        .$TInmigracion_upp >= .$TInmigracion_Censo ~ .$TInmigracion_upp + .$TInmigracion_upp/50)) %>% 
                                                                         ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                          geom_line(aes(y = TInmigracion, 
                                                                                        color = TAM_MUN, 
                                                                                        size = "size1")) + 
                                                                           geom_ribbon(aes(ymin = TInmigracion_low, 
                                                                                           ymax = TInmigracion_upp, 
                                                                                           color = TAM_MUN,
                                                                                           fill = TAM_MUN), 
                                                                                        alpha = 0.2) + 
                                                                             geom_line(aes(y = TInmigracion_Censo, 
                                                                                           size = "size2"), 
                                                                                           color = "#A1A1A1", 
                                                                                       linetype = 1) + 
                                                                              geom_text_repel(aes(y = limite_muestra, 
                                                                                                  label = round(Etiqueta_Muestra, 1)), 
                                                                                              hjust = 1.5,
                                                                                              force = 1,
                                                                                              size = 2, 
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              nudge_y = nudge_y_muestra,
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = lineas[k], 
                                                                                              family = "Montserrat Medium",
                                                                                              color = lineas[k]) +
                                                                              geom_text_repel(aes(y = limite_censo, 
                                                                                                  label = round(Etiqueta_Censo, 1)), 
                                                                                              size = 2, 
                                                                                              hjust = -1.5,
                                                                                              force = 1,
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_censo, ylim_max_censo),
                                                                                              nudge_y = nudge_y_censo,
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = "#BABABA",
                                                                                              family = "Montserrat Medium", 
                                                                                              color = "#000000") +
                                                                               theme +
                                                                                guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                 scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                  scale_color_manual(values = colores[k]) +  
                                                                                   scale_fill_manual(values = lineas[k]) +  
                                                                                    scale_y_continuous(limits = c(min(tabla1$TInmigracion_low, tabla1$TInmigracion_Censo) - x_lim, max(tabla1$TInmigracion_upp, tabla1$TInmigracion_Censo) + x_lim),
                                                                                                       labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                     scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Tasa de inmigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TInmigracion) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 8, dpi = 400, filename = path, device = "cairo_pdf")      
```


#### Tasa de emigración

```{r}
tabla <- Pob.Total %>%
          arrange(TEmigracion) %>%
           droplevels() %>%
            mutate(CV = .$TEmigracion_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = TEmigracion, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = TEmigracion_low, ymax = TEmigracion_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = TEmigracion_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Tasa de emigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TEmigracion) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Etiquetas**

```{r}
require(ggrepel)
require(ggplot2)
tabla <- Pob.Total %>%
          select(CVE_MUN, NOM_MUN, MUN_Muestra, TAM_MUN, TEmigracion_Censo, TEmigracion, TEmigracion_se, TEmigracion_cv, TEmigracion_low, TEmigracion_upp) %>%
           arrange(TEmigracion) %>%
            droplevels() %>%
             mutate(CV = .$TEmigracion_cv * 100) %>% 
              mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                          .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                          .$CV >= 30 ~ "Baja")) %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja"))) 

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)


#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 
## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
Zcal <- c(0.524, 1.9, 1.64)  #70% 70% 70%
#Grados[1] #Baja
#Grados[2] #Alta
#Grados[3] #Moderada
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    tabla1 <- tabla %>%
               filter(MUN_Muestra %in% Muestra[i]) %>% 
                filter(CV_Grado %in% Grados[j]) %>%
                 mutate(Diff = abs(TEmigracion_Censo - TEmigracion),
                        limite = case_when(.$TEmigracion_Censo <= (.$TEmigracion - Zcal[j] * .$TEmigracion_se) ~ 1,
                                           .$TEmigracion_Censo >= (.$TEmigracion + Zcal[j] * .$TEmigracion_se) ~ 1, 
                                           TRUE ~ NA)) %>%
                  arrange(desc(Diff)) %>% 
                   mutate(n = 1:n()) %>%
                    arrange(TEmigracion) %>% 
                     mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$TEmigracion,
                                                         nrow(.) > 40 & .$limite %in% 1 & .$n < 40 ~ .$TEmigracion),
                            Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$TEmigracion_Censo,
                                                       nrow(.) > 40 & .$limite %in% 1 & .$n < 40 ~ .$TEmigracion_Censo), 
                            limite_muestra = case_when(.$TEmigracion_low >= .$TEmigracion_Censo ~ .$TEmigracion_Censo - .$TEmigracion_Censo/50,
                                                       .$TEmigracion_low < .$TEmigracion_Censo ~ .$TEmigracion_low - .$TEmigracion_low/50),
                            limite_censo = case_when(.$TEmigracion_upp < .$TEmigracion_Censo ~ .$TEmigracion_Censo + .$TEmigracion_Censo/50,
                                                     .$TEmigracion_upp >= .$TEmigracion_Censo ~ .$TEmigracion_upp + .$TEmigracion_upp/50)) 
  
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla1 %>%
                                                     ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                      geom_line(aes(y = TEmigracion, color = CV_Grado, size = "size1")) +
                                                       geom_ribbon(aes(ymin = TEmigracion_low, ymax = TEmigracion_upp, 
                                                                       color = CV_Grado, 
                                                                       fill = CV_Grado), alpha = 0.2) + 
                                                        geom_line(aes(y = TEmigracion_Censo, size = "size2"), 
                                                                   color = "#A1A1A1", 
                                                                    linetype = 1) + 
                                                         geom_text_repel(aes(y = limite_muestra, 
                                                                             label = round(Etiqueta_Muestra, 1)), 
                                                                         hjust = 1.5,
                                                                         force = 0.2,
                                                                         size = 2, 
                                                                         angle = 90,
                                                                         direction = "y",
                                                                         nudge_y = ifelse(n > 40, -9, -5),
                                                                         min.segment.length = 0.01,
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j], 
                                                                         family = "Montserrat Medium",
                                                                         color = lineas[j]) +
                                                         geom_text_repel(aes(y = limite_censo, 
                                                                             label = round(Etiqueta_Censo, 1)), 
                                                                         size = 2, 
                                                                         hjust = -1.5,
                                                                         force = 1,
                                                                         angle = 90,
                                                                         direction = "y",
                                                                         min.segment.length = 0.1,
                                                                         nudge_y = 9,
                                                                         segment.size = 0.02,
                                                                         segment.colour = lineas[j],
                                                                         family = "Montserrat Medium",
                                                                         color = "#A1A1A1") +
                                                          theme + 
                                                           guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                            scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                             scale_color_manual(values = colores[j]) +  
                                                              scale_fill_manual(values = lineas[j]) +  
                                                               scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                 labs(title = "Migración reciente",
                                                                      subtitle = paste("Tasa de emigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                      y = "",
                                                                      x = paste(n, "municipios"), 
                                                                      size = "",
                                                                      color = "", 
                                                                      fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TEmigracion) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, TEmigracion, TEmigracion_Censo, TEmigracion_cv, TEmigracion_low, TEmigracion_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(TEmigracion) %>%
            mutate(CV = .$TEmigracion_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  %>%
                mutate(diff = abs(TEmigracion_Censo - TEmigracion)) 

mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = TEmigracion, 
                                                                                        color = TAM_MUN),
                                                                                        size = 2) + 
                                                                          geom_ribbon(aes(ymin = TEmigracion_low, 
                                                                                          ymax = TEmigracion_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                      alpha = 0.7) + 
                                                                           geom_point(aes(y = TEmigracion_Censo), 
                                                                                      size = 2,
                                                                                      color = "#A1A1A1") + 
                                                                            theme +
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                               scale_color_manual(values = colores[k]) +  
                                                                                scale_fill_manual(values = lineas[k]) +  
                                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                  labs(title = "Migración reciente",
                                                                                       subtitle = paste("Tasa de emigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                       y = "",
                                                                                       x = paste(n, "municipios"), 
                                                                                       size = "",
                                                                                       color = "", 
                                                                                       fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                        geom_line(aes(y = TEmigracion, 
                                                                                      color = TAM_MUN, 
                                                                                      size = "size1")) + 
                                                                         geom_ribbon(aes(ymin = TEmigracion_low, 
                                                                                             ymax = TEmigracion_upp, 
                                                                                             color = TAM_MUN,
                                                                                             fill = TAM_MUN), 
                                                                                          alpha = 0.2) + 
                                                                               geom_line(aes(y = TEmigracion_Censo, 
                                                                                             size = "size2"), 
                                                                                             color = "#A1A1A1", 
                                                                                             linetype = 1) + 
                                                                                theme +
                                                                                 guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Tasa de emigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TEmigracion) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Etiquetas**


```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, TEmigracion, TEmigracion_Censo, TEmigracion_se, TEmigracion_cv, TEmigracion_low, TEmigracion_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(TEmigracion) %>%
            mutate(CV = .$TEmigracion_cv * 100) %>% 
             mutate(CV_Grado = case_when(.$CV >= 0 & .$CV < 15 ~ "Alta", #Grado de precisión"
                                         .$CV >= 15 & .$CV < 30 ~ "Moderada",
                                         .$CV >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))  

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#8F8F8F", size = 0.02),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
Zcal <- c(0.524, 1.9, 1.64)  #70% 70% 70% 
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                filter(MUN_Muestra %in% Muestra[i]) %>% 
                 filter(CV_Grado %in% Grados[j]) %>% 
                  filter(TAM_MUN %in% TAM[k]) %>%
                   mutate(Diff = abs(TEmigracion_Censo - TEmigracion),
                          limite = case_when(.$TEmigracion_Censo <= (.$TEmigracion - Zcal[j] * .$TEmigracion_se) ~ 1,
                                             .$TEmigracion_Censo >= (.$TEmigracion + Zcal[j] * .$TEmigracion_se) ~ 1, 
                                             TRUE ~ NA)) %>%
                    arrange(limite, desc(Diff))
     
     casos <- tabla1 %>%
               slice(1:30) %>%
                pull(CVE_MUN)
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 20, 5, 
               ifelse(n >= 20 & n < 60, 30, 
                ifelse(n >= 60 & n < 200, 80, 
                 ifelse(n >= 200 & n < 250, 120,
                  ifelse(n >= 250  & n < 300, 180,
                   ifelse(n >= 300, 200, 
                          50 #Other cases
                          ))))))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n >= 40 & n < 100, -9, 
                              ifelse(n >= 100 & n < 200, -7, 
                               ifelse (n >= 200 & n < 300, -20, 
                                 ifelse(n >= 300, -25, 
                                        0 #Other cases
                                        ))))
     
     nudge_y_censo = ifelse(n < 40, 0, 
                      ifelse(n >= 40 & n < 100, 5, 
                       ifelse(n >= 100, 9, 
                              5 #Other cases
                              )))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 30, 
                                NA,
                                 -1 *max(tabla1$TEmigracion_low, tabla1$TEmigracion_upp, tabla1$TEmigracion_Censo))
     ylim_max_muestra = ifelse(n < 30, 
                                NA,
                                 -1 * min(tabla1$TEmigracion_low, tabla1$TEmigracion_upp, tabla1$TEmigracion_Censo))
     
     ylim_min_censo = ifelse(n < 30, 
                              NA,
                               min(tabla1$TEmigracion_upp, tabla1$TEmigracion_Censo) + 20)
     ylim_max_censo = ifelse(n < 30, 
                              NA,
                               max(tabla1$TEmigracion_upp, tabla1$TEmigracion_Censo) + 40)
      
     if(n %in% c(0, 1)){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = TEmigracion, 
                                                                                        color = TAM_MUN),
                                                                                     size = 2) + 
                                                                          geom_ribbon(aes(ymin = TEmigracion_low, 
                                                                                          ymax = TEmigracion_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = TEmigracion_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") +
                                                                            geom_text_repel(aes(y = TEmigracion, 
                                                                                                label = round(TEmigracion, 1)), 
                                                                                            hjust = 1.5,
                                                                                            force = 1,
                                                                                            size = 3, 
                                                                                            angle = 45,
                                                                                            direction = "y",
                                                                                            min.segment.length = 0.01,
                                                                                            segment.size = 0.02,
                                                                                            segment.colour = lineas[k], 
                                                                                            family = "Montserrat Medium",
                                                                                            color = lineas[k]) +
                                                                             geom_text_repel(aes(y = TEmigracion_Censo, 
                                                                                                label = round(TEmigracion_Censo, 1)), 
                                                                                             hjust = 1.5,
                                                                                             force = 1,
                                                                                             size = 3, 
                                                                                             angle = 45,
                                                                                             direction = "y",
                                                                                             min.segment.length = 0.01,
                                                                                             segment.size = 0.02,
                                                                                             segment.colour = "#BABABA",
                                                                                             family = "Montserrat Medium", 
                                                                                             color = "#000000") +
                                                                              theme +
                                                                               guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                 scale_color_manual(values = colores[k]) +  
                                                                                  scale_fill_manual(values = lineas[k]) +  
                                                                                   scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    labs(title = "Migración reciente",
                                                                                         subtitle = paste("Tasa de emigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                         y = "",
                                                                                         x = paste(n, "municipios"), 
                                                                                         size = "",
                                                                                         color = "", 
                                                                                         fill = "")    
     } else {   
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       arrange(TEmigracion) %>%
                                                                        mutate(Etiqueta_Muestra = case_when(nrow(.) <= 30 ~ .$TEmigracion,
                                                                                                            nrow(.) > 30 &  .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$TEmigracion),
                                                                               Etiqueta_Censo = case_when(nrow(.) <= 30 ~ .$TEmigracion_Censo,
                                                                                                          nrow(.) > 30 & .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$TEmigracion_Censo), 
                                                                               limite_muestra = case_when(.$TEmigracion_low >= .$TEmigracion_Censo ~ .$TEmigracion_Censo - .$TEmigracion_Censo/50,
                                                                                                          .$TEmigracion_low < .$TEmigracion_Censo ~ .$TEmigracion_low - .$TEmigracion_low/50),
                                                                               limite_censo = case_when(.$TEmigracion_upp < .$TEmigracion_Censo ~ .$TEmigracion_Censo + .$TEmigracion_Censo/50,
                                                                                                        .$TEmigracion_upp >= .$TEmigracion_Censo ~ .$TEmigracion_upp + .$TEmigracion_upp/50)) %>% 
                                                                         ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                          geom_line(aes(y = TEmigracion, 
                                                                                        color = TAM_MUN, 
                                                                                        size = "size1")) + 
                                                                           geom_ribbon(aes(ymin = TEmigracion_low, 
                                                                                           ymax = TEmigracion_upp, 
                                                                                           color = TAM_MUN,
                                                                                           fill = TAM_MUN), 
                                                                                        alpha = 0.2) + 
                                                                             geom_line(aes(y = TEmigracion_Censo, 
                                                                                           size = "size2"), 
                                                                                           color = "#A1A1A1", 
                                                                                       linetype = 1) + 
                                                                              geom_text_repel(aes(y = limite_muestra, 
                                                                                                  label = round(Etiqueta_Muestra, 1)), 
                                                                                              hjust = 1.5,
                                                                                              force = 1,
                                                                                              size = 2, 
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              position = position_jitter(seed = 123),
                                                                                              #nudge_y = nudge_y_muestra,
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = lineas[k], 
                                                                                              family = "Montserrat Medium",
                                                                                              color = lineas[k]) +
                                                                              geom_text_repel(aes(y = limite_censo, 
                                                                                                  label = round(Etiqueta_Censo, 1)), 
                                                                                              size = 2, 
                                                                                              hjust = -1.5,
                                                                                              force = 1,
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              min.segment.length = 0.01,
                                                                                              position = position_jitter(seed = 123),
                                                                                              #nudge_y = nudge_y_censo,
                                                                                              ylim = c(ylim_min_censo, ylim_max_censo),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = "#BABABA",
                                                                                              family = "Montserrat Medium", 
                                                                                              color = "#000000") +
                                                                               theme +
                                                                                guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                 scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                  scale_color_manual(values = colores[k]) +  
                                                                                   scale_fill_manual(values = lineas[k]) +  
                                                                                    scale_y_continuous(limits = c(min(tabla1$TEmigracion_low, tabla1$TEmigracion_Censo) - x_lim, max(tabla1$TEmigracion_upp, tabla1$TEmigracion_Censo) + x_lim),
                                                                                                       labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                     scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Tasa de emigración por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
     } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TEmigracion) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 8, dpi = 400, filename = path, device = "cairo_pdf")      
```

#### Migración neta

```{r}
tabla <- Pob.Total %>%
          arrange(MN) %>%
           droplevels() %>%
            mutate(CV = .$MN_cv * 100) %>% 
             mutate(CV_Grado = case_when(abs(.$CV) >= 0 & abs(.$CV) < 15 ~ "Alta", #Grado de precisión"
                                         abs(.$CV) >= 15 & abs(.$CV) < 30 ~ "Moderada",
                                         abs(.$CV) >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = MN, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = MN_low, ymax = MN_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = MN_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                  plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                  plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                  axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                  axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                  axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                  axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                  legend.text = element_text(family = "Montserrat Medium"),
                                                                  legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Migración Neta (Inmigrantes - Emigrantes)", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (MN) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")    
```

**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, MN, MN_Censo, MN_cv, MN_low, MN_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(MN) %>%
            mutate(CV = .$MN_cv * 100) %>% 
             mutate(CV_Grado = case_when(abs(.$CV) >= 0 & abs(.$CV) < 15 ~ "Alta", #Grado de precisión"
                                         abs(.$CV) >= 15 & abs(.$CV) < 30 ~ "Moderada",
                                         abs(.$CV) >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))

mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = MN, 
                                                                                        color = TAM_MUN),
                                                                                          size = 2) + 
                                                                          geom_ribbon(aes(ymin = MN_low, 
                                                                                          ymax = MN_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = MN_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") + 
                                                                            theme +
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                   # scale_x_discrete(limits = nom_estados) + 
                                                                                     labs(title = "Migración reciente",
                                                                                          subtitle = paste("Migración Neta (Inmigrantes - Emigrantes)", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                          y = "",
                                                                                          x = paste(n, "municipios"), 
                                                                                          size = "",
                                                                                          color = "", 
                                                                                          fill = "")    
     } else {    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                           ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                            geom_line(aes(y = MN, 
                                                                                          color = TAM_MUN, 
                                                                                          size = "size1")) + 
                                                                             geom_ribbon(aes(ymin = MN_low, 
                                                                                             ymax = MN_upp, 
                                                                                             color = TAM_MUN,
                                                                                             fill = TAM_MUN), 
                                                                                         alpha = 0.2) + 
                                                                               geom_line(aes(y = MN_Censo, 
                                                                                             size = "size2"), 
                                                                                          color = "#A1A1A1", 
                                                                                           linetype = 1) + 
                                                                                theme +
                                                                                 guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                  scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                   scale_color_manual(values = colores[k]) +  
                                                                                    scale_fill_manual(values = lineas[k]) +  
                                                                                     scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                   # scale_x_discrete(limits = nom_estados) + 
                                                                                     labs(title = "Migración reciente",
                                                                                          subtitle = paste("Migración Neta (Inmigrantes - Emigrantes)", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                          y = "",
                                                                                          x = paste(n, "municipios"), 
                                                                                          size = "",
                                                                                          color = "", 
                                                                                          fill = "") 
     }
   }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (MN) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```




#### Tasa Neta de Migración (`TNM`)

```{r}
tabla <- Pob.Total %>%
          arrange(TNM) %>%
           droplevels() %>%
            mutate(CV = .$TNM_cv * 100) %>% 
             mutate(CV_Grado = case_when(abs(.$CV) >= 0 & abs(.$CV) < 15 ~ "Alta", #Grado de precisión"
                                         abs(.$CV) >= 15 & abs(.$CV) < 30 ~ "Moderada",
                                         abs(.$CV) >= 30 ~ "Baja")) %>%
              mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)
nom_mun <- tabla %>% pull(NOM_MUN)

## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla %>%
                                                     filter(MUN_Muestra %in% Muestra[i]) %>% 
                                                      filter(CV_Grado %in% Grados[j]) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = TNM, color = CV_Grado, size = "size1")) +
                                                         geom_ribbon(aes(ymin = TNM_low, ymax = TNM_upp, 
                                                                         color = CV_Grado, 
                                                                         fill = CV_Grado), alpha = 0.2) + 
                                                          geom_line(aes(y = TNM_Censo, size = "size2"), color = "#A1A1A1", linetype = 1) + 
                                                           theme_minimal() + 
                                                             theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"), 
                                                                   plot.title = element_text(family = "Montserrat Medium", size = 20), 
                                                                   plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                                                                   axis.text = element_text(family = "Montserrat Medium", size = 10), 
                                                                   axis.title = element_text(family = "Montserrat Medium", size = 12),
                                                                   axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                                                                   axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                                                                   legend.text = element_text(family = "Montserrat Medium"),
                                                                   legend.title = element_text(family = "Montserrat Medium")) + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                             # scale_x_discrete(limits = nom_estados) + 
                                                             labs(title = "Migración reciente",
                                                                  subtitle = paste("Tasa Neta de Migración `TNM` por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                  y = "",
                                                                  x = paste(n, "municipios"), 
                                                                  size = "",
                                                                  color = "", 
                                                                  fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TNM) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Etiquetas**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, NOM_MUN, MUN_Muestra, TAM_MUN, TNM_Censo, TNM, TNM_se, TNM_cv, TNM_low, TNM_upp) %>%
           arrange(TNM) %>%
            droplevels() %>%
             mutate(CV = .$TNM_cv * 100) %>% 
              mutate(CV_Grado = case_when(abs(.$CV) >= 0 & abs(.$CV) < 15 ~ "Alta", #Grado de precisión"
                                          abs(.$CV) >= 15 & abs(.$CV) < 30 ~ "Moderada",
                                          abs(.$CV) >= 30 ~ "Baja")) %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")))

mun <- tabla %>% pull(CVE_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 
## Colores
colores <- c("#B41653", "#1665B4", "#16B49D")
lineas <- c("#810937", "#0A3C6E", "#258B7C")
               
p <- list()
Muestra <- unique(tabla$MUN_Muestra)
Grados <- unique(tabla$CV_Grado)
Zcal <- c(0.524, 1.9, 1.64)  #70% 70% 70%

for(i in 1:2){
  for(j in 1:3) {
    n <- tabla %>%
          filter(MUN_Muestra %in% Muestra[i]) %>% 
           filter(CV_Grado %in% Grados[j]) %>%
            count()
    tabla1 <- tabla %>%
               filter(MUN_Muestra %in% Muestra[i]) %>% 
                filter(CV_Grado %in% Grados[j]) %>%
                 mutate(Diff = abs(TNM_Censo - TNM),
                        limite = case_when(.$TNM_Censo <= (.$TNM - Zcal[j] * .$TNM_se) ~ 1,
                                           .$TNM_Censo >= (.$TNM + Zcal[j] * .$TNM_se) ~ 1, 
                                           TRUE ~ NA)) %>%
                   arrange(limite, desc(Diff))
    
     casos <- tabla1 %>%
               slice(1:30) %>%
                pull(CVE_MUN)
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
      ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 150, 80, 
               ifelse(n >= 150 & n < 300, 100, 
                ifelse(n >= 300 & n < 500, 150, 
                 ifelse(n >= 500, 150, 
                       0 #Other cases
                          ))))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n < 40, 0, 
                        ifelse(n >= 40 & n < 100, -30, 
                         ifelse(n >= 100 & n < 200, -50, 
                          ifelse(n >= 200 & n < 400, -80, 
                           ifelse(n >= 400 & n < 500, -90, 
                            ifelse(n >= 500, -120,  
                                   0 #Other cases
                                   ))))))
     
     nudge_y_censo = ifelse(n < 40, 0, 
                      ifelse(n >= 40 & n < 100, 5, 
                       ifelse(n >= 100 & n < 200, 50, 
                        ifelse(n >= 200 & n < 400, 70, 
                         ifelse(n >= 400 & n < 500, 90, 
                          ifelse(n >= 500, 90,  
                                0 #Other cases
                                ))))))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 30, 
                                NA,
                                 max(tabla1$TNM_upp) - 100)
     ylim_max_muestra = ifelse(n < 30, 
                                NA,
                                 min(tabla1$TNM_upp) - 100)
     
     ylim_min_censo = ifelse(n < 30, 
                              NA,
                               min(tabla1$TNM_low) + 100)
     ylim_max_censo = ifelse(n < 30, 
                              NA,
                               max(tabla1$TNM_low) + 100)
  
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]] <- tabla1 %>%
                                                     arrange(TNM) %>%
                                                      mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$TNM,
                                                                                          nrow(.) > 40 &  .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$TNM),
                                                             Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$TNM_Censo,
                                                                                        nrow(.) > 40 & .$limite %in% 1 & .$CVE_MUN %in% casos ~ .$TNM_Censo), 
                                                             limite_muestra = case_when(.$TNM_upp >= .$TNM_Censo & .$TNM_Censo < 0 ~ .$TNM_Censo + .$TNM_Censo/50,
                                                                                        .$TNM_upp >= .$TNM_Censo & .$TNM_Censo >= 0 ~ .$TNM_Censo - .$TNM_Censo/50,
                                                                                        .$TNM_upp < .$TNM_Censo & .$TNM_upp < 0 ~ .$TNM_upp + .$TNM_upp/50,
                                                                                        .$TNM_upp < .$TNM_Censo & .$TNM_upp >= 0 ~ .$TNM_upp - .$TNM_upp/50,),
                                                             limite_censo = case_when(.$TNM_low < .$TNM_Censo & .$TNM_Censo < 0 ~ .$TNM_Censo - .$TNM_Censo/50,
                                                                                      .$TNM_low < .$TNM_Censo & .$TNM_Censo >= 0 ~ .$TNM_Censo + .$TNM_Censo/50,
                                                                                      .$TNM_low >= .$TNM_Censo & .$TNM_low < 0 ~ .$TNM_low - .$TNM_low/50,
                                                                                      .$TNM_low >= .$TNM_Censo & .$TNM_low >= 0 ~ .$TNM_low + .$TNM_low/50)) %>% 
                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                        geom_line(aes(y = TNM, 
                                                                      color = CV_Grado, 
                                                                      size = "size1")) + 
                                                         geom_ribbon(aes(ymin = TNM_low, 
                                                                         ymax = TNM_upp, 
                                                                         color = CV_Grado,
                                                                         fill = CV_Grado), 
                                                                      alpha = 0.2,
                                                                      size = 0.4) + 
                                                          geom_line(aes(y = TNM_Censo, 
                                                                        size = "size2"), 
                                                                    color = "#A1A1A1", 
                                                                    linetype = 1) + 
                                                           geom_text_repel(aes(y = limite_muestra, 
                                                                               label = round(Etiqueta_Muestra, 1)), 
                                                                           hjust = 1.5,
                                                                           force = 1,
                                                                           size = 2, 
                                                                           angle = 90,
                                                                           direction = "y",
                                                                           min.segment.length = 0.01,
                                                                           nudge_y = nudge_y_muestra,
                                                                           ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                           segment.size = 0.02,
                                                                           segment.colour = lineas[j], 
                                                                           family = "Montserrat Medium",
                                                                           color = lineas[j]) +
                                                           geom_text_repel(aes(y = limite_censo, 
                                                                               label = round(Etiqueta_Censo, 1)), 
                                                                           size = 2, 
                                                                           hjust = -1.5,
                                                                           force = 1,
                                                                           angle = 90,
                                                                           direction = "y",
                                                                           min.segment.length = 0.1,
                                                                           nudge_y = nudge_y_censo,
                                                                           ylim = c(ylim_min_censo, ylim_max_censo),
                                                                           segment.size = 0.02,
                                                                           segment.colour = lineas[j],
                                                                           family = "Montserrat Medium",
                                                                           color = "#A1A1A1") +
                                                            theme + 
                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[j], "#A1A1A1")))) +
                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(0.5, 0.3)) +
                                                               scale_color_manual(values = colores[j]) +  
                                                                scale_fill_manual(values = lineas[j]) +  
                                                                 scale_y_continuous(limits = c(min(tabla1$TNM_upp, tabla1$TNM_low, tabla1$TNM_Censo) - x_lim, max(tabla1$TNM_low, tabla1$TNM_Censo) + x_lim),
                                                                                    labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                  scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                   labs(title = "Migración reciente",
                                                                        subtitle = paste("Tasa Neta de Migración `TNM` por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j]),
                                                                        y = "",
                                                                        x = paste(n, "municipios"), 
                                                                        size = "",
                                                                        color = "", 
                                                                        fill = "") 
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TNM) a nivel municipal.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```

**Municipios muestreados o censados | Tamaño de municipio | Precisión de la muestra**

```{r}
tabla <- Pob.Total %>%
          select(CVE_MUN, TNM, TNM_Censo, TNM_cv, TNM_low, TNM_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(TNM, TNM_Censo) %>%
            mutate(CV = .$TNM_cv * 100) %>% 
             mutate(CV_Grado = case_when(abs(.$CV) >= 0 & abs(.$CV) < 15 ~ "Alta", #Grado de precisión"
                                         abs(.$CV) >= 15 & abs(.$CV) < 30 ~ "Moderada",
                                         abs(.$CV) >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))

mun <- tabla %>% pull(CVE_MUN)
#nom_mun <- tabla %>% pull(NOM_MUN)

#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                 filter(MUN_Muestra %in% Muestra[i]) %>% 
                  filter(CV_Grado %in% Grados[j]) %>% 
                   filter(TAM_MUN %in% TAM[k])  
      
      mun <- tabla1 %>% pull(CVE_MUN)
      
     if(n == 1){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = TNM, 
                                                                                        color = TAM_MUN),
                                                                                          size = 2) + 
                                                                          geom_ribbon(aes(ymin = TNM_low, 
                                                                                          ymax = TNM_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = TNM_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") + 
                                                                            theme +
                                                                             guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                              scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                               scale_color_manual(values = colores[k]) +  
                                                                                scale_fill_manual(values = lineas[k]) +  
                                                                                 scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                # scale_x_discrete(limits = nom_estados) + 
                                                                                  labs(title = "Migración reciente",
                                                                                       subtitle = paste("Tasa Neta de Migración `TNM` por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                       y = "",
                                                                                       x = paste(n, "municipios"), 
                                                                                       size = "",
                                                                                       color = "", 
                                                                                       fill = "")   
     } else {
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                        geom_line(aes(y = TNM, 
                                                                                      color = TAM_MUN, 
                                                                                   size = "size1")) + 
                                                                         geom_ribbon(aes(ymin = TNM_low, 
                                                                                         ymax = TNM_upp, 
                                                                                         color = TAM_MUN,
                                                                                         fill = TAM_MUN), 
                                                                                      alpha = 0.2) + 
                                                                          geom_line(aes(y = TNM_Censo, 
                                                                                        size = "size2"), 
                                                                                     color = "#A1A1A1", 
                                                                                      linetype = 1) + 
                                                                           theme +
                                                                            guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                             scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                              scale_color_manual(values = colores[k]) +  
                                                                               scale_fill_manual(values = lineas[k]) +  
                                                                                scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                               # scale_x_discrete(limits = nom_estados) + 
                                                                                  labs(title = "Migración reciente",
                                                                                       subtitle = paste("Tasa Neta de Migración `TNM` por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                       y = "",
                                                                                       x = paste(n, "municipios"), 
                                                                                       size = "",
                                                                                       color = "", 
                                                                                       fill = "") 
      }
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TNM) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 7, dpi = 400, filename = path, device = "cairo_pdf")      
```


**Etiquetas**


```{r}
tabla <-  Pob.Total %>%
          select(CVE_MUN, TNM, TNM_Censo, TNM_cv, TNM_low, TNM_upp, MUN_Muestra, TAM_MUN) %>%
           arrange(TNM, TNM_Censo) %>%
            mutate(CV = .$TNM_cv * 100) %>% 
             mutate(CV_Grado = case_when(abs(.$CV) >= 0 & abs(.$CV) < 15 ~ "Alta", #Grado de precisión"
                                         abs(.$CV) >= 15 & abs(.$CV) < 30 ~ "Moderada",
                                         abs(.$CV) >= 30 ~ "Baja")) %>%
              droplevels() %>%
               mutate(CV_Grado = forcats::fct_relevel(.$CV_Grado, c("Alta", "Moderada", "Baja")),
                      TAM_MUN = forcats::fct_relevel(.$TAM_MUN, c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")))

mun <- tabla %>% pull(CVE_MUN)

#Theme
#Theme
theme <- theme_minimal() + 
          theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "inches"),
                panel.grid.major = element_line(color = "#A1A1A1", size = 0.05),
                panel.grid.minor = element_line(size = 0.003, linetype = 2),
                plot.title = element_text(family = "Montserrat Medium", size = 20), 
                plot.subtitle = element_text(family = "Montserrat Medium", size = 12, color = "#8D8D8D"), 
                axis.text = element_text(family = "Montserrat Medium", size = 10), 
                axis.title = element_text(family = "Montserrat Medium", size = 12),
                axis.title.x =   element_text(family = "Montserrat Medium", size = 8, hjust = 1),
                axis.text.x = element_text(family = "Montserrat Medium", size = 8, angle = 90, hjust = 1), 
                legend.text = element_text(family = "Montserrat Medium"),
                legend.title = element_text(family = "Montserrat Medium")) 

## Colores
colores <- c("#C70E7B", "#E7467F","#E58560", "#D49E46", "#B0D00F", "#25B99F",  "#5D6093")
lineas <- c("#B41676", "#CD2C65","#C36D4B", "#C18D37" ,"#98B311", "#188F7A",  "#393C77")
               
p <- list()
Muestra <- c("Municipio censado", "Municipio muestreado")
Grados <- c("Alta", "Moderada", "Baja")
Zcal <- c(1.6, 1.9, 1.64)  #70% 70% 70% 
TAM <- c("1-2 499 habitantes", "2 500-4 999 habitantes", "5 000-9 999 habitantes", " 10 000-14 999 habitantes", "15 000 a 49 999 habitantes", "50 000-99 999 habitantes", "100 000 y más habitantes")

for(i in 1:2){
  for(j in 1:3) {
   for(k in 1:7) {
     n <- tabla %>%
           filter(MUN_Muestra %in% Muestra[i]) %>% 
            filter(CV_Grado %in% Grados[j]) %>% 
             filter(TAM_MUN %in%  TAM[k]) %>%
              count() 
     tabla1 <- tabla %>%
                filter(MUN_Muestra %in% Muestra[i]) %>% 
                 filter(CV_Grado %in% Grados[j]) %>% 
                  filter(TAM_MUN %in% TAM[k]) %>%
                   mutate(Diff = abs(TNM_Censo - TNM)) %>%
                    arrange(desc(Diff))
     
     mun <- tabla1 %>% pull(CVE_MUN)
     
     ## Límite de la escala en scale_x_continuous()
     x_lim <- ifelse(n < 20, 40, 
               ifelse(n >= 20 & n < 40, 80, 
                ifelse(n >= 40 & n < 200, 120, 
                 ifelse(n >= 200 & n < 250, 150,
                  ifelse(n >= 250  & n < 300, 180,
                   ifelse(n >= 300, 210, 
                          80 #Other cases
                          ))))))
     
     # Ajuste en nudge_y
     nudge_y_muestra = ifelse(n < 20, -5,
                        ifelse(n >= 20 & n < 40, -10,  
                         ifelse(n >= 40 & n < 100, -20, 
                          ifelse(n >= 100 & n < 200, -30, 
                           ifelse (n >= 200 & n < 300, -40, 
                            ifelse(n >= 300, -55, 
                                   0 #Other cases
                                   ))))))
     
     nudge_y_censo = ifelse(n < 30, 2, 
                      ifelse(n >= 30 & n < 60, 4, 
                       ifelse(n >= 60 & n < 100, 40,
                        ifelse(n >= 100 & n < 200, 50, 
                         ifelse(n >= 200 & n < 300, 60, 
                          ifelse(n >= 300 & n < 700, 90, 
                           ifelse(n >= 700, 90,  
                                 0 #Other cases
                                 )))))))
     
     ## Ajuste ylim dentro de geom_text_repel()
     ylim_min_muestra = ifelse(n < 30, 
                                NA,
                                 max(tabla1$TNM_upp) - 100)
     ylim_max_muestra = ifelse(n < 30, 
                                NA,
                                 min(tabla1$TNM_upp) - 100)
     
     ylim_min_censo = ifelse(n < 30, 
                              NA,
                               min(tabla1$TNM_low) + 100)
     ylim_max_censo = ifelse(n < 30, 
                              NA,
                               max(tabla1$TNM_low, mean(tabla1$TNM_low)) + 100)
      
     if(n %in% c(0, 1)){
     p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                        ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                         geom_point(aes(y = TNM, 
                                                                                        color = TAM_MUN),
                                                                                     size = 2) + 
                                                                          geom_ribbon(aes(ymin = TNM_low, 
                                                                                          ymax = TNM_upp, 
                                                                                          color = TAM_MUN,
                                                                                          fill = TAM_MUN), 
                                                                                       alpha = 0.7) + 
                                                                           geom_point(aes(y = TNM_Censo), 
                                                                                       size = 2,
                                                                                        color = "#A1A1A1") +
                                                                            geom_text_repel(aes(y = TNM, 
                                                                                                label = round(TNM, 1)), 
                                                                                            hjust = 1.5,
                                                                                            force = 1,
                                                                                            size = 3, 
                                                                                            angle = 45,
                                                                                            direction = "y",
                                                                                            min.segment.length = 0.01,
                                                                                            segment.size = 0.02,
                                                                                            segment.colour = lineas[k], 
                                                                                            family = "Montserrat Medium",
                                                                                            color = lineas[k]) +
                                                                             geom_text_repel(aes(y = TNM_Censo, 
                                                                                                label = round(TNM_Censo, 1)), 
                                                                                             hjust = -1.5,
                                                                                             force = 1,
                                                                                             size = 3, 
                                                                                             angle = 45,
                                                                                             direction = "y",
                                                                                             min.segment.length = 0.01,
                                                                                             segment.size = 0.02,
                                                                                             segment.colour = "#BABABA",
                                                                                             family = "Montserrat Medium", 
                                                                                             color = "#000000") +
                                                                              theme +
                                                                               guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                 scale_color_manual(values = colores[k]) +  
                                                                                  scale_fill_manual(values = lineas[k]) +  
                                                                                   scale_y_continuous(labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                    labs(title = "Migración reciente",
                                                                                         subtitle = paste("Tasa Neta de Migración `TNM` por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                         y = "",
                                                                                         x = paste(n, "municipios"), 
                                                                                         size = "",
                                                                                         color = "", 
                                                                                         fill = "")    
     } else {   
       
      casos <- tabla1 %>%
                 top_n(n = 20) %>%
                  pull(CVE_MUN)
    
    p[[paste0(Muestra[i])]][[paste0(Grados[j])]][[paste0(TAM[k])]] <- tabla1 %>%
                                                                       arrange(TNM) %>%
                                                                        mutate(Etiqueta_Muestra = case_when(nrow(.) <= 40 ~ .$TNM,
                                                                                          nrow(.) > 40 & .$CVE_MUN %in% casos ~ .$TNM),
                                                                               Etiqueta_Censo = case_when(nrow(.) <= 40 ~ .$TNM_Censo,
                                                                                                          nrow(.) > 40 & .$CVE_MUN %in% casos ~ .$TNM_Censo), 
                                                                               limite_muestra = case_when(.$TNM_upp >= .$TNM_Censo & .$TNM_Censo < 0 ~ .$TNM_Censo + .$TNM_Censo/50,
                                                                                                          .$TNM_upp >= .$TNM_Censo & .$TNM_Censo >= 0 ~ .$TNM_Censo - .$TNM_Censo/50,
                                                                                                          .$TNM_upp < .$TNM_Censo & .$TNM_upp < 0 ~ .$TNM_upp + .$TNM_upp/50,
                                                                                                          .$TNM_upp < .$TNM_Censo & .$TNM_upp >= 0 ~ .$TNM_upp - .$TNM_upp/50,),
                                                                               limite_censo = case_when(.$TNM_low < .$TNM_Censo & .$TNM_Censo < 0 ~ .$TNM_Censo - .$TNM_Censo/50,
                                                                                                        .$TNM_low < .$TNM_Censo & .$TNM_Censo >= 0 ~ .$TNM_Censo + .$TNM_Censo/50,
                                                                                                        .$TNM_low >= .$TNM_Censo & .$TNM_low < 0 ~ .$TNM_low - .$TNM_low/50,
                                                                                                        .$TNM_low >= .$TNM_Censo & .$TNM_low >= 0 ~ .$TNM_low + .$TNM_low/50)) %>% 
                                                                         ggplot(aes(x = order(factor(CVE_MUN, levels = mun)))) + 
                                                                          geom_line(aes(y = TNM, 
                                                                                        color = TAM_MUN, 
                                                                                        size = "size1")) + 
                                                                           geom_ribbon(aes(ymin = TNM_low, 
                                                                                           ymax = TNM_upp, 
                                                                                           color = TAM_MUN,
                                                                                           fill = TAM_MUN), 
                                                                                        alpha = 0.2) + 
                                                                             geom_line(aes(y = TNM_Censo, 
                                                                                           size = "size2"), 
                                                                                           color = "#A1A1A1", 
                                                                                       linetype = 1) + 
                                                                              geom_text_repel(aes(y = limite_muestra, 
                                                                                                  label = round(Etiqueta_Muestra, 1)), 
                                                                                              hjust = 1.5,
                                                                                              force = 1,
                                                                                              size = 2, 
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              nudge_y = nudge_y_muestra,
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_muestra, ylim_max_muestra),
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = lineas[k], 
                                                                                              family = "Montserrat Medium",
                                                                                              color = lineas[k]) +
                                                                              geom_text_repel(aes(y = limite_censo, 
                                                                                                  label = round(Etiqueta_Censo, 1)), 
                                                                                              size = 2, 
                                                                                              hjust = -1.5,
                                                                                              force = 1,
                                                                                              angle = 90,
                                                                                              direction = "y",
                                                                                              min.segment.length = 0.01,
                                                                                              ylim = c(ylim_min_censo, ylim_max_censo),
                                                                                              nudge_y = nudge_y_censo,
                                                                                              segment.size = 0.02,
                                                                                              segment.colour = "#BABABA",
                                                                                              family = "Montserrat Medium", 
                                                                                              color = "#000000") +
                                                                               theme +
                                                                                guides(size = guide_legend(override.aes = list(size = c(0.5, 0.5), color = c(lineas[k], "#A1A1A1")))) +
                                                                                 scale_size_manual(labels = c("Muestra", "Censo"), values = c(1, 0.5)) +
                                                                                  scale_color_manual(values = colores[k]) +  
                                                                                   scale_fill_manual(values = lineas[k]) +  
                                                                                    scale_y_continuous(limits = c(min(tabla1$TNM_upp, tabla1$TNM_low, tabla1$TNM_Censo) - x_lim, max(tabla1$TNM_low, tabla1$TNM_Censo) + x_lim),
                                                                                                       labels = scales::unit_format(unit = "", scale = 1, sep = " ", big.mark = " ")) + 
                                                                                     scale_x_continuous(breaks = seq(1, nrow(tabla1), by = ceiling(nrow(tabla1)/10))) + 
                                                                                      labs(title = "Migración reciente",
                                                                                           subtitle = paste("Tasa Neta de Migración `TNM` por cada mil habitantes", "\n", Muestra[i], "\n", "Precisión", Grados[j], "\n", TAM[k]),
                                                                                           y = "",
                                                                                           x = paste(n, "municipios"), 
                                                                                           size = "",
                                                                                           color = "", 
                                                                                           fill = "") 
      } 
    }
  }
}

p
path = paste0(here::here(), "/Graficos/MR5a (TNM) a nivel municipal_Tamaño de municipio.pdf") 
ggexport(list = p, width = 12, height = 8, dpi = 400, filename = path, device = "cairo_pdf")      
```



